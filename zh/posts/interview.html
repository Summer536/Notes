<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.22" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.86" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Interview","image":[""],"datePublished":"2025-08-16T00:00:00.000Z","dateModified":"2025-09-12T09:54:49.000Z","author":[{"@type":"Person","name":"GYQ","url":"https://github.com/Summer536"}]}</script><meta property="og:url" content="https://your-domain.com/Notes/zh/posts/interview.html"><meta property="og:site_name" content="GYQçš„åšå®¢"><meta property="og:title" content="Interview"><meta property="og:description" content="Interview ä¸€. C++ C++æ˜¯åŸºç¡€ï¼Œä¼šåœ¨é¢è¯•æ ¡æ‹›ç”Ÿå’Œç¤¾æ‹›ä¸¤å¹´å†…æ—¶è€ƒå¯Ÿã€‚ 1. å †å’Œæ ˆçš„åŒºåˆ«ï¼Ÿ ç®¡ç†æ–¹å¼ï¼šæ ˆç”±ç¼–è¯‘å™¨ç®¡ç†ï¼Œå †ç”±ç¨‹åºå‘˜æ‰‹åŠ¨ç®¡ç†ï¼› ç¢ç‰‡é—®é¢˜ï¼šæ ˆä¸å­˜åœ¨ç¢ç‰‡é—®é¢˜ï¼Œå †å¾ˆå®¹æ˜“äº§ç”Ÿç¢ç‰‡ï¼› åˆ†é…æ–¹å¼ï¼šæ ˆæ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…çš„ï¼Œå †æ˜¯(new,delete/malloc,free)åˆ†é…ã€‚ åˆ†é…æ•ˆç‡ï¼šæ ˆçš„æ•ˆç‡æ¯”å †é«˜ï¼› 2. ä»¥ä¸‹å››è¡Œä»£ç ä¼šè°ƒç”¨åˆ°ä»€ä¹ˆå‡½..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-09-12T09:54:49.000Z"><meta property="article:tag" content="GPUä¼˜åŒ–"><meta property="article:published_time" content="2025-08-16T00:00:00.000Z"><meta property="article:modified_time" content="2025-09-12T09:54:49.000Z"><title>Interview | GYQçš„åšå®¢</title><meta name="description" content="Interview ä¸€. C++ C++æ˜¯åŸºç¡€ï¼Œä¼šåœ¨é¢è¯•æ ¡æ‹›ç”Ÿå’Œç¤¾æ‹›ä¸¤å¹´å†…æ—¶è€ƒå¯Ÿã€‚ 1. å †å’Œæ ˆçš„åŒºåˆ«ï¼Ÿ ç®¡ç†æ–¹å¼ï¼šæ ˆç”±ç¼–è¯‘å™¨ç®¡ç†ï¼Œå †ç”±ç¨‹åºå‘˜æ‰‹åŠ¨ç®¡ç†ï¼› ç¢ç‰‡é—®é¢˜ï¼šæ ˆä¸å­˜åœ¨ç¢ç‰‡é—®é¢˜ï¼Œå †å¾ˆå®¹æ˜“äº§ç”Ÿç¢ç‰‡ï¼› åˆ†é…æ–¹å¼ï¼šæ ˆæ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…çš„ï¼Œå †æ˜¯(new,delete/malloc,free)åˆ†é…ã€‚ åˆ†é…æ•ˆç‡ï¼šæ ˆçš„æ•ˆç‡æ¯”å †é«˜ï¼› 2. ä»¥ä¸‹å››è¡Œä»£ç ä¼šè°ƒç”¨åˆ°ä»€ä¹ˆå‡½...">
    <link rel="stylesheet" href="/Notes/assets/css/styles.e016f07c.css">
    <link rel="preload" href="/Notes/assets/js/runtime~app.712cebb1.js" as="script"><link rel="preload" href="/Notes/assets/css/styles.e016f07c.css" as="style"><link rel="preload" href="/Notes/assets/js/2047.24e5abc8.js" as="script"><link rel="preload" href="/Notes/assets/js/app.c0f0669f.js" as="script">
    <link rel="prefetch" href="/Notes/assets/js/zh_posts_flashattention.html.b1c0b289.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_posts_interview.html.cb67033b.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_posts_Deepseek_MLA.html.0dda65a0.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_posts_gemm.html.1fc67630.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_posts_softmax.html.56f8f20e.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_posts_parallel.html.9de0867d.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_posts_cpp.html.77b3d045.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_posts_AWQ.html.10de9382.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_posts_reduce.html.a503219c.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_posts_pagedattention.html.b7ac47da.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_posts_Inference.html.dff430b0.js" as="script"><link rel="prefetch" href="/Notes/assets/js/8300.0dbfd86b.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_posts_MoE.html.74ec6c39.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_posts_DeepSpeed.html.5f448ddb.js" as="script"><link rel="prefetch" href="/Notes/assets/js/demo_markdown.html.6207b366.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_posts_Examination.html.a2058f73.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_posts_Step3_AF.html.5ad68e26.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_posts_cuda-tech-stack.html.7d4658ed.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_notes_index.html.749f42a2.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_projects_index.html.13023d66.js" as="script"><link rel="prefetch" href="/Notes/assets/js/demo_page.html.616aea09.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_about_index.html.43601c8a.js" as="script"><link rel="prefetch" href="/Notes/assets/js/demo_layout.html.8dde54c6.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_posts_interview1.html.94763f5e.js" as="script"><link rel="prefetch" href="/Notes/assets/js/index.html.3a59f567.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_interview_index.html.f0215288.js" as="script"><link rel="prefetch" href="/Notes/assets/js/demo_disable.html.d71163c4.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_intro.html.28ed9b13.js" as="script"><link rel="prefetch" href="/Notes/assets/js/intro.html.a286bfb4.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_index.html.bb07931d.js" as="script"><link rel="prefetch" href="/Notes/assets/js/demo_index.html.ccaee54b.js" as="script"><link rel="prefetch" href="/Notes/assets/js/demo_encrypt.html.9afa503e.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_tag_æ³¨æ„åŠ›æœºåˆ¶_index.html.5bbc2c4f.js" as="script"><link rel="prefetch" href="/Notes/assets/js/category_index.html.7d951c14.js" as="script"><link rel="prefetch" href="/Notes/assets/js/timeline_index.html.b6a7590c.js" as="script"><link rel="prefetch" href="/Notes/assets/js/article_index.html.053b7324.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_category_æ·±åº¦å­¦ä¹ _index.html.6dc4a7c3.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_category_æœºå™¨å­¦ä¹ _index.html.300b8748.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_tag_å…«è‚¡é¢è¯•_index.html.f076429f.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_tag_ç®—æ³•ä¼˜åŒ–_index.html.d7f1afe9.js" as="script"><link rel="prefetch" href="/Notes/assets/js/star_index.html.dc387182.js" as="script"><link rel="prefetch" href="/Notes/assets/js/tag_index.html.e5503b63.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_tag_å¤§æ¨¡å‹_index.html.bbd1540b.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_tag_gpuä¼˜åŒ–_index.html.69da039d.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_tag_gpuç¼–ç¨‹_index.html.977a9f2e.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_category_å…«è‚¡_index.html.ecdbdcf4.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_category_ç¬”è®°_index.html.d24bd616.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_category_é¡¹ç›®_index.html.1b9ec38f.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_tag_æŠ€æœ¯_index.html.b484df4d.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_tag_é‡åŒ–_index.html.36f47622.js" as="script"><link rel="prefetch" href="/Notes/assets/js/tag_page-config_index.html.488b723b.js" as="script"><link rel="prefetch" href="/Notes/assets/js/tag_encryption_index.html.2e240ad4.js" as="script"><link rel="prefetch" href="/Notes/assets/js/category_guide_index.html.8468d31f.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_category_cuda_index.html.67833435.js" as="script"><link rel="prefetch" href="/Notes/assets/js/tag_markdown_index.html.08d65f23.js" as="script"><link rel="prefetch" href="/Notes/assets/js/404.html.b2941724.js" as="script"><link rel="prefetch" href="/Notes/assets/js/tag_disable_index.html.307f1950.js" as="script"><link rel="prefetch" href="/Notes/assets/js/tag_layout_index.html.6126668b.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_tag_cpp_index.html.ffb9b4d2.js" as="script"><link rel="prefetch" href="/Notes/assets/js/tag_guide_index.html.1b370312.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_timeline_index.html.d91b51e0.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_category_index.html.230e4f4c.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_article_index.html.065a6f4b.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_star_index.html.aeb41d98.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_tag_index.html.5b89155c.js" as="script"><link rel="prefetch" href="/Notes/assets/js/zh_posts_index.html.7d01c5a5.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/Notes/zh/" aria-label="å¸¦æˆ‘å›å®¶"><img class="vp-nav-logo" src="/Notes/public/YQ_logo1.png" alt><!----><span class="vp-site-name hide-in-pad">GYQçš„åšå®¢</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/Notes/zh/" aria-label="åšå®¢ä¸»é¡µ"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:house" height="1em" sizing="height"></iconify-icon><!--]-->åšå®¢ä¸»é¡µ<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/Notes/zh/notes/" aria-label="å­¦ä¹ ç¬”è®°"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:folder-open" height="1em" sizing="height"></iconify-icon><!--]-->å­¦ä¹ ç¬”è®°<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/Notes/zh/projects/" aria-label="é¡¹ç›®å®è·µ"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:code" height="1em" sizing="height"></iconify-icon><!--]-->é¡¹ç›®å®è·µ<!----></a></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><div class="vp-nav-item"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="é€‰æ‹©è¯­è¨€"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon i18n-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="i18n icon" name="i18n" style="width:1rem;height:1rem;vertical-align:middle;"><path d="M379.392 460.8 494.08 575.488l-42.496 102.4L307.2 532.48 138.24 701.44l-71.68-72.704L234.496 460.8l-45.056-45.056c-27.136-27.136-51.2-66.56-66.56-108.544h112.64c7.68 14.336 16.896 27.136 26.112 35.84l45.568 46.08 45.056-45.056C382.976 312.32 409.6 247.808 409.6 204.8H0V102.4h256V0h102.4v102.4h256v102.4H512c0 70.144-37.888 161.28-87.04 210.944L378.88 460.8zM576 870.4 512 1024H409.6l256-614.4H768l256 614.4H921.6l-64-153.6H576zM618.496 768h196.608L716.8 532.48 618.496 768z"></path></svg><!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/Notes/" aria-label="English"><!---->English<!----></a></li><li class="vp-dropdown-item"><a class="route-link route-link-active auto-link" href="/Notes/zh/posts/interview.html" aria-label="ç®€ä½“ä¸­æ–‡"><!---->ç®€ä½“ä¸­æ–‡<!----></a></li></ul></button></div></div><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/your-username/your-repo" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/" aria-label="åšå®¢ä¸»é¡µ"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:house" width="1em" height="1em" sizing="both"></iconify-icon><!--]-->åšå®¢ä¸»é¡µ<!----></a></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header clickable"><iconify-icon class="vp-icon" icon="fa6-solid:laptop-code" width="1em" height="1em" sizing="both"></iconify-icon><a class="auto-link external-link vp-sidebar-title no-external-link-icon" href="https://github.com/Summer536/Notes" aria-label="å¦‚ä½•ä½¿ç”¨" rel="noopener noreferrer" target="_blank"><!---->å¦‚ä½•ä½¿ç”¨<!----></a><!----></p><ul class="vp-sidebar-links"></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header active"><iconify-icon class="vp-icon" icon="fa6-solid:book" width="1em" height="1em" sizing="both"></iconify-icon><span class="vp-sidebar-title">æ–‡ç« </span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/posts/AWQ.html" aria-label="AWQ"><!---->AWQ<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/posts/cpp.html" aria-label="CPPå…«è‚¡"><!---->CPPå…«è‚¡<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/posts/cuda-tech-stack.html" aria-label="CUDAæŠ€æœ¯æ ˆ"><!---->CUDAæŠ€æœ¯æ ˆ<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/posts/Deepseek_MLA.html" aria-label="Deepseek MLA"><!---->Deepseek MLA<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/posts/DeepSpeed.html" aria-label="DeepSpeed"><!---->DeepSpeed<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/posts/Examination.html" aria-label="Examination"><!---->Examination<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/posts/flashattention.html" aria-label="Flashattention"><!---->Flashattention<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/posts/gemm.html" aria-label="GEMM"><!---->GEMM<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/posts/Inference.html" aria-label="InferenceæœåŠ¡çš„ä¸€äº›å¸¸è§é—®é¢˜"><!---->InferenceæœåŠ¡çš„ä¸€äº›å¸¸è§é—®é¢˜<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/Notes/zh/posts/interview.html" aria-label="Interview"><!---->Interview<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/posts/MoE.html" aria-label="MoE"><!---->MoE<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/posts/pagedattention.html" aria-label="PagedAttention"><!---->PagedAttention<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/posts/reduce.html" aria-label="Reduce"><!---->Reduce<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/posts/softmax.html" aria-label="Softmax"><!---->Softmax<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/posts/Step3_AF.html" aria-label="Step3 AFåˆ†ç¦»æ¨ç†ç³»ç»Ÿ vs. deepseek EPæ¨ç†ç³»ç»Ÿ"><!---->Step3 AFåˆ†ç¦»æ¨ç†ç³»ç»Ÿ vs. deepseek EPæ¨ç†ç³»ç»Ÿ<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/posts/interview1.html" aria-label="å…«è‚¡é¢è¯•"><!---->å…«è‚¡é¢è¯•<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/posts/parallel.html" aria-label="å¹¶è¡Œæ–¹æ³•DPã€TPã€PPã€EPã€SP"><!---->å¹¶è¡Œæ–¹æ³•DPã€TPã€PPã€EPã€SP<!----></a></li></ul></section></li><li><a class="route-link auto-link vp-sidebar-link" href="/Notes/zh/intro.html" aria-label="ä»‹ç»é¡µ"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:circle-info" width="1em" height="1em" sizing="both"></iconify-icon><!--]-->ä»‹ç»é¡µ<!----></a></li><li><a class="auto-link external-link vp-sidebar-link" href="https://ecosystem.vuejs.press/zh/plugins/markdown/revealjs/demo.html" aria-label="å¹»ç¯ç‰‡" rel="noopener noreferrer" target="_blank"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:person-chalkboard" width="1em" height="1em" sizing="both"></iconify-icon><!--]-->å¹»ç¯ç‰‡<!----></a></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Interview</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/Summer536" target="_blank" rel="noopener noreferrer">GYQ</a></span><span property="author" content="GYQ"></span></span><span class="page-original-info">åŸåˆ›</span><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">2025/8/16</span><meta property="datePublished" content="2025-08-16T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 74 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT74M"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color3 clickable" role="navigation">ç¬”è®°</span><!--]--><meta property="articleSection" content="ç¬”è®°"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color4 clickable" role="navigation">GPUä¼˜åŒ–</span><!--]--><meta property="keywords" content="GPUä¼˜åŒ–"></span></div><hr></div><!----><div class="" vp-content><!----><div id="markdown-content"><h1 id="interview" tabindex="-1"><a class="header-anchor" href="#interview"><span>Interview</span></a></h1><h2 id="ä¸€-c" tabindex="-1"><a class="header-anchor" href="#ä¸€-c"><span>ä¸€. C++</span></a></h2><p>C++æ˜¯åŸºç¡€ï¼Œä¼šåœ¨é¢è¯•æ ¡æ‹›ç”Ÿå’Œç¤¾æ‹›ä¸¤å¹´å†…æ—¶è€ƒå¯Ÿã€‚</p><h3 id="_1-å †å’Œæ ˆçš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_1-å †å’Œæ ˆçš„åŒºåˆ«"><span>1. å †å’Œæ ˆçš„åŒºåˆ«ï¼Ÿ</span></a></h3><ol><li>ç®¡ç†æ–¹å¼ï¼šæ ˆç”±ç¼–è¯‘å™¨ç®¡ç†ï¼Œå †ç”±ç¨‹åºå‘˜æ‰‹åŠ¨ç®¡ç†ï¼›</li><li>ç¢ç‰‡é—®é¢˜ï¼šæ ˆä¸å­˜åœ¨ç¢ç‰‡é—®é¢˜ï¼Œå †å¾ˆå®¹æ˜“äº§ç”Ÿç¢ç‰‡ï¼›</li><li>åˆ†é…æ–¹å¼ï¼šæ ˆæ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…çš„ï¼Œå †æ˜¯(new,delete/malloc,free)åˆ†é…ã€‚</li><li>åˆ†é…æ•ˆç‡ï¼šæ ˆçš„æ•ˆç‡æ¯”å †é«˜ï¼›</li></ol><h3 id="_2-ä»¥ä¸‹å››è¡Œä»£ç ä¼šè°ƒç”¨åˆ°ä»€ä¹ˆå‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_2-ä»¥ä¸‹å››è¡Œä»£ç ä¼šè°ƒç”¨åˆ°ä»€ä¹ˆå‡½æ•°"><span>2. ä»¥ä¸‹å››è¡Œä»£ç ä¼šè°ƒç”¨åˆ°ä»€ä¹ˆå‡½æ•°ï¼Ÿ</span></a></h3><p>// Aæ˜¯ä¸€ä¸ªC++ç±»<br> A a1(1); //æ„é€ å‡½æ•°<br> A a2(2); //æ„é€ å‡½æ•°<br> a2 = a1; // æ‹·è´èµ‹å€¼ï¼Œoperator=<br> A a3 = a1; //æ‹·è´æ„é€ å‡½æ•°ï¼ˆä½¿ç”¨å·²ç»åˆå§‹åŒ–çš„å¯¹è±¡a1å»åˆå§‹åŒ–ä¸€ä¸ªæ²¡æœ‰åˆå§‹åŒ–è¿‡çš„å¯¹è±¡a3ï¼Œç¬¦åˆæ‹·è´æ„é€ å‡½æ•°å®šä¹‰ï¼‰</p><h3 id="_3-c-ç±»çš„æ‹·è´æ„é€ å‡½æ•°æœ‰å“ªå‡ ç§è°ƒç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#_3-c-ç±»çš„æ‹·è´æ„é€ å‡½æ•°æœ‰å“ªå‡ ç§è°ƒç”¨åœºæ™¯"><span>3. C++ç±»çš„æ‹·è´æ„é€ å‡½æ•°æœ‰å“ªå‡ ç§è°ƒç”¨åœºæ™¯ï¼Ÿ</span></a></h3><ol><li>å¯¹è±¡ä½œä¸ºå‡½æ•°çš„å‚æ•°ï¼Œä»¥å€¼ä¼ é€’çš„æ–¹å¼ä¼ å…¥å‡½æ•°ä½“ï¼›ï¼ˆæ‰©å±•ï¼Œå½“æ‹·è´æ„é€ å‡½æ•°çš„å‚æ•°ä¸æ˜¯å¼•ç”¨ç±»å‹(const MyClass&amp; other)ï¼Œè€Œæ˜¯å€¼ç±»å‹(MyClass other)çš„æ—¶å€™ï¼Œå¯èƒ½å­˜åœ¨<strong>å¾ªç¯è°ƒç”¨æ‹·è´æ„é€ å‡½æ•°çš„æƒ…å†µï¼Œé€ æˆæ ˆæº¢å‡º</strong>ï¼‰</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> foo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">MyClass</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   // obj éœ€è¦æ‹·è´æ„é€ </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">MyClass a;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">foo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(a);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // è°ƒç”¨æ‹·è´æ„é€ å‡½æ•°</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>å¯¹è±¡ä½œä¸ºå‡½æ•°è¿”å›å€¼ï¼Œä»¥å€¼ä¼ é€’çš„æ–¹å¼ä»å‡½æ•°è¿”å›ï¼›ï¼ˆæ‰©å±•ï¼Œç°ä»£ç¼–è¯‘å™¨ä¼šé‡‡ç”¨RVO(return value optimization)<strong>è¿”å›å€¼ä¼˜åŒ–</strong>æ¥é¿å…æ‹·è´æ„é€ ï¼‰</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">MyClass</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> foo</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    MyClass obj;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> obj;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // è¿”å›å€¼éœ€è¦æ‹·è´æ„é€ ï¼ˆå¯èƒ½è¢« RVO/NRVO ä¼˜åŒ–æ‰ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>å¯¹è±¡éœ€è¦é€šè¿‡å¦å¤–ä¸€ä¸ªæœªåˆå§‹åŒ–è¿‡çš„å¯¹è±¡è¿›è¡Œåˆå§‹åŒ–ï¼›ï¼ˆå¦‚ä¸Š2.é¢˜ä¸­çš„ç¬¬å››ä¸ªå‡½æ•°ï¼‰</li></ol><h4 id="_3-1-c-ä¸­å¦‚ä½•è®¿é—®ç±»çš„ç§æœ‰æˆå‘˜" tabindex="-1"><a class="header-anchor" href="#_3-1-c-ä¸­å¦‚ä½•è®¿é—®ç±»çš„ç§æœ‰æˆå‘˜"><span>3.1 C++ä¸­å¦‚ä½•è®¿é—®ç±»çš„ç§æœ‰æˆå‘˜ï¼Ÿ</span></a></h4><ol><li>å‹å…ƒå‡½æ•°</li><li>é€šè¿‡ç›®æ ‡ç±»çš„æˆå‘˜å‡½æ•°è®¿é—®</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;iostream&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> MyClass</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> privateData;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // æ„é€ å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    MyClass</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) : </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">privateData</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(data) {}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 2.ç±»çš„è®¿é—®å™¨å‡½æ•°ï¼Œå¯è·å–ç§æœ‰æˆå‘˜çš„å€¼</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> getPrivateData</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> privateData;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 1.å‹å…ƒå‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    friend</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> accessPrivate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">MyClass</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);       </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> accessPrivate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">MyClass</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">privateData</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    MyClass </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">42</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">privateData</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //âŒ ç§æœ‰å˜é‡æ— æ³•è¢«ç›´æ¥è®¿é—®</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    std::cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;Private data: &quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getPrivateData</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::endl;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//âœ… å¯é€šè¿‡ç±»çš„æˆå‘˜å‡½æ•°è®¿é—®</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    std::cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;Private data: &quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  &lt;&lt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> accessPrivate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(obj) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::endl;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//âœ… å¯é€šè¿‡å‹å…ƒå‡½æ•°è®¿é—®</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-å“ªäº›å‡½æ•°ä¸èƒ½æ˜¯è™šå‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_4-å“ªäº›å‡½æ•°ä¸èƒ½æ˜¯è™šå‡½æ•°"><span>4.å“ªäº›å‡½æ•°ä¸èƒ½æ˜¯è™šå‡½æ•°ï¼Ÿ</span></a></h3><p>ç­”å‡ºä¸¤ä¸‰ä¸ªå¸¸è§çš„å³å¯ï¼Œå¹¶è¯´æ˜ä¸ºä»€ä¹ˆä¸èƒ½æ˜¯è™šå‡½æ•°ã€‚</p><p>è™šå‡½æ•°çš„æœ¬è´¨æ˜¯é€šè¿‡ <strong>è™šå‡½æ•°è¡¨æŒ‡é’ˆï¼ˆvptrï¼‰+ è™šå‡½æ•°è¡¨ï¼ˆvtableï¼‰</strong> å®ç°çš„å¤šæ€ï¼›å±äºè¿è¡Œæ—¶é˜¶æ®µ(runtime)è€Œéç¼–è¯‘æ—¶é˜¶æ®µ(compile time)ï¼›è™šå‡½æ•°å¿…é¡»æ˜¯ç±»çš„æˆå‘˜å‡½æ•°</p><ol><li><strong>é™æ€æˆå‘˜å‡½æ•°</strong>ï¼šé™æ€æˆå‘˜å‡½æ•°å±äºç±»æœ¬èº«ï¼Œè€Œä¸å±äºç±»çš„ä»»ä½•å¯¹è±¡ï¼Œæ²¡æœ‰thisæŒ‡é’ˆï¼Œæ— æ³•å®ç°å¤šæ€ï¼›ï¼ˆæ‰©å±•ï¼Œ<strong>é™æ€äºŒå­—è¡¨é¢å…¶åœ¨ç¼–è¯‘å™¨é˜¶æ®µå·²ç»ç¡®å®š</strong>ï¼Œæ— æ³•åœ¨è¿è¡Œæ—¶åŠ¨æ€ç»‘å®šï¼‰</li><li><strong>æ„é€ å‡½æ•°</strong>ï¼ˆææ„å‡½æ•°æ˜¯ä¸æ˜¯è™šå‡½æ•°ï¼Ÿå¯ä»¥æ˜¯ï¼‰ï¼šå¯¹è±¡åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œè™šå‡½æ•°è¡¨æŒ‡é’ˆvptrè¿˜æœªåˆå§‹åŒ–ï¼Œæ— æ³•å®ç°åŠ¨æ€ç»‘å®šï¼›ï¼ˆæ‰©å±•ï¼Œå¦‚æœç±»è¦ä½œä¸ºåŸºç±»å¹¶è¢«å¤šæ€ä½¿ç”¨ â†’ ææ„å‡½æ•°ä¸€å®šè¦æ˜¯è™šå‡½æ•°ï¼ˆå› ä¸ºå®ƒè¦å¯¹çˆ¶ç±»å’Œå­ç±»åŒæ—¶ææ„ï¼‰ï¼›å¦‚æœä¸ä½œä¸ºåŸºç±»åˆ™ä¸éœ€è¦ã€‚ï¼‰</li><li><strong>å‹å…ƒå‡½æ•°</strong>ï¼šå‹å…ƒå‡½æ•°ä¸æ˜¯ç±»çš„æˆå‘˜å‡½æ•°ï¼Œå®ƒåªæ˜¯è¢«æˆäºˆäº†è®¿é—®ç±»çš„ç§æœ‰æˆå‘˜çš„æƒé™ï¼›</li><li><strong>å†…è”å‡½æ•°</strong>ï¼šåŒé™æ€ä¸€æ ·ï¼Œå†…è”å‡½æ•°åœ¨ç¼–è¯‘å™¨é˜¶æ®µå·²ç»ç¡®å®šï¼›</li></ol><p>æ‰©å±•ï¼š<strong>è™šå‡½æ•°å’Œçº¯è™šå‡½æ•°çš„åŒºåˆ«</strong>ï¼šè™šå‡½æ•°æ˜¯åŸºç±»ä¸­ç”¨ virtual ä¿®é¥°çš„å‡½æ•°ï¼Œå¯ä»¥æœ‰å‡½æ•°ä½“ï¼Œå­ç±»å¯ä»¥é€‰æ‹©æ˜¯å¦é‡å†™overrideã€‚<strong>çº¯è™šå‡½æ•°</strong>æ˜¯ç”¨ =0 å®šä¹‰çš„è™šå‡½æ•°ï¼Œæ²¡æœ‰å‡½æ•°ä½“ï¼Œ<strong>è¦æ±‚å­ç±»å¿…é¡»overrideå®ç°</strong>ã€‚</p><h3 id="_5-unique-ptrã€shared-ptrã€auto-ptrçš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_5-unique-ptrã€shared-ptrã€auto-ptrçš„åŒºåˆ«"><span>5. unique_ptrã€shared_ptrã€auto_ptrçš„åŒºåˆ«ï¼Ÿ</span></a></h3><ol><li>unique_ptrï¼šä¸æ”¯æŒæ‹·è´ï¼Œåªæ”¯æŒæŒ‡é’ˆæ‰€æœ‰æƒçš„è½¬ç§»ï¼›</li><li>shared_ptrï¼šæ”¯æŒæ‹·è´ï¼Œå†…éƒ¨æœ‰å¼•ç”¨è®¡æ•°ï¼Œæœ€åä¸€ä¸ª shared_ptr ææ„æ—¶æ‰é‡Šæ”¾èµ„æºï¼›</li><li>auto_ptrï¼šæ‹·è´æˆ–èµ‹å€¼æ—¶ï¼Œæ‰€æœ‰æƒä¼šè½¬ç§»ï¼Œè¢«èµ‹å€¼çš„ä¸€æ–¹å¤±å»æ‰€æœ‰æƒï¼Œç½®ä¸º nullptrã€‚ï¼ˆ<strong>C++11å·²å¼ƒç”¨</strong>ï¼‰</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;iostream&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;memory&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 1. unique ptr</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    std::unique_ptr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;int&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ptr1;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    ptr1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">reset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">42</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">));</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //æˆ–è€…std::unique_ptr&lt;int&gt; ptr1(new int(42)); å› ä¸ºunique_ptr çš„æ„é€ å‡½æ•°æ¥å—è£¸æŒ‡é’ˆï¼Œä½†èµ‹å€¼å¿…é¡»ç”¨ reset æˆ–åˆå§‹åŒ–ã€‚</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    std::unique_ptr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;int&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ptr2;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ptr2 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ptr1;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //âŒ unique_pträ¸æ”¯æŒæ‹·è´</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ptr2 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">move</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(ptr1);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //âœ… æŒ‡é’ˆçš„æ‰€æœ‰æƒéšä¹‹è½¬ç§» print ptr1.get()ä¼šå¾—åˆ° nullptr</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 2. shared ptr</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    std::unique_ptr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;int&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ptr1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">43</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    std::shared_ptr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;int&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ptr2;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ptr2 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ptr1</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //âœ… å¼•ç”¨è®¡æ•°+1ï¼Œptr1.use_count() == ptr2.use_count() == 2</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">ï¼›</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-å››ç§å¼ºåˆ¶ç±»å‹è½¬æ¢æ˜¯ä»€ä¹ˆ-å®ƒä»¬çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_6-å››ç§å¼ºåˆ¶ç±»å‹è½¬æ¢æ˜¯ä»€ä¹ˆ-å®ƒä»¬çš„åŒºåˆ«"><span>6.å››ç§å¼ºåˆ¶ç±»å‹è½¬æ¢æ˜¯ä»€ä¹ˆï¼Ÿå®ƒä»¬çš„åŒºåˆ«ï¼Ÿ</span></a></h3><ol><li><strong>const_cast</strong>ï¼šå»æ‰æˆ–æ·»åŠ  const / volatile é™å®šã€‚</li><li><strong>static_cast</strong>ï¼šåŸºæœ¬ç±»å‹è½¬æ¢ï¼ˆ<strong>ä¸Šã€ä¸‹è¡Œè½¬æ¢éƒ½å¯ç”¨</strong>ï¼‰ï¼Œä½†ä½¿ç”¨å®ƒå®ç°çˆ¶ç±»è½¬å­ç±»(ä¸‹è¡Œè½¬æ¢)ä¸å¤ªå®‰å…¨ã€‚ï¼ˆæ‰©å±•ï¼Œå¦‚æœç¨‹åºå‘˜å¯ä»¥ç¡®è®¤è¯¥çˆ¶ç±»è½¬å­ç±»æ˜¯å®‰å…¨çš„æƒ…å†µä¸‹ï¼Œä¼˜å…ˆç”¨static_castæ¯”dynamic_castæ€§èƒ½æ›´ä½³ï¼‰</li><li><strong>dynamic_cast</strong>ï¼šä»…ç”¨äº<strong>ä¸‹è¡Œè½¬æ¢</strong>ï¼Œ<strong>å®‰å…¨</strong>ï¼Œå¤±è´¥è¿”å› nullptrã€‚</li><li><strong>reinterpret_cast</strong>ï¼šç”¨äºåº•å±‚ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼Œä¾‹å¦‚float=&gt;float4ã€‚</li></ol><p><strong>æ³¨æ„ï¼šä¸Šè¡Œè½¬æ¢æ˜¯ç»å¯¹å®‰å…¨çš„</strong></p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;iostream&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// å®šä¹‰çˆ¶ç±»</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Shape</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// å®šä¹‰å­ç±»</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Circle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> : </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Shape</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    Circle circle;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// åˆ›å»ºå­ç±»å¯¹è±¡</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // å‘ä¸Šè½¬æ¢ï¼šå­ç±»æŒ‡é’ˆè½¬æ¢ä¸ºçˆ¶ç±»æŒ‡é’ˆï¼Œç»å¯¹å®‰å…¨ã€‚</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    Shape</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> shapePtr </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">circle;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //ä¸éœ€è¦æ˜¾å¼å†™ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¼˜åŒ–ä¸º Shape* shapePtr = static_cast&lt;Shape*&gt;(&amp;circle); </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // å‘ä¸‹è½¬æ¢ï¼šçˆ¶ç±»æŒ‡é’ˆè½¬æ¢ä¸ºå­ç±»æŒ‡é’ˆï¼Œç¨‹åºå‘˜ç¡®ä¿å®‰å…¨æ—¶å¯ç”¨static_castï¼Œå¼€é”€å°ï¼›</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    Circle</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> circlePtr </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#ABB2BF;"> static_cast</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Circle</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(shapePtr);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // å‘ä¸‹è½¬æ¢ï¼šçˆ¶ç±»æŒ‡é’ˆè½¬æ¢ä¸ºå­ç±»æŒ‡é’ˆï¼Œç¨‹åºå‘˜æ— æ³•ç¡®ä¿å®‰å…¨æ—¶å¯ç”¨dynamic_castï¼Œå¼€é”€å¤§ï¼›</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    Circle</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> circlePtr </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#ABB2BF;"> dynamic_cast</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Circle</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(shapePtr);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-constå’Œconstexperçš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_7-constå’Œconstexperçš„åŒºåˆ«"><span>7.constå’Œconstexperçš„åŒºåˆ«ï¼Ÿ</span></a></h3><ol><li>conståªè¡¨ç¤º<strong>åªè¯»è¯­ä¹‰</strong>ï¼Œconstexprè¡¨ç¤º<strong>å¸¸é‡è¯­ä¹‰</strong>ï¼›</li><li>constexprç”¨ä½œä¿®é¥°ç¼–è¯‘æœŸå¸¸é‡ï¼Œå¯ä»¥åœ¨ç¼–è¯‘æœŸæå‰å¤„ç†ä»¥å‡å°‘runtimeæ—¶é—´ï¼›å¯å¹¿æ³›ç”¨äºæ¨¡ç‰ˆå‚æ•°ï¼ˆå› ä¸ºæ¨¡ç‰ˆå‚æ•°æ˜¯è¦åœ¨ç¼–è¯‘æœŸç¡®å®šçš„ï¼‰</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  //å®ƒæ˜¯å˜é‡ï¼Œåœ¨runtimeæ—¶è®¡ç®—å¾—å‡ºï¼Œä¸å¯ä¼ å…¥æ¨¡ç‰ˆå‚æ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">constexpr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> b </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //å®ƒæ˜¯å¸¸é‡ï¼Œåœ¨ç¼–è¯‘æœŸå³å¯è¢«ç¼–è¯‘å™¨ç®—å‡ºç¡®å®šï¼Œå¯ä¼ å…¥æ¨¡ç‰ˆå‚æ•°</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-shared-pträ¸­çš„å¼•ç”¨è®¡æ•°ç”¨ä»€ä¹ˆæ•°æ®ç»“æ„å®ç°-å¯ä»¥ç”¨staticå˜é‡æ¥å®ç°å—-ä¸ºä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#_8-shared-pträ¸­çš„å¼•ç”¨è®¡æ•°ç”¨ä»€ä¹ˆæ•°æ®ç»“æ„å®ç°-å¯ä»¥ç”¨staticå˜é‡æ¥å®ç°å—-ä¸ºä»€ä¹ˆ"><span>8. shared_pträ¸­çš„å¼•ç”¨è®¡æ•°ç”¨ä»€ä¹ˆæ•°æ®ç»“æ„å®ç°ï¼Ÿå¯ä»¥ç”¨staticå˜é‡æ¥å®ç°å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</span></a></h3><p>int*</p><p>ä¸èƒ½ï¼</p><p><strong>staticä¿®é¥°çš„å˜é‡å±äºç±»æ‰€æœ‰</strong>ï¼Œè€Œæ¯ä¸ªshared_ptrçš„æ˜¯åŒä¸€ç±»çš„ä¸åŒå¯¹è±¡ï¼Œå¦‚æœé‡‡ç”¨staticä¿®é¥°ï¼Œåˆ™ä¸åŒçš„shared_ptrçš„å¼•ç”¨è®¡æ•°éƒ½æ˜¯åŒä¸€ä¸ªå˜é‡ï¼Œä¼šå¯¼è‡´è®¡æ•°é”™è¯¯ã€‚è§å¦‚ä¸‹ä¾‹å­</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">shared_ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ptr1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">42</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">));</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //ptr1æ˜¯shared_ptrç±»çš„ä¸€ä¸ªå¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">shared_ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ptr2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">43</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">));</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //åŒç†ï¼Œptr2æ˜¯shared_ptrç±»çš„å¦ä¸€ä¸ªå¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">shared_ptr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;int&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ptr3;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">ptr3 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ptr2;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //æ­¤æ—¶ptr3çš„å¼•ç”¨è®¡æ•° == ptr2çš„å¼•ç”¨è®¡æ•° == 2ï¼Œptr1çš„å¼•ç”¨è®¡æ•°ä¸º1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//å¦‚æœé‡‡ç”¨staticå˜é‡æ¥å®ç°shared_ptrçš„å¼•ç”¨è®¡æ•°ï¼Œåˆ™ptr1ã€ptr2ã€ptr3çš„å¼•ç”¨è®¡æ•°éƒ½æ˜¯åŒä¸€ä¸ªå˜é‡ï¼Œéƒ½ä¸º2ï¼Œptr1è®¡æ•°é”™è¯¯äº†ã€‚</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-shared-pträ¸­çš„å¼•ç”¨è®¡æ•°å¯ä»¥ç”¨intç±»å‹å—-å¦‚æœå¯ä»¥-ä¸‹é¢çš„ä»£ç ä¼šå‘ç”Ÿä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#_9-shared-pträ¸­çš„å¼•ç”¨è®¡æ•°å¯ä»¥ç”¨intç±»å‹å—-å¦‚æœå¯ä»¥-ä¸‹é¢çš„ä»£ç ä¼šå‘ç”Ÿä»€ä¹ˆ"><span>9. shared_pträ¸­çš„å¼•ç”¨è®¡æ•°å¯ä»¥ç”¨intç±»å‹å—ï¼Ÿå¦‚æœå¯ä»¥ï¼Œä¸‹é¢çš„ä»£ç ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</span></a></h3><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> shared_ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> count;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //å¦‚æœè¿™é‡Œç”¨intç±»å‹</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">shared_ptr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">T</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> make_shared</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //æ­¤æ—¶açš„è®¡æ•°ä¸º1</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">shared_ptr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">T</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> b </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //æ­¤æ—¶bçš„è®¡æ•°ä¸º2ï¼ˆæ‹·è´æ„é€ å‡½æ•°åœ¨açš„å¼•ç”¨è®¡æ•°å™¨ä¸Š+1 = bçš„è®¡æ•°ï¼‰ï¼Œaçš„è®¡æ•°è¿˜ä¸º1ï¼Œä½†æ˜¯aæœ¬è¯¥ä¹Ÿä¸º2</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">shared_ptr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">T</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> c </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //åŒç†cçš„è®¡æ•°ä¸º2ï¼Œaçš„è®¡æ•°ä¸º1ï¼Œä½†æ˜¯aæœ¬è¯¥ä¹Ÿä¸º2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šä»£ç å¦‚æœä½¿ç”¨æ­£ç¡®çš„int*,åˆ™å¯æ­£ç¡®è®¡æ•°ã€‚å› ä¸º<strong>int*æ˜¯æŒ‡é’ˆï¼ŒæŒ‡å‘åŒä¸€å—ç©ºé—´ï¼Œbã€cè®¡æ•°æ”¹å˜æ—¶ï¼Œå®ƒä»¬çš„è®¡æ•°å™¨ä¸ºåŒä¸€å—bufferï¼Œaä¹Ÿä¼šæ›´ç€åŒæ—¶å˜åŒ–çš„</strong>ã€‚</p><h3 id="_10-ä»¥ä¸‹ä»£ç å¯ä»¥å¦‚ä½•ä¼˜åŒ–-è¿™æ˜¯ä»€ä¹ˆä¼˜åŒ–åŸç†-raii" tabindex="-1"><a class="header-anchor" href="#_10-ä»¥ä¸‹ä»£ç å¯ä»¥å¦‚ä½•ä¼˜åŒ–-è¿™æ˜¯ä»€ä¹ˆä¼˜åŒ–åŸç†-raii"><span>10. ä»¥ä¸‹ä»£ç å¯ä»¥å¦‚ä½•ä¼˜åŒ–ï¼Ÿè¿™æ˜¯ä»€ä¹ˆä¼˜åŒ–åŸç†ï¼Ÿï¼ˆRAIIï¼‰</span></a></h3><p>æˆ‘ä»¬æƒ³è®©ç¼–è¯‘å™¨è‡ªåŠ¨é‡Šæ”¾ä¸€äº›èµ„æºï¼Œè¿™æ ·å¯ä»¥è®©æˆ‘ä»¬ä¸ç”¨æ‰‹åŠ¨é‡Šæ”¾èµ„æºï¼Œé¿å…èµ„æºæ³„éœ²ã€‚</p><p>è¿™å°±ç”¨åˆ°äº†RAIIï¼ˆResource Acquisition Is Initializationï¼‰ç‰¹æ€§ï¼šåœ¨mainå‡½æ•°ä¸­å°†å¯¹è±¡åˆå§‹åŒ–ä¸ºä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œåœ¨ä½¿ç”¨å®Œæˆåç¼–è¯‘å™¨ä¼šè‡ªåŠ¨è°ƒç”¨å¯¹è±¡çš„ææ„å‡½æ•°ï¼Œä»è€Œé‡Šæ”¾èµ„æºã€‚</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;iostream&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;memory&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Resource</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // æ„é€ å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    Resource</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        std::cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;Resource acquired.&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::endl;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ææ„å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    ~Resource</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        std::cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;Resource released.&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::endl;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> use</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        std::cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;Using the resource.&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::endl;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // åˆå§‹åŒ–å±€éƒ¨å˜é‡</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    Resource r </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Resource</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ä½¿ç”¨ resource å¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    r</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">use</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // main å‡½æ•°ç»“æŸæ—¶ï¼Œresource å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç»“æŸï¼Œå…¶ææ„å‡½æ•°ä¼šè¢«è‡ªåŠ¨è°ƒç”¨</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // è¿™å°†é‡Šæ”¾ Resource å¯¹è±¡æ‰€å ç”¨çš„èµ„æº</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//è¾“å‡º</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//Resource acquired.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//Using the resource.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//Resource released.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_11-å¤šä¸ªif-elseä¸‹éƒ½æ˜¯é«˜åº¦é‡å¤çš„ä»£ç -å¹¶ä¸”è°ƒç”¨äº†å¤§é‡çš„å‡½æ•°å‚æ•°-å¯ä»¥å¦‚ä½•ç®€åŒ–è¿™æ®µä»£ç " tabindex="-1"><a class="header-anchor" href="#_11-å¤šä¸ªif-elseä¸‹éƒ½æ˜¯é«˜åº¦é‡å¤çš„ä»£ç -å¹¶ä¸”è°ƒç”¨äº†å¤§é‡çš„å‡½æ•°å‚æ•°-å¯ä»¥å¦‚ä½•ç®€åŒ–è¿™æ®µä»£ç "><span>11. å¤šä¸ªif elseä¸‹éƒ½æ˜¯é«˜åº¦é‡å¤çš„ä»£ç ï¼Œå¹¶ä¸”è°ƒç”¨äº†å¤§é‡çš„å‡½æ•°å‚æ•°ï¼Œå¯ä»¥å¦‚ä½•ç®€åŒ–è¿™æ®µä»£ç ï¼Ÿ</span></a></h3><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> TestFun</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a, b, c;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .....</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   // å·´æ‹‰å·´æ‹‰çš„ä¸€å †å˜é‡</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (æ¡ä»¶1)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // é™¤äº†å‡ ä¸ªå˜é‡ä¸åŒå¤–éƒ½æ˜¯ç›¸åŒçš„ä»£ç å—</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // å…¶ä¸­ä½¿ç”¨aã€bã€c....ä¸€å †å˜é‡</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(a,b,c,d,e,f,g...)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (æ¡ä»¶2ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // é™¤äº†å‡ ä¸ªå˜é‡ä¸åŒå¤–éƒ½æ˜¯ç›¸åŒçš„ä»£ç å—</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // å…¶ä¸­ä½¿ç”¨aã€bã€c....ä¸€å †å˜é‡</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (æ¡ä»¶3)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // é™¤äº†å‡ ä¸ªå˜é‡ä¸åŒå¤–éƒ½æ˜¯ç›¸åŒçš„ä»£ç å—        // å…¶ä¸­ä½¿ç”¨aã€bã€c....ä¸€å †å˜é‡</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç­”ï¼šlambdaè¡¨è¾¾å¼</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;iostream&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">using</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> namespace</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> std</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> TestFun</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, b </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 20</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, c </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 30</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   // å…¬å…±å˜é‡</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> d </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 40</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, e </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 50</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">           // å…¬å…±å˜é‡</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // å®šä¹‰ä¸€ä¸ª lambdaï¼ŒæŠŠé‡å¤çš„ä»£ç æ”¾åœ¨é‡Œé¢</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> lambdaFun </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">](</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> param</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // è¿™é‡Œå¯ä»¥ç›´æ¥ç”¨å¤–éƒ¨å˜é‡ a,b,c,d,eï¼ˆå› ä¸ºæˆ‘ä»¬ç”¨ &amp; æ•è·äº†ï¼‰ ï¼ï¼ï¼ï¼ï¼ï¼åªå†™ç‰¹æ®Šå˜é‡paramå³å¯</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;a+b+c = &quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (a </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> b </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> c) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> endl;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;d*e   = &quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (d </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> e) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> endl;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // åªæœ‰ param æ˜¯ä¸åŒçš„</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;param = &quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> param </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> endl;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ä¸åŒæ¡ä»¶ä¸‹ï¼Œåªä¼ ä¸åŒçš„å‚æ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> æ¡ä»¶1 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> æ¡ä»¶2 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> æ¡ä»¶3 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (æ¡ä»¶1) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        lambdaFun</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   // param1</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (æ¡ä»¶2) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        lambdaFun</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">200</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   // param2</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (æ¡ä»¶3) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        lambdaFun</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">300</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   // param3</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//è¾“å‡º</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">a</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">b</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">c </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 60</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">d</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e   </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2000</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">param </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 100</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">a</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">b</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">c </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 60</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">d</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e   </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2000</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">param </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 300</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_12-æ¨¡ç‰ˆå‡½æ•°æœ‰å“ªäº›ç¼–è¯‘æ–¹å¼-å“ªä¸ªæ›´å¥½" tabindex="-1"><a class="header-anchor" href="#_12-æ¨¡ç‰ˆå‡½æ•°æœ‰å“ªäº›ç¼–è¯‘æ–¹å¼-å“ªä¸ªæ›´å¥½"><span>12. æ¨¡ç‰ˆå‡½æ•°æœ‰å“ªäº›ç¼–è¯‘æ–¹å¼ï¼Ÿå“ªä¸ªæ›´å¥½ï¼Ÿ</span></a></h3><p>ä¸€ä½“åŒ–ç¼–è¯‘ä¼šå¢åŠ ç¼–è¯‘æ—¶é—´ï¼Œåˆ†ç¦»å¼ç¼–è¯‘ä¼šå¤šæ¬¡é‡å¤æ˜¾å¼å®ä¾‹åŒ–ï¼Œä¸”å¤šä¸ªcppå¯èƒ½å®ä¾‹åŒ–åŒä¸€æ¨¡æ¿é€ æˆç»´æŠ¤å›°éš¾ï¼›å‰è€…å¯èƒ½é€ æˆå¯æ‰§è¡Œæ–‡ä»¶è†¨èƒ€ï¼ˆç”±äºæ¯ä¸ªcppæ–‡ä»¶éƒ½ä¼šå¯¼å…¥.hå¤´æ–‡ä»¶ï¼Œå¤´æ–‡ä»¶ä¸­ç”±äºå·²ç»å®ä¾‹åŒ–å› æ­¤ä¼šé€ æˆé‡å¤ä»£ç çš„å¯¼å…¥ï¼‰ã€‚</p><p>ä½†ä»ç„¶ä¸€èˆ¬<strong>æ¨èä¸€ä½“åŒ–ç¼–è¯‘</strong></p><ol><li><strong>ä¸€ä½“åŒ–ç¼–è¯‘</strong> ï¼šæ¨¡æ¿ç±»æˆ–å‡½æ•°çš„ å£°æ˜ + å®šä¹‰éƒ½æ”¾åœ¨å¤´æ–‡ä»¶ã€‚è°ƒç”¨æ—¶<strong>ç¼–è¯‘å™¨èƒ½ç›´æ¥çœ‹åˆ°å®Œæ•´å®šä¹‰ï¼Œä»è€Œå®ä¾‹åŒ–</strong>ã€‚æœ€å¸¸è§çš„æ–¹å¼ï¼ŒC++STLã€NVçš„cutlass ç­‰å¾ˆå¤šç»„ä»¶éƒ½æ˜¯è¿™æ ·ã€‚</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// MyTemplate.h</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">template</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typename</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> T</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> b;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong>åˆ†ç¦»å¼ç¼–è¯‘</strong>ï¼šæ¨¡æ¿çš„ å£°æ˜æ”¾åœ¨ .hï¼Œå®šä¹‰æ”¾åœ¨ .cppã€‚å› ä¸ºç¼–è¯‘å™¨åœ¨çœ‹åˆ° .h æ—¶å¹¶ä¸çŸ¥é“ <strong>.cpp é‡Œçš„å®šä¹‰ï¼Œæ‰€ä»¥å¿…é¡»æ˜¾å¼å®ä¾‹åŒ–</strong>éœ€è¦çš„ç±»å‹ï¼Œå¦åˆ™ä¼šæŠ¥é“¾æ¥é”™è¯¯ã€‚</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// MyTemplate.h</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">template</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typename</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> T</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// MyTemplate.cpp</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;MyTemplate.h&quot;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">template</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typename</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> T</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) { </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> b; }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// æ˜¾å¼å®ä¾‹åŒ–</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">template</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">template</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> double</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_13-æ¨¡æ¿å®ä¾‹åŒ–ã€ç‰¹ä¾‹åŒ–ã€åç‰¹åŒ–çš„æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#_13-æ¨¡æ¿å®ä¾‹åŒ–ã€ç‰¹ä¾‹åŒ–ã€åç‰¹åŒ–çš„æ¦‚å¿µ"><span>13. æ¨¡æ¿å®ä¾‹åŒ–ã€ç‰¹ä¾‹åŒ–ã€åç‰¹åŒ–çš„æ¦‚å¿µï¼Ÿ</span></a></h3><ol><li>æ¨¡æ¿å®ä¾‹åŒ–ï¼šç¼–è¯‘å™¨åœ¨çœ‹åˆ°å…·ä½“ç±»å‹æ—¶ï¼Œæ ¹æ®æ¨¡æ¿ç”Ÿæˆå¯¹åº”çš„å…·ä½“å‡½æ•°æˆ–ç±»ã€‚</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// å‡½æ•°æ¨¡æ¿</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">template</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typename</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> T</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) { </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> b; }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       // éšå¼å®ä¾‹åŒ– -&gt; ç”Ÿæˆ add&lt;int&gt;(int, int)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1.1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2.2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   // éšå¼å®ä¾‹åŒ– -&gt; ç”Ÿæˆ add&lt;double&gt;(double, double)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // æ˜¾å¼å®ä¾‹åŒ–</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    template </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>æ¨¡æ¿ç‰¹ä¾‹åŒ–ï¼šä¸ºæŸä¸ªç‰¹å®šç±»å‹æä¾›å®Œå…¨ä¸åŒçš„å®ç°ï¼Œè¦†ç›–åŸæœ‰çš„é€šç”¨æ¨¡æ¿ã€‚</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// é€šç”¨æ¨¡æ¿</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">template</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typename</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> T</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Printer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) { std::cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> val </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::endl; }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// ç‰¹ä¾‹åŒ–ï¼šchar* çš„æ‰“å°æ–¹å¼ä¸åŒ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">template</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Printer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">char*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">char*</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) { std::cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;C-string: &quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> val </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::endl; }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>æ¨¡æ¿åç‰¹åŒ–ï¼šä¸æ˜¯é’ˆå¯¹æŸä¸€ä¸ªå®Œå…¨ç¡®å®šçš„ç±»å‹ï¼Œè€Œæ˜¯é’ˆå¯¹ ä¸€ç±»ç±»å‹æ¨¡å¼ æä¾›ç‰¹æ®Šå®ç°ã€‚</li></ol><p><strong>éƒ¨åˆ†å‚æ•°ç‰¹åŒ–</strong>ï¼ˆä¸ªæ•°ä¸Šçš„åç‰¹åŒ–ï¼‰</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;iostream&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// åŸå§‹çš„æ¨¡æ¿å®šä¹‰</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">template</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typename</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> T1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typename</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> T2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> MyTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        std::cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;General template&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::endl;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// éƒ¨åˆ†å‚æ•°åç‰¹åŒ–ï¼Œå¯¹ç¬¬äºŒä¸ªå‚æ•°ç‰¹åŒ–ä¸º int ç±»å‹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">template</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typename</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> T1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> MyTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        std::cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;Partial specialization with T2 = int&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::endl;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    MyTemplate</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">char&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> obj1;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    obj1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // è°ƒç”¨é€šç”¨æ¨¡æ¿çš„ print å‡½æ•°</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    MyTemplate</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> obj2;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    obj2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // è°ƒç”¨éƒ¨åˆ†ç‰¹åŒ–æ¨¡æ¿çš„ print å‡½æ•°</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å‚æ•°èŒƒå›´çš„åç‰¹åŒ–</strong>ï¼ˆèŒƒå›´ä¸Šçš„åç‰¹åŒ–ï¼‰</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;iostream&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// åŸå§‹çš„æ¨¡æ¿å®šä¹‰</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">template</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typename</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> T</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> MyTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        std::cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;General template&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::endl;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// ç±»å‹èŒƒå›´åç‰¹åŒ–ï¼Œå¯¹æŒ‡é’ˆç±»å‹è¿›è¡Œç‰¹åŒ–</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">template</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typename</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> T</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> MyTemplate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        std::cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;Partial specialization for pointer types&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::endl;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    MyTemplate</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;int&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> obj1;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    obj1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // è°ƒç”¨é€šç”¨æ¨¡æ¿çš„ print å‡½æ•°</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> num </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    MyTemplate</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;int*&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> obj2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">num);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    obj2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // è°ƒç”¨æŒ‡é’ˆç±»å‹åç‰¹åŒ–æ¨¡æ¿çš„ print å‡½æ•°</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_14-ä½¿ç”¨æ¨¡ç‰ˆæ¥å®ç°ä¸€ä¸ªæ–æ³¢é‚£å¥‘æ•°åˆ—-çœ‹çœ‹å°±å¥½" tabindex="-1"><a class="header-anchor" href="#_14-ä½¿ç”¨æ¨¡ç‰ˆæ¥å®ç°ä¸€ä¸ªæ–æ³¢é‚£å¥‘æ•°åˆ—-çœ‹çœ‹å°±å¥½"><span>14. ä½¿ç”¨æ¨¡ç‰ˆæ¥å®ç°ä¸€ä¸ªæ–æ³¢é‚£å¥‘æ•°åˆ—ï¼ˆçœ‹çœ‹å°±å¥½ï¼‰</span></a></h3><p>è¿™ä¸ªæ˜¯ä¸ªæ¨¡ç‰ˆå…ƒå‡½æ•°çš„å…¸å‹ä¾‹å­ï¼Œåˆ©ç”¨äº†æ¨¡ç‰ˆçš„é€’å½’æ€§</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;iostream&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">using</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> namespace</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> std</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 1.ä½¿ç”¨staticç¡®ä¿ç”Ÿæˆçš„valueæ˜¯å±äºæ•´ä¸ªç±»Fibonacciï¼Œè€ŒéæŸä¸ªå¯¹è±¡ï¼Œå› æ­¤è¯¥ç±»çš„æ‰€æœ‰æˆå‘˜å¯ä»¥ç›´æ¥è®¿é—®æ— éœ€æ¯ä¸ªå¯¹è±¡éƒ½åˆå§‹åŒ–è¿™ä¸ªå˜é‡</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 2.ä½¿ç”¨constexprï¼Œ æœ€ç»ˆç»“æœ 55 åœ¨ç¼–è¯‘æœŸå°±èƒ½ç®—å‡ºæ¥ï¼Œè¿è¡Œæ—¶åªæ˜¯æ‰“å°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">template</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> N</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Fibonacci</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> constexpr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> value </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Fibonacci&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">N</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;::value </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Fibonacci&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">N</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;::value;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">template</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Fibonacci</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> constexpr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> value </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">template</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Fibonacci</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> constexpr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> value </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> result </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Fibonacci&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;::value;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> result </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> endl;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_15-ä»¥ä¸‹ä»£ç ä¼šè°ƒç”¨å“ªäº›å‡½æ•°-è®²è®²c-çš„å³å€¼æœ‰å“ªäº›" tabindex="-1"><a class="header-anchor" href="#_15-ä»¥ä¸‹ä»£ç ä¼šè°ƒç”¨å“ªäº›å‡½æ•°-è®²è®²c-çš„å³å€¼æœ‰å“ªäº›"><span>15.ä»¥ä¸‹ä»£ç ä¼šè°ƒç”¨å“ªäº›å‡½æ•°ï¼Ÿè®²è®²C++çš„å³å€¼æœ‰å“ªäº›ï¼Ÿ</span></a></h3><p>cppä¸­å³å€¼ (rvalue) æŒ‡çš„æ˜¯ï¼š<strong>ä¸èƒ½å‡ºç°åœ¨èµ‹å€¼è¯­å¥å·¦è¾¹çš„å€¼</strong>ã€‚<br> å³å€¼æœ‰ä¸¤ç§ç±»å‹ï¼Œçº¯å³å€¼å’Œå°†äº¡å€¼ã€‚</p><ol><li><strong>çº¯å³å€¼</strong>ï¼šå­—é¢å€¼ï¼ˆä¾‹ï¼š0ã€1ã€2ï¼‰ï¼Œè¡¨è¾¾å¼ï¼ˆä¾‹ï¼šx+yï¼‰ï¼Œè¿”å›çš„å¯¹è±¡</li><li><strong>å°†äº¡å€¼</strong>ï¼šå±äºå¯¹è±¡ï¼Œä½†å³å°†è¢«é”€æ¯ï¼Œå¯ä»¥â€œçªƒå–èµ„æºâ€ã€‚ä¾‹å¦‚ std<iconify-icon class="vp-icon" icon="fa6-solid:move(a)ã€ static_cast&lt;A&amp;&amp;&gt;(a)ä¸­çš„aï¼ˆå¯¹åº”ä¸‹æ–¹ä»£ç çš„o" height=" std" sizing="height" style="--icon-size: std;"></iconify-icon>move(obj)ä¸­çš„objï¼‰ã€‚</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> BigObj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    explicit</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> BigObj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">size_t</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> length</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        : </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">length_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(length), </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">data_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[length]) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ææ„</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    ~BigObj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">     if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (data_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">       delete[]</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> data_;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        length_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">     }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // æ‹·è´æ„é€ å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    BigObj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> BigObj</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> other</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> default</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // èµ‹å€¼è¿ç®—ç¬¦</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    BigObj</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> operator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">=(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> BigObj</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> other</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> default</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ç§»åŠ¨æ„é€ å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    BigObj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">BigObj</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> other</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) : </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">data_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">nullptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">), </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">length_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        data_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> other</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">data_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        length_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> other</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">length_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        //ç§»åŠ¨æ„é€ å‡½æ•°åï¼Œæ²¡æœ‰å°†åŸå¯¹è±¡å›å¤é»˜è®¤å€¼</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ç§»åŠ¨èµ‹å€¼å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    BigObj</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> operator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">=(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">BigObj</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> other</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">noexcept</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> !=</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">other) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        delete[]</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> data_;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        data_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> other</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">data_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        length_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> other</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">length_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        other</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">data_</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> nullptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        other</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">length_</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> length_;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> data_;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">BigObj</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">){</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//RVO</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   BigObj </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //æ„é€ å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   BigObj o;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //æ„é€ å‡½æ•°</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    o </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">move</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(obj);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //ç§»åŠ¨èµ‹å€¼ï¼ˆå› ä¸ºoå·²ç»è¢«åˆ›å»ºäº†ï¼Œå› æ­¤è¿™é‡Œä¸æ˜¯æ‹·è´æ„é€ å‡½æ•°ï¼‰ï¼Œå°†objè½¬ä¸ºå³å€¼</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   }</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//ææ„oå¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   //{}è¡¨ç¤ºä¸€ä¸ªä½œç”¨åŸŸï¼Œç¦»å¼€è¿™ä¸ªä½œç”¨åŸŸoé©¬ä¸Šå°±ä¼šè¢«ææ„</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">   return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//ææ„ocjå¯¹è±¡</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="äºŒ-æ“ä½œç³»ç»Ÿ" tabindex="-1"><a class="header-anchor" href="#äºŒ-æ“ä½œç³»ç»Ÿ"><span>äºŒ. æ“ä½œç³»ç»Ÿ</span></a></h2><p>è¿™ä¸€å—çº¯å…«è‚¡ï¼ŒçŸ¥é“æ“ä½œç³»ç»Ÿè°ƒåº¦ç®—æ³•ã€è¿›ç¨‹çº¿ç¨‹å’Œè™šæ‹Ÿç‰©ç†åœ°å€å³å¯</p><h3 id="_16-ä¸ºä»€ä¹ˆè¦æœ‰è™šæ‹Ÿåœ°å€-ç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_16-ä¸ºä»€ä¹ˆè¦æœ‰è™šæ‹Ÿåœ°å€-ç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€çš„åŒºåˆ«"><span>16.ä¸ºä»€ä¹ˆè¦æœ‰è™šæ‹Ÿåœ°å€ï¼Ÿç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€çš„åŒºåˆ«ï¼Ÿ</span></a></h3><p>ä¸¾ä¸ªä¾‹å­è¯´æ˜ï¼š</p><p>æ¯”å¦‚ï¼Œå•ç‰‡æœºï¼Œå®ƒåªæœ‰ç‰©ç†åœ°å€æ²¡æœ‰è™šæ‹Ÿåœ°å€ï¼Œå› æ­¤å¦‚æœå•ç‰‡æœºä¸Šæœ‰ç¨‹åºï¼Œæˆ‘ç»§ç»­è¾“å…¥æ–°çš„ç¨‹åºå°±ä¼šæŠŠå°±ç¨‹åºç»™coveræ‰ã€‚å®ƒæ²¡æœ‰å†…å­˜æŠ½è±¡ç­‰çš„ä¿æŠ¤å› æ­¤ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Œå› æ­¤å‚¬ç”Ÿå‡ºæ¥è™šæ‹Ÿåœ°å€ã€‚</p><ol><li><strong>å†…å­˜æŠ½è±¡</strong>ï¼šè™šæ‹Ÿåœ°å€ä¸ºç¨‹åºæä¾›äº†ä¸€ä¸ª<strong>æŠ½è±¡çš„å†…å­˜ç¯å¢ƒ</strong>ï¼Œä½¿å¾—ç¨‹åºåœ¨è¿è¡Œæ—¶ä¸éœ€è¦è€ƒè™‘ç‰©ç†å†…å­˜åœ°å€ï¼›<strong>ç¨‹åºä½¿ç”¨çš„æ˜¯é€»è¾‘åœ°å€ï¼Œç”±æ“ä½œç³»ç»Ÿæ˜ å°„åˆ°ç‰©ç†åœ°å€</strong>ã€‚</li><li><strong>å†…å­˜ç©ºé—´æ‰©å±•</strong>ï¼šé€šè¿‡è™šæ‹Ÿåœ°å€æŠ€æœ¯ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥æä¾›æ¯”ç‰©ç†å†…å­˜æ›´å¤§çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼›è¿™ä½¿å¾—å¤šä¸ªç¨‹åºå¯ä»¥å¹¶è¡Œï¼Œæ¯ä¸ªç¨‹åºæ‹¥æœ‰ç‹¬å±äºè‡ªå·±çš„ä¸€å—å†…å­˜ã€‚</li><li><strong>å†…å­˜ä¿æŠ¤</strong>ï¼š<strong>ä¸åŒè¿›ç¨‹æ‹¥æœ‰ä¸åŒçš„è™šæ‹Ÿåœ°å€ç©ºé—´</strong>ï¼Œä¸€ä¸ªè¿›ç¨‹çš„ä»£ç å’Œæ•°æ®ä¸èƒ½è®¿é—®å¦ä¸€ä¸ªè¿›ç¨‹çš„ï¼Œç¡®ä¿äº†ç›¸äº’éš”ç¦»å’Œå®‰å…¨ã€‚</li><li><strong>å†…å­˜ç®¡ç†</strong>ï¼šæ“ä½œç³»ç»Ÿå¯ä»¥é€šè¿‡åˆ†é¡µ(page)æˆ–åˆ†æ®µ(Segmentation)æŠ€æœ¯æ¥åŠ¨æ€çš„å®ç°å†…å­˜çš„åˆ†é…å’Œå›æ”¶ï¼Œæå‡å†…å­˜åˆ©ç”¨ç‡ã€‚</li></ol><h3 id="_16-1-æ—¢ç„¶è™šæ‹Ÿå†…å­˜åœ°å€è¦æ¯”ç‰©ç†å†…å­˜ç©ºé—´è¦å¤§-é‚£å²‚ä¸æ˜¯ä¼šå‡ºç°ç‰©ç†å†…å­˜ä¸å¤Ÿç”¨çš„æƒ…å†µ-å¦‚ä½•è§£å†³" tabindex="-1"><a class="header-anchor" href="#_16-1-æ—¢ç„¶è™šæ‹Ÿå†…å­˜åœ°å€è¦æ¯”ç‰©ç†å†…å­˜ç©ºé—´è¦å¤§-é‚£å²‚ä¸æ˜¯ä¼šå‡ºç°ç‰©ç†å†…å­˜ä¸å¤Ÿç”¨çš„æƒ…å†µ-å¦‚ä½•è§£å†³"><span>16.1 æ—¢ç„¶è™šæ‹Ÿå†…å­˜åœ°å€è¦æ¯”ç‰©ç†å†…å­˜ç©ºé—´è¦å¤§ï¼Œé‚£å²‚ä¸æ˜¯ä¼šå‡ºç°ç‰©ç†å†…å­˜ä¸å¤Ÿç”¨çš„æƒ…å†µï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ</span></a></h3><p>å½“ç‰©ç†å†…å­˜ä¸è¶³æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šä½¿ç”¨**é¡µç½®æ¢ï¼ˆPage Replacementï¼‰**çš„æ–¹æ³•å°†ä¸€äº›ä¸å¸¸ç”¨çš„å†…å­˜ä»ç‰©ç†å†…å­˜ç§»åŠ¨åˆ°ç£ç›˜ä¸Šçš„äº¤æ¢åŒº (Swap) ä¸­ï¼Œè…¾å‡ºç©ºé—´ã€‚</p><p>å½“è¿™äº›é¡µå†æ¬¡è¢«è®¿é—®æ—¶ï¼Œä¼šå‘ç”Ÿç¼ºé¡µä¸­æ–­ (Page Fault)ï¼Œå†æŠŠå®ƒä»¬ä»ç£ç›˜åŠ è½½å›å†…å­˜ã€‚</p><p>å¸¸è§ç®—æ³•ï¼š</p><ul><li>FIFO (å…ˆè¿›å…ˆå‡º)ï¼šæœ€å…ˆè¿›å…¥å†…å­˜çš„é¡µæœ€å…ˆè¢«æ¢å‡ºï¼›</li><li><strong>LRU (æœ€è¿‘æœ€å°‘ä½¿ç”¨)</strong>ï¼šä¼˜å…ˆæ¢å‡ºæœ€é•¿æ—¶é—´æ²¡è¢«è®¿é—®çš„é¡µï¼ˆæ‰©å±•ï¼šå¤§æ¨¡å‹æ¨ç†é‡Œé¢æ¯”å¦‚è¯´kvcacheç­‰ä¹Ÿä¼šä½¿ç”¨LRUè¿›è¡Œç®¡ç†ï¼‰ï¼›</li><li>LFU (æœ€å°‘ä½¿ç”¨é¢‘ç‡)ï¼šä¼˜å…ˆæ¢å‡ºä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„é¡µã€‚</li></ul><p><strong>LRUçš„Leetcodeä¸€å®šè¦åšï¼Œè€ƒçš„æ¦‚ç‡å¾ˆå¤§</strong></p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;iostream&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;unordered_map&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;list&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">using</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> namespace</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> std</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> LRU</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> cap;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    unordered_map</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, pair</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, list&lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;::interator</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> cache;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //&lt;key, &lt;value, list-&gt;pointer&gt; &gt; å“ˆå¸Œè¡¨åˆ é™¤ï¼škeyï¼Œå¢åŠ ï¼š&lt;value, list-&gt;pointer&gt;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    list</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;int&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> l;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //&lt;key&gt;   liståˆ é™¤ï¼špointerï¼Œå¢åŠ ï¼škey</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    LRUcache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> capacity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">){</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cap</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> capacity;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">){</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">find</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">end</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()){</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> value </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[key].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">first</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            makeRecent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> value;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">){</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">find</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">!=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">end</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()){</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            list</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> pointer </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[key].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">second</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//liståˆ é™¤æ˜¯è¦åˆ é™¤å®ƒçš„pointerï¼Œè€Œä¸æ˜¯keyï¼Œä¸ä¸‹é¢çš„å“ˆå¸Œè¡¨ä¸åŒ</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            l</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">erase</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(pointer);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">l</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">){</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">erase</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">l</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">front</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //å“ˆå¸Œè¡¨çš„åˆ é™¤æ˜¯è¦åˆ é™¤keyï¼Œè€Œä¸æ˜¯value; è¿™é‡Œè¦åˆ é™¤çš„keyæ˜¯é“¾è¡¨å¤´éƒ¨çš„é‚£ä¸ªkeyå€¼è€Œä¸æ˜¯è¿™ä¸ªå‡½æ•°ä¼ è¿›æ¥çš„keyï¼ï¼ï¼ï¼ï¼</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                l</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">pop_front</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        l</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[key] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {value, </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">prev</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">l</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">end</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">())};</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> makeRecent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">){</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> value </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[key].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">first</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        list</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> pointer </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[key].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">second</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        l</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">erase</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(pointer);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        l</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        cache</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[key] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {value, </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">prev</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">l</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">end</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">())};</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_17-è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_17-è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«"><span>17. è¿›ç¨‹å’Œçº¿ç¨‹çš„åŒºåˆ«ï¼Ÿ</span></a></h3><p><strong>è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿèµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œçº¿ç¨‹æ˜¯CPUè°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚</strong></p><ul><li>è¿›ç¨‹æ¯ä¸ªè¿›ç¨‹æœ‰è‡ªå·±ç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€ä»£ç æ®µã€æ•°æ®æ®µå’Œå †æ ˆã€‚åˆ‡æ¢å¼€é”€å¤§ã€é€šä¿¡å¤æ‚ï¼Œä½†æ›´ç¨³å®šï¼Œé€‚åˆé«˜éš”ç¦»åœºæ™¯ï¼›</li><li>åŒä¸€è¿›ç¨‹å†…çš„çº¿ç¨‹å…±äº«è¿›ç¨‹çš„åœ°å€ç©ºé—´å’Œèµ„æºï¼Œä½†å„è‡ªæœ‰ç‹¬ç«‹çš„æ ˆå’Œå¯„å­˜å™¨ã€‚åˆ‡æ¢å¼€é”€å°ã€é€šä¿¡ç®€å•ï¼Œä½†å®¹æ˜“äº’ç›¸å½±å“ï¼Œé€‚åˆé«˜å¹¶å‘è®¡ç®—åœºæ™¯ã€‚</li></ul><h2 id="ä¸‰-ai-hpcåŸºç¡€" tabindex="-1"><a class="header-anchor" href="#ä¸‰-ai-hpcåŸºç¡€"><span>ä¸‰. AI-HPCåŸºç¡€</span></a></h2><h3 id="_18-fp32ã€fp16ã€bf16ä¸‰è€…åœ¨ieee754æ ‡å‡†ä¸‹çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_18-fp32ã€fp16ã€bf16ä¸‰è€…åœ¨ieee754æ ‡å‡†ä¸‹çš„åŒºåˆ«"><span>18. FP32ã€FP16ã€BF16ä¸‰è€…åœ¨IEEE754æ ‡å‡†ä¸‹çš„åŒºåˆ«ï¼Ÿ</span></a></h3><table><thead><tr><th>ç±»å‹</th><th>æ€»ä½æ•°</th><th>ç¬¦å·ä½</th><th>æŒ‡æ•°ä½</th><th>å°¾æ•°ä½</th><th>æŒ‡æ•°åç½®</th><th>èŒƒå›´</th><th>å…¸å‹åº”ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>FP32</td><td>32</td><td><strong>1</strong></td><td><strong>8</strong></td><td><strong>23</strong></td><td>127</td><td>~Â±3.4e38</td><td>é«˜ç²¾åº¦è®¡ç®—ã€è®­ç»ƒ</td></tr><tr><td>FP16</td><td>16</td><td><strong>1</strong></td><td><strong>5</strong></td><td><strong>10</strong></td><td>15</td><td>~Â±6.5e4</td><td>AIæ¨ç†ã€èŠ‚çœå†…å­˜</td></tr><tr><td>BF16</td><td>16</td><td><strong>1</strong></td><td><strong>8</strong></td><td><strong>7</strong></td><td>127</td><td>~Â±3.4e38</td><td>AIè®­ç»ƒã€å…¼é¡¾èŒƒå›´å’Œæ•ˆç‡</td></tr></tbody></table><h3 id="_19-fp16ä¸bf16çš„å¯¹æ¯”" tabindex="-1"><a class="header-anchor" href="#_19-fp16ä¸bf16çš„å¯¹æ¯”"><span>19. FP16ä¸BF16çš„å¯¹æ¯”ï¼Ÿ</span></a></h3><p>BF16æ›´é€‚åˆtrainingï¼Œå› ä¸ºæŒ‡æ•°ä½å®½ï¼ŒåŠ¨æ€èŒƒå›´å¤§ï¼Œ<strong>å‡å°‘æ¢¯åº¦çˆ†ç‚¸å’Œæ¢¯åº¦æ¶ˆå¤±</strong>ï¼Œæ›´æœ‰åˆ©äºbackwardï¼›</p><p>FP16æ›´é€‚åˆæ¨ç†ï¼Œæ¨ç†åªæœ‰forwardï¼Œä¸æ¶‰åŠbackwardï¼Œå› æ­¤ä¸è€ƒè™‘æ¢¯åº¦é—®é¢˜ï¼Œåªè€ƒè™‘ç²¾åº¦å³å¯ã€‚FP16<strong>å°¾æ•°ä½å¤šï¼Œå¯¹ç²¾åº¦æ›´å‹å¥½</strong></p><h3 id="_20-å†™å‡ºä»£ç è®¡ç®—1-1-2-1-3-1-4-1-n" tabindex="-1"><a class="header-anchor" href="#_20-å†™å‡ºä»£ç è®¡ç®—1-1-2-1-3-1-4-1-n"><span>20. å†™å‡ºä»£ç è®¡ç®—1+(1/2)+(1/3)+(1/4)+...+(1/n)</span></a></h3><p><a href="https://blog.csdn.net/xieyihua1994/article/details/106137932" target="_blank" rel="noopener noreferrer">float æ•°æ®ç±»å‹çš„ä¸€äº›å‘ï¼ˆå¤§æ•°åƒå°æ•°ï¼‰</a></p><p>é‡ç‚¹æå–ï¼š</p><ol><li>åœ¨æµ®ç‚¹æ•°è®¡ç®—å‰ï¼Œä¼šå…ˆå°†å…¶è½¬ä¸ºäºŒçº§åˆ¶çš„ç§‘å­¦è®¡æ•°ã€‚ep.(-1)^sign * 1.f * 2^e</li><li>æµ®ç‚¹æ•°åŠ æ³•éœ€è¦å…ˆå¯¹é½æŒ‡æ•°ä½å†ç›¸åŠ , ep.0.5+0.125 = (-1)^0 * <strong>1.0</strong> * 2^(-1) + (-1)^0 * <strong>0.01</strong> * 2^(-1) = (-1)^0 * <strong>1.01</strong> * 2^(-1)</li><li>å¤§æ•°åŠ å°æ•°æ—¶ï¼Œä¸ºäº†å¯¹é½æŒ‡æ•°ä½ï¼Œéœ€è¦å·¦ç§»åŠ¨1.fçš„å°æ•°ç‚¹ï¼Œå½“ç§»åŠ¨è¶…è¿‡23ä½æ—¶ï¼Œå°æ•°å˜æˆäº†0ï¼ˆä¾‹å¦‚ï¼š(-1)^0 * <strong>0.0</strong> * 2^(-1)ï¼‰ï¼Œå°±æ„å‘³ç€+çš„è¿™ä¸ªæ•°å°±æ˜¯0ã€‚æ­¤æ—¶ä¼šå‡ºç°<strong>å¤§æ•°åƒå°æ•°</strong>çš„æƒ…å†µï¼ˆä¾‹å¦‚ï¼š16777216 + 1 = 16777216ï¼‰</li></ol><p><strong>æ³¨æ„ï¼Œè¿™ç§æƒ…å†µåªå‡ºç°åœ¨æµ®ç‚¹æ•°è¿ç®—ä¸­ï¼Œæ•´æ•°è¿ç®—ä¸ä¼šå‡ºç°</strong></p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;iostream&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">using</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> namespace</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> std</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(){</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i, n;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //intè¡¨ç¤º32ä½çš„æ•´æ•°ï¼Œlong è¡¨ç¤ºæ›´å¤§ä½çš„æ•´æ•°ï¼Œlong longä¼šä¿è¯è‡³å°‘64ä½çš„æ•´æ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    double</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> sum;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    cin </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> n;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    sum </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0.0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> n; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">--</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">i){</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //è¿™é‡Œforé‡‡ç”¨--iè€Œä¸æ˜¯++iå°±æ˜¯ä¸ºäº†é˜²æ­¢å¤§æ•°åƒå°æ•°çš„æƒ…å†µå‘ç”Ÿ</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        sum </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1.0</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">i;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //è¿™é‡Œå¿…é¡»æ˜¯1.0ï¼Œä¸èƒ½æ˜¯1ï¼Œå› ä¸ºè¿™æ˜¯æµ®ç‚¹æ•°é™¤æ³•ä¸æ˜¯æ•´æ•°é™¤æ³•</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> sum </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> endl;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_21-int8å’Œfp8åœ¨ieee754æ ‡å‡†ä¸‹çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_21-int8å’Œfp8åœ¨ieee754æ ‡å‡†ä¸‹çš„åŒºåˆ«"><span>21. INT8å’ŒFP8åœ¨IEEE754æ ‡å‡†ä¸‹çš„åŒºåˆ«ï¼Ÿ</span></a></h3><table><thead><tr><th>ç±»å‹</th><th>æ€»ä½æ•°</th><th>ç¬¦å·ä½</th><th>æŒ‡æ•°ä½</th><th>å°¾æ•°ä½</th><th>å…¸å‹åº”ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>INT8</td><td>8</td><td>1</td><td>0</td><td>7</td><td>é‡åŒ–æ¨ç†ã€å­˜å‚¨èŠ‚çœã€åµŒå…¥å¼è®¡ç®—</td></tr><tr><td>FP8</td><td>8</td><td>1</td><td>4 æˆ– 5</td><td>3 æˆ– 2</td><td>AI æ¨ç†åŠ é€Ÿã€ä½ç²¾åº¦è®­ç»ƒï¼ˆEdge TPU / GPU TensorCoreï¼‰</td></tr></tbody></table><h3 id="_22-int8å’Œfp8çš„ä¼˜åŠ£åŠ¿å¯¹æ¯”" tabindex="-1"><a class="header-anchor" href="#_22-int8å’Œfp8çš„ä¼˜åŠ£åŠ¿å¯¹æ¯”"><span>22. INT8å’ŒFP8çš„ä¼˜åŠ£åŠ¿å¯¹æ¯”</span></a></h3><ol><li><p>äºŒè€…éƒ½æ˜¯ä¸ºæ¨¡å‹é‡åŒ–è€Œç”Ÿï¼Œfp8ç›¸å¯¹äºint8åœ¨ç²¾åº¦ä¸Šé¢ä¸å…·æœ‰ç†è®ºä¼˜åŠ¿ï¼Œå› ä¸º<strong>int8ä¸ºå‡åŒ€æ•°æ®ç±»å‹</strong>ï¼Œåœ¨å€¼åŸŸå†…éƒ½æ˜¯å‡åŒ€çš„ï¼Œæ•°å’Œæ•°ä¹‹é—´é—´éš”ä¸º1ï¼Œä½†<strong>fp8ä¸æ˜¯å‡åŒ€æ•°æ®ç±»å‹</strong>ï¼Œæ•°ä¸æ•°ä¹‹é—´é—´éš”ä¸å®šï¼Œä½†æ˜¯ä¸ªæ•°ä¸€å®šä¸º3ä¸ªï¼Œè¿™ä¹Ÿå¯¼è‡´äº†åœ¨æ•°<strong>å€¼å°çš„èŒƒå›´é‡Œé¢ï¼Œfp8çš„ç²¾åº¦ä¼˜äºint8ï¼Œä½†æ˜¯åœ¨æ•°å€¼åå¤§çš„èŒƒå›´é‡Œé¢ï¼Œint8ç²¾åº¦ä¼˜äºfp8</strong>ã€‚</p></li><li><p><strong>fp8å¯ä»¥ç”¨æ¥åšæ¨¡å‹è®­ç»ƒ</strong>ï¼ˆä¾‹å¦‚Deepseekå°±ä½¿ç”¨fp8ç²¾åº¦åšçš„è®­ç»ƒï¼‰ï¼Œå¹¶ä¸”fp8è®­ç»ƒçš„æ¨¡å‹å¯ä»¥<strong>ç›´æ¥ä½¿ç”¨fp8è¿›è¡Œæ¨ç†</strong>ã€‚<strong>Int8ä¸èƒ½ç”¨ä½œæ¨ç†</strong>å› ä¸ºå€¼åŸŸé‡Œé¢å…¨æ˜¯æ•´æ•°ï¼Œæ²¡æ³•æ±‚å¯¼ï¼Œä»è€Œæ²¡æ³•è®¡ç®—æ¢¯åº¦ã€‚</p></li><li><p>fp8é‡åŒ–ç†è®ºä¸Šç›¸å¯¹int8ä¸éœ€è¦æ ¡å‡†(calibration)ï¼Œç›´æ¥è®¾ç½®input scaleå’Œoutput scaleä¸º1å³å¯é‡åŒ–ï¼Œï¼ˆæ³¨æ„ï¼šå®é™…ä¸Šå¤šæ•°fp8é‡åŒ–é¡¹ç›®è¿˜æ˜¯åšäº†calibrationï¼‰ï¼Œint8éœ€è¦calibration</p></li></ol><h3 id="_23-attentionåŒ…å«å“ªäº›ç®—å­-ä½¿ç”¨pytorchæ­å»ºä¸€ä¸‹ã€‚" tabindex="-1"><a class="header-anchor" href="#_23-attentionåŒ…å«å“ªäº›ç®—å­-ä½¿ç”¨pytorchæ­å»ºä¸€ä¸‹ã€‚"><span>23. AttentionåŒ…å«å“ªäº›ç®—å­ï¼Ÿä½¿ç”¨pytorchæ­å»ºä¸€ä¸‹ã€‚</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> torch</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> torch.nn </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nn</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> torch.nn.functional </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> F</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> SimpleAttention</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">nn</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Module</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    ## d_modelè¡¨ç¤ºhidden size, d_headè¡¨ç¤ºhead num</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    ## å•å¤´æ³¨æ„åŠ›ï¼šhiddensize = head num;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    ## å¤šå¤´æ³¨æ„åŠ›ï¼šhiddensize = head num * headsize;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    def</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> __init__</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> d_model</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> d_head</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">        super</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">__init__</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.d_head </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> d_head</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.W_q </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nn.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">Linear</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(d_model, d_head) </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">##å°†è¾“å…¥çš„hiddensizeç»´åº¦è½¬ä¸ºheadnumç»´åº¦ï¼Œè¿›è¡ŒAttentionè®¡ç®—</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.W_k </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nn.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">Linear</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(d_model, d_head) </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">##nn.Linear(è¾“å…¥ç»´åº¦, è¾“å‡ºç»´åº¦, bias=Trueé»˜è®¤)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.W_v </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nn.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">Linear</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(d_model, d_head)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.W_o </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nn.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">Linear</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(d_head, d_model) </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">##Attentionè®¡ç®—åçš„ç»“æœï¼ˆç»´åº¦ä¸º d_headï¼‰æ˜ å°„å›åŸå§‹æ¨¡å‹ç»´åº¦ d_model</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    def</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> forward</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        x:    [bs, seq_len, d_model]</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        mask: [seq_len, seq_len] æ³¨æ„åŠ›åˆ†æ•°æ˜¯ä¸€ä¸ª seq*seq çš„çŸ©é˜µï¼Œå› æ­¤æ©ç çŸ©é˜µè¦å’Œå®ƒshapeä¸€è‡´</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        &quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        bs, seq_len, _ </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> x.shape</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        ## QKV linear</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        Q </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">W_q</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(x)  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#[bs, seq_len, d_model] -&gt; [bs, seq_len, d_head]</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        K </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">W_k</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(x)  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#[bs, seq_len, d_model] -&gt; [bs, seq_len, d_head]</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        V </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">W_v</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(x)  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#[bs, seq_len, d_model] -&gt; [bs, seq_len, d_head]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        ## RoPE</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        Q, K </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;"> apply_rope</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(Q, K, cos, sin)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        ## Q*(K^T) / sqrt(d_head)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        attn_socres </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> torch.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">matmul</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(Q, K.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">transpose</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">/</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.d_head </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">**</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0.5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#[bs, seq_len, seq_len]</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            # -2 -1è¡¨ç¤ºKçš„å€’æ•°ç¬¬ä¸€å’Œç¬¬äºŒç»´åº¦ä¹Ÿå°±æ˜¯[seq_len, d_head],transposeä¸º[d_head, seq_len]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        ## Mask</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> mask </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">is</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> not</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> None</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            attn_socres </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> attn_socres.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">masked_fill</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(causal_mask </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">float</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;-inf&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#[bs, seq_len, seq_len]</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            # causal_maskçŸ©é˜µshapeä¸attn_socresä¸€æ ·ï¼Œéœ€è¦æ©ç çš„åœ°æ–¹å€¼ä¸º0ï¼Œä¸éœ€è¦çš„åœ°æ–¹å€¼ä¸º1</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            # masked_fillå‡½æ•°æ˜¯å°†attn_socresçŸ©é˜µä¸­å’Œcausal_maskçŸ©é˜µä¸º0çš„ä½ç½®ç›¸åŒçš„ä½ç½® å°†å…¶å€¼ç½®ä¸º-inf</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            # softmaxä¼šå°†-infçš„å€¼çš„æ¦‚ç‡ç®—ä¸º0ï¼ˆè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆMaskè¦æ”¾åœ¨Softmaxå‰é¢çš„åŸå› ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        ## Softmax</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        attn_weights </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> torch.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">softmax</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(attn_socres, </span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">dim</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#[bs, seq_len, seq_len]</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            # dim=-1è¡¨ç¤ºå¯¹æœ€åä¸€ä¸ªç»´åº¦è¿›è¡Œsoftmaxï¼Œæ¯ä¸€è¡Œï¼ˆæ¯”å¦‚ç¬¬ i è¡Œï¼‰è¡¨ç¤ºï¼šç¬¬iä¸ªtokenå¯¹æ‰€æœ‰å…¶ä»–tokençš„åŸå§‹æ³¨æ„åŠ›åˆ†æ•°</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            # æ‰€ä»¥è¦åœ¨æ¯è¡Œå†…éƒ¨åš softmax â€”â€” ä¹Ÿå°±æ˜¯åœ¨æœ€åä¸€ä¸ªç»´åº¦ï¼ˆåˆ—æ–¹å‘ï¼‰ä¸Šæ“ä½œã€‚</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        ## O = attn_weights * V</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        output </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> torch.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">matmul</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(attn_weights, V) </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#[bs, seq_len, d_head]</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        output </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">W_o</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(output) </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#[bs, seq_len, d_model]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> output</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># ======================</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># ======================</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> __name__</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;__main__&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    d_model </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 128</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    d_head </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 64</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    seq_len </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 8</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    bs </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    model </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;"> SimpleAttention</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(d_model, d_head)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    x </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> torch.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">rand</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(bs, seq_len, d_model)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    out </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;"> model</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(x)</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;è¾“å…¥å½¢çŠ¶:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, x.shape)</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;è¾“å‡ºå½¢çŠ¶:&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, out.shape)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å››-x86cpuä½“ç³»ç»“æ„" tabindex="-1"><a class="header-anchor" href="#å››-x86cpuä½“ç³»ç»“æ„"><span>å››. X86CPUä½“ç³»ç»“æ„</span></a></h2><p>CPUçš„è¿™äº›é—®é¢˜é—®åˆ°çš„æ¦‚ç‡æ¯”è¾ƒå°ï¼Œå¯èƒ½åªæœ‰ä¸€äº›åšç«¯ä¾§ARMæ¶æ„çš„å…¬å¸é—®é—®ã€‚</p><h3 id="_24-cpuä¸Šæœ‰å“ªäº›å¹¶è¡Œç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#_24-cpuä¸Šæœ‰å“ªäº›å¹¶è¡Œç­–ç•¥"><span>24. CPUä¸Šæœ‰å“ªäº›å¹¶è¡Œç­–ç•¥ï¼Ÿ</span></a></h3><ol><li>æŒ‡ä»¤çº§åˆ«å¹¶è¡Œï¼šæµæ°´çº¿ã€è¶…æ ‡é‡</li><li>çº¿ç¨‹çº§å¹¶è¡Œï¼šè¶…çº¿ç¨‹ã€å¤šæ ¸å¤šçº¿ç¨‹openMP</li><li>æ•°æ®çº§å¹¶è¡Œï¼šå¦‚SIMDå•æŒ‡ä»¤å¤šæ•°æ®ã€å‘é‡åŒ–</li></ol><h3 id="_25-cpuå’Œgpuæ¶æ„çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_25-cpuå’Œgpuæ¶æ„çš„åŒºåˆ«"><span>25. CPUå’ŒGPUæ¶æ„çš„åŒºåˆ«ï¼Ÿ</span></a></h3><p>ä¸»è¦é’ˆå¯¹ä»¥ä¸‹å‡ ç‚¹å›ç­”å³å¯ï¼š</p><ol><li>æ ¸å¿ƒæ•°é‡ï¼šCPUæ ¸å¿ƒæ•°é‡å°‘ï¼ŒGPUæ ¸å¿ƒæ•°é‡å¤šï¼ˆGPUè¿˜æœ‰å¾ˆå¤šä¸“æœ‰çš„è®¡ç®—æ ¸å¿ƒæ¯”å¦‚TensorCoreï¼‰</li><li>å¹¶è¡Œç­–ç•¥ï¼šCPUä»¥24.é¢˜ä¸­ä¸‰å¤§å¹¶è¡Œç­–ç•¥ä¸ºä¸»ï¼ŒGPUåˆ™åªä»¥çº¿ç¨‹çº§å¹¶è¡Œä¸ºä¸»</li><li>ç‰‡ä¸Šå†…å­˜ï¼šCPUçš„ä¸‰çº§cacheå å¾ˆå¤§æ¯”ä¾‹ï¼ŒGPUçš„ç‰‡ä¸Šå†…å­˜åˆ™æ¯”è¾ƒå°</li><li>å¸¦å®½ï¼šCPUçš„å†…å­˜å¸¦å®½æ¯”è¾ƒå°ï¼ˆDDR5ï¼‰ï¼ŒGPUçš„å†…å­˜å¸¦å®½æ¯”è¾ƒå¤§ï¼ˆHBMï¼‰</li><li>CPUä»¥æ§åˆ¶å¯†é›†å‹ä»»åŠ¡ä¸ºä¸»ï¼ŒGPUä»¥è®¡ç®—å¯†é›†å‹ä»»åŠ¡ä¸ºä¸»</li><li>CPUæ˜¯ä»¥ä½å»¶è¿Ÿä¸ºä¸­å¿ƒçš„ï¼ŒGPUæ˜¯ä»¥é«˜ååé‡ä¸ºä¸­å¿ƒçš„</li></ol><h3 id="_26-cpuæ˜¯å¦‚ä½•ä½“ç°è‡ªå·±æ˜¯ä»¥ä½å»¶è¿Ÿä¸ºä¸­å¿ƒçš„" tabindex="-1"><a class="header-anchor" href="#_26-cpuæ˜¯å¦‚ä½•ä½“ç°è‡ªå·±æ˜¯ä»¥ä½å»¶è¿Ÿä¸ºä¸­å¿ƒçš„"><span>26. CPUæ˜¯å¦‚ä½•ä½“ç°è‡ªå·±æ˜¯ä»¥ä½å»¶è¿Ÿä¸ºä¸­å¿ƒçš„ï¼Ÿ</span></a></h3><ol><li><strong>æµæ°´çº¿</strong>ï¼šæ¶ˆé™¤æŒ‡ä»¤é—´ä¾èµ–å…³ç³»ï¼Œä½¿å¾—æŒ‡ä»¤ä¸æŒ‡ä»¤é—´å¯ä»¥overlapï¼Œä»è€Œå‡å°‘æŒ‡ä»¤æ‰§è¡Œçš„å»¶è¿Ÿï¼›</li><li><strong>åˆ†æ”¯é¢„æµ‹</strong>ï¼šè·³è¿‡if elseåˆ¤æ–­è¯­å¥ï¼Œæ ¹æ®é¢„æµ‹ç»“æœç›´æ¥æ‰§è¡Œif body æˆ–è€…else bodyï¼›</li><li><strong>é¢„å–</strong>ï¼šé¢„å…ˆåŠ è½½æŒ‡ä»¤å’Œæ•°æ®åˆ°cacheä¸­ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´ï¼›</li><li><strong>æŒ‡ä»¤èåˆ</strong>:ä¾‹å¦‚å°†mulå’Œaddèåˆæˆä¸€ä¸ªæŒ‡ä»¤fma(fused multiply-add)ï¼Œfmaçš„å»¶è¿Ÿè¦å°äºmulä¸addçš„å»¶è¿Ÿä¹‹å’Œ</li><li>é¢ç§¯è¶…å¤§çš„L1 ã€L2 ã€L3 cacheï¼Œå¯ä»¥ç¼“å­˜æ›´å¤šçš„æŒ‡ä»¤å’Œæ•°æ®ï¼Œå‡å°‘å†…å­˜è®¿é—®çš„å»¶è¿Ÿï¼›</li><li><strong>ä¹±åºæ‰§è¡Œ</strong>ï¼šæ ¹æ®æŒ‡ä»¤çš„ä¾èµ–å…³ç³»ï¼Œä¹±åºæ‰§è¡ŒæŒ‡ä»¤ï¼Œä»è€Œæé«˜æŒ‡ä»¤çš„å¹¶è¡Œåº¦ï¼›ä»¥ä¸‹é¢ä»£ç ä¸ºä¾‹</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1.</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> MUL R9, R10, R11  ; R9 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> R10 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> R11</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2.</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> MUL R12, R9, R11  ; R12 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> R9 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> R11</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3.</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ADD R13, R10, R11  ; R13 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> R10 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> R11</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4.</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ADD R13, R10, R11  ; R14 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> R9 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> R11</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//CPUä¼šè¯†åˆ«åˆ°1.2.ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå®ƒå¯èƒ½ä¼šå…ˆæ‰§è¡Œ3.ï¼ˆä¹±åºæ‰§è¡Œï¼‰</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//CPUè¯†åˆ«åˆ°4.æ˜¯ä¸€ä¸ªR10å’ŒR11çš„ä¹˜æ³•+R9çš„åŠ æ³•ï¼Œå®ƒå¯èƒ½ä¼šè¿›è¡Œèåˆä¸ºfmaï¼ˆæŒ‡ä»¤èåˆï¼‰</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_27-cpuçš„å­˜å‚¨å±‚æ¬¡æ¶æ„æ˜¯æ€æ ·çš„-å®ƒä»¬çš„é€Ÿåº¦ã€å®¹é‡å¦‚ä½•" tabindex="-1"><a class="header-anchor" href="#_27-cpuçš„å­˜å‚¨å±‚æ¬¡æ¶æ„æ˜¯æ€æ ·çš„-å®ƒä»¬çš„é€Ÿåº¦ã€å®¹é‡å¦‚ä½•"><span>27. CPUçš„å­˜å‚¨å±‚æ¬¡æ¶æ„æ˜¯æ€æ ·çš„ï¼Ÿå®ƒä»¬çš„é€Ÿåº¦ã€å®¹é‡å¦‚ä½•ï¼Ÿ</span></a></h3><p>ç»“æ„ç”±å¤–åˆ°å†…æ˜¯ï¼šå†…å­˜-&gt;L3 cache-&gt;L2 cache-&gt;L1 cache-&gt;å¯„å­˜å™¨</p><p>é€Ÿåº¦ï¼šç”±å¤–åˆ°å†…å˜å¿«</p><p>å®¹é‡ï¼šç”±å¤–åˆ°å†…å˜å°</p><h3 id="_28-cpu-cacheçš„ä¸‰ç§ç»„ç»‡ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_28-cpu-cacheçš„ä¸‰ç§ç»„ç»‡ç»“æ„"><span>28. CPU cacheçš„ä¸‰ç§ç»„ç»‡ç»“æ„ï¼Ÿ</span></a></h3><ol><li>ç›´æ¥æ˜ å°„ï¼šæ¯ä¸ªä¸»å­˜å—åªèƒ½æ˜ å°„åˆ° cache ä¸­å”¯ä¸€çš„ä¸€ä¸ªä½ç½®ã€‚ç»“æ„ç®€å•ï¼ŒæŸ¥æ‰¾å¿«ã€‚ä½†å†²çªç‡é«˜ï¼Œä¸åŒçš„å†…å­˜å—å¯èƒ½ç«äº‰åŒä¸€ä¸ª cache è¡Œã€‚</li><li>å…¨ç›¸è”ï¼šä¸»å­˜ä¸­çš„ä»»æ„å—å¯ä»¥æ”¾åˆ° cache çš„ä»»æ„ä½ç½®ã€‚å†²çªç‡æœ€ä½ï¼Œå‘½ä¸­ç‡é«˜ã€‚ä½†ç¡¬ä»¶å¼€é”€å¤§ï¼ŒæŸ¥æ‰¾æ…¢ã€‚</li><li>ç»„ç›¸è”ï¼šæŠ˜ä¸­æ–¹æ¡ˆï¼ŒæŠŠ cache åˆ†æˆè‹¥å¹²ç»„ï¼Œæ¯ç»„å†…æœ‰å¤šè¡Œï¼ˆç§°ä¸ºâ€œè·¯â€ï¼‰ã€‚ä¸»å­˜å—å…ˆé€šè¿‡ æ¨¡è¿ç®—å®šä½åˆ°æŸä¸€ç»„ï¼Œå†åœ¨ç»„å†…â€œå…¨ç›¸è”â€æŸ¥æ‰¾ã€‚</li></ol><p><strong>ç›´æ¥æ˜ å°„ã€å…¨ç›¸è”å’Œç»„ç›¸è”ã€‚ç›´æ¥æ˜ å°„ç®€å•ä½†å†²çªå¤šï¼›å…¨ç›¸è”å‘½ä¸­ç‡é«˜ä½†ç¡¬ä»¶å¤æ‚ï¼›ç»„ç›¸è”æ˜¯æŠ˜ä¸­æ–¹æ¡ˆï¼Œç°ä»£ CPU å¤§å¤šé‡‡ç”¨ç»„ç›¸è”ç»“æ„ã€‚</strong></p><h3 id="_29-cpuä¼˜åŒ–è®¿å­˜çš„æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#_29-cpuä¼˜åŒ–è®¿å­˜çš„æ–¹æ³•"><span>29. CPUä¼˜åŒ–è®¿å­˜çš„æ–¹æ³•ï¼Ÿ</span></a></h3><ul><li>ä¸‰çº§cacheï¼ˆç»å¸¸è¯»å–çš„æ•°æ®å°±æ”¾åœ¨L1 cacheä¸­ï¼‰</li><li>é¢„è¯»å–ï¼šå–æœªæ¥å¯èƒ½ä¼šç”¨åˆ°çš„æ•°æ®åˆ°cacheä¸Šã€‚GPUéœ€è¦é€šè¿‡è½¯ä»¶çš„æ‰‹æ®µå®ç°prefetchï¼Œä½†cpuæœ‰ä¸“é—¨çš„ç¡¬ä»¶å•å…ƒæ¥å®ç°prefetchï¼ˆä½†æ˜¯è¿™ä¸ªæˆ‘ä»¬æ— æ³•æ§åˆ¶ï¼Œè¿™æ˜¯cpuçš„æœºå¯†ï¼‰</li><li>è®¿å­˜è¿ç»­ï¼ˆè®¿å­˜ä¸è¿ç»­æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´cache missï¼Œå°±åªèƒ½ä»å†…å­˜ä¸Šè¯»äº†ï¼Œæ€§èƒ½ä¸‹é™ï¼‰</li></ul><p>CPUåªè¦ä¿è¯è®¿å­˜è¿ç»­å°±å¥½ï¼Œä¸éœ€è¦åƒGPUä¸€æ ·è¿˜å¾—è€ƒè™‘é‚£äº›bank conflicté‚£äº›çš„ã€‚</p><h3 id="_30-ä»¥ä¸‹ä»£ç ä½ è§‰å¾—å­˜åœ¨å“ªäº›é—®é¢˜-è¯¥å¦‚ä½•ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_30-ä»¥ä¸‹ä»£ç ä½ è§‰å¾—å­˜åœ¨å“ªäº›é—®é¢˜-è¯¥å¦‚ä½•ä¼˜åŒ–"><span>30. ä»¥ä¸‹ä»£ç ä½ è§‰å¾—å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿè¯¥å¦‚ä½•ä¼˜åŒ–ï¼Ÿ</span></a></h3><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">std::</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">vector</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">N</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1.0</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">f</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> acc </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0.0</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">f</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N; i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //åªèƒ½ä¸²è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    acc </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //é—®é¢˜åœ¨è¿™é‡Œï¼Œi=1çš„è®¡ç®—å¿…é¡»è¦ç­‰å¾…i=0çš„è®¡ç®—å®Œæˆï¼ŒåŒç†i=2...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//ä¼˜åŒ–åï¼ˆç›¸æ¯”ä¸Šé¢ä¼˜åŒ–å‰ï¼Œç†è®ºæ˜¯å¿«åå€ï¼Œå®é™…å¤§æ¦‚å¿«8ã€9å€å·¦å³ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//=&gt;CSAPP ç¬¬äº”ç« </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">std::</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">vector</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">N</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1.0</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">f</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> acc0 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0.0</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">f</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //å…ˆå®šä¹‰10ä¸ªå˜é‡</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> acc1 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0.0</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">f</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> acc2 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0.0</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">f</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> acc3 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0.0</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">f</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,...</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N; i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //æ¯åä¸ªè¿­ä»£è¿›è¡Œå±•å¼€ï¼Œåä¸ªåŠ æ³•å¹¶è¡Œèµ·æ¥ï¼ˆè¶…æ ‡é‡ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      acc0 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      acc1 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //æ­¤æ—¶acc1ä¸ä¾èµ–acc0</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      acc2 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      acc3 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> in</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å‡è®¾åŠ æ³•å»¶è¿Ÿæ˜¯äº”ä¸ªå‘¨æœŸï¼ˆå‡è®¾åŠ æ³•å‘å°„ç«¯å£æœ‰ä¸¤ä¸ªï¼Œ0å’Œ1ï¼‰ï¼Œç»˜åˆ¶ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><figure><img src="/Notes/assets/img/30.58785ea1.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>åœ¨ç¬¬ä¸€ä¸ªå‘¨æœŸçš„æ—¶å€™ï¼Œä¸¤ä¸ªç«¯å£ä¼šå‘å°„ä¸¤æ¡åŠ æ³•æŒ‡ä»¤ï¼Œåˆ†åˆ«æ˜¯acc0 += in[0]å’Œacc1 += in[1]ï¼Œåœ¨ç¬¬äºŒä¸ªå‘¨æœŸçš„æ—¶å€™ï¼Œä¸¤ä¸ªç«¯å£ä¼šå‘å°„ä¸¤æ¡åŠ æ³•æŒ‡ä»¤ï¼Œåˆ†åˆ«æ˜¯acc2 += in[2]å’Œacc3 += in[3]ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><p>ç¬¬äºŒã€ä¸‰ã€å››å‘¨æœŸæ¯ä¸ªå‘¨æœŸåŒæ ·å‘å°„ä¸¤æ¡æŒ‡ä»¤ã€‚</p><p>åœ¨ç¬¬äº”ä¸ªå‘¨æœŸï¼Œæœ€å…ˆå‘å°„çš„ä¸¤ä¸ªæŒ‡ä»¤å°±æ‰§è¡Œå®Œæˆäº†ï¼Œæ­¤æ—¶æŒ‡ä»¤å¹¶è¡Œæ•°é‡ä¸ºæœ€å¤§2 * 5 = 10æ¡ã€‚<br> ä¹Ÿæ˜¯<strong>ä»ç¬¬äº”ä¸ªå‘¨æœŸå¼€å§‹ï¼Œï¼ˆå¦‚æœä¹‹åç»§ç»­å‘å°„æŒ‡ä»¤ä¸åœæ­¢çš„è¯ï¼‰cpuçš„åŠ æ³•ç®—åŠ›ä»ç¬¬äº”ä¸ªå‘¨æœŸèµ·å°±æ‰“æ»¡äº†</strong>ã€‚</p><h3 id="_31-cpuã€gpuçš„å³°å€¼ç®—åŠ›å¦‚ä½•è®¡ç®—" tabindex="-1"><a class="header-anchor" href="#_31-cpuã€gpuçš„å³°å€¼ç®—åŠ›å¦‚ä½•è®¡ç®—"><span>31. CPUã€GPUçš„å³°å€¼ç®—åŠ›å¦‚ä½•è®¡ç®—ï¼Ÿ</span></a></h3><p>CPUï¼š</p><p><strong>å• CPU ç®—åŠ› = CPU æ ¸æ•° * å•æ ¸ä¸»é¢‘ * æ¯å‘¨æœŸè®¡ç®—æ“ä½œæ•°</strong></p><p>GPUï¼šï¼ˆä»¥A100ä¸ºä¾‹ï¼‰</p><figure><img src="/Notes/assets/img/31_1.67a28328.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>1.A100 <strong>fp16</strong> GPU CUDA coreç®—åŠ› = <strong>CUDA coreä¸ªæ•° * GPUé¢‘ç‡ * å•ä¸ªcuda coreæ¯å‘¨æœŸè®¡ç®—æ“ä½œæ•°</strong> = [108ï¼ˆSMæ•°é‡ï¼‰ * 256ï¼ˆæ¯SMçš„fp16æŒ‡ä»¤ååï¼‰]* [1.41 * e9 ï¼ˆæ¯ç§’å‘¨æœŸæ•°ï¼‰] * [2ï¼ˆä¹˜åŠ )]= 78TFLOPS</p><p>2.A100 fp32 GPU CUDA coreç®—åŠ› = CUDA coreä¸ªæ•° * GPUé¢‘ç‡ * å•ä¸ªcuda coreæ¯å‘¨æœŸè®¡ç®—æ“ä½œæ•° = [108ï¼ˆSMæ•°é‡ï¼‰ * 64ï¼ˆæ¯SMçš„fp32æŒ‡ä»¤åå)] * [1.41 * e9] * [2ï¼ˆä¹˜åŠ )] = 19.5TFLOPS</p><p>3.A100 fp16 GPU tensor coreç®—åŠ› = tensor coreä¸ªæ•° * GPUé¢‘ç‡ * å•ä¸ªtensor coreæ¯å‘¨æœŸè®¡ç®—æ“ä½œæ•° = [108ï¼ˆSMæ•°é‡ï¼‰* 4ï¼ˆtensorcoreæ•°é‡æ¯SMï¼‰] * [1.41 * e9] * [256ï¼ˆæŒ‡ä»¤/å‘¨æœŸï¼‰ * 2ï¼ˆä¹˜åŠ )] = 312TFLOPS</p><figure><img src="/Notes/assets/img/31_3.9d7169a4.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_32-cpuæµæ°´çº¿çº§æ•°æ˜¯å¦è¶Šå¤šè¶Šå¥½" tabindex="-1"><a class="header-anchor" href="#_32-cpuæµæ°´çº¿çº§æ•°æ˜¯å¦è¶Šå¤šè¶Šå¥½"><span>32. CPUæµæ°´çº¿çº§æ•°æ˜¯å¦è¶Šå¤šè¶Šå¥½ï¼Ÿ</span></a></h3><p>ä¸æ˜¯ï¼Œçº§æ•°è¿‡å¤šä¼šé€ æˆä»¥ä¸‹é—®é¢˜ï¼š</p><ol><li>çº§ä¸çº§ä¹‹é—´çš„ç´§å‡‘ç¨‹åº¦å¾ˆéš¾æ§åˆ¶ï¼Œè¿™ä¼šé€ æˆçº§ä¸çº§é—´çš„ç©ºéš™ï¼Œä¿—ç§°æµæ°´çº¿æ°”æ³¡(bubble)</li><li>æ¯ä¸€çº§éƒ½éœ€è¦ç‹¬ç«‹çš„ç”µè·¯å•å…ƒï¼ˆä¾‹å¦‚30.é¢˜ä¸­çš„ä¸åŒé¢œè‰²å¯¹åº”äºä¸åŒçš„ç‹¬ç«‹ç”µè·¯å•å…ƒï¼‰ï¼Œè¿™ä¼šæå¤§å¢å¤§èŠ¯ç‰‡é¢ç§¯ï¼Œæ—¶åºç”µè·¯ä¹Ÿä¼šéš¾ä»¥è®¾è®¡</li><li>å¯¹compilerçš„è¦æ±‚ä¹Ÿä¼šå¢é«˜ï¼Œå› ä¸ºéœ€è¦compilerç”Ÿæˆæ›´é«˜è´¨é‡çš„ä»£ç ä»¥å‡å°æµæ°´çº¿æ°”æ³¡</li><li>å¦‚æœä¸ç”¨compilerï¼Œè‡ªå·±æ‰‹åŠ¨æ’å¸ƒæµæ°´çº¿ï¼Œé‚£ä¹ˆè¿™ä¸ªæ’å¸ƒçš„éš¾åº¦ä¹Ÿæ˜¯æå¤§çš„ã€‚</li></ol><h2 id="äº”-gpuä½“ç³»ç»“æ„ä¸cudaç¼–ç¨‹" tabindex="-1"><a class="header-anchor" href="#äº”-gpuä½“ç³»ç»“æ„ä¸cudaç¼–ç¨‹"><span>äº”. GPUä½“ç³»ç»“æ„ä¸CUDAç¼–ç¨‹</span></a></h2><h3 id="_33-ç»™ä¸€ä¸ªcuda-kernelå¦‚ä½•åˆ†é…blockå’Œthreadæ•°-å¦‚ä½•å–åˆ°æœ€ä¼˜çš„blockå’Œthreadæ•°" tabindex="-1"><a class="header-anchor" href="#_33-ç»™ä¸€ä¸ªcuda-kernelå¦‚ä½•åˆ†é…blockå’Œthreadæ•°-å¦‚ä½•å–åˆ°æœ€ä¼˜çš„blockå’Œthreadæ•°"><span>33. ç»™ä¸€ä¸ªCUDA kernelå¦‚ä½•åˆ†é…blockå’Œthreadæ•°ï¼Ÿå¦‚ä½•å–åˆ°æœ€ä¼˜çš„blockå’Œthreadæ•°ï¼Ÿ</span></a></h3><figure><img src="/Notes/assets/img/33.530d0bd4.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>æœ€ä¼˜çš„blockæ•°é‡å’Œthreadæ•°é‡å¾ˆéš¾ä¸€æ¬¡æ€§ç¡®å®šï¼Œä¸€èˆ¬éœ€è¦å€ŸåŠ©Nsight computeæ¥åˆ†æoccupancy</p><p>ä»¥ä¸‹æ˜¯ä¸€äº›å®æˆ˜ç»éªŒï¼š</p><p>å¯ä»¥<strong>å…ˆæ ¹æ®æ•°æ®çš„shapeå°†blockå’Œthreadæ•°åˆ†é…åˆ°ä¸€ä¸ªå¥½å†™ä»£ç çš„ç¨‹åº¦</strong>ï¼Œä¾‹å¦‚æ•°æ®æ˜¯[1024*1024]ï¼Œé‚£æˆ‘å°±å¯ä»¥åˆ†é…1024ä¸ªblockå¤„ç†1024è¡Œï¼Œ256/512/1024ä¸ªthreadå¤„ç†ä¸€åˆ—ï¼Œè¿™æ ·å†™ä»£ç ä¼šéå¸¸æ–¹ä¾¿ã€‚ï¼ˆè‡³äºè¿™ä¸‰ä¸ªthreadå…·ä½“å–å“ªä¸ªå¥½ï¼Œå¯¹äºä¸€èˆ¬çš„ç®—å­æ¥è¯´æ²¡å•¥å·®åˆ«ï¼Œå¯èƒ½åªå¯¹Gemmä¼šå½±å“å¤§ç‚¹ï¼‰</p><p>å¯¹äº<strong>threadæ•°é‡</strong>ï¼Œæœ‰ä¸ªå¿…è¦æ¡ä»¶ï¼šä¸€ä¸ª<strong>kernelçš„blockDimåº”è¯¥è‡³å°‘&gt;=è¯¥GPUçš„ä¸€ä¸ªSMçš„(æœ€å¤§çº¿ç¨‹æ•°/blockæ•°é‡)</strong>ã€‚ä¾‹å¦‚ï¼Œå¯¹äº3090æ˜¾å¡ï¼Œå®ƒä¸€ä¸ªSMä¸Šçš„æœ€å¤§çº¿ç¨‹æ•°ä¸º1536ï¼Œæœ€å¤§blockæ•°ä¸º16ï¼Œåˆ™cuda kernelçš„blockDimè‡³å°‘åº”è¯¥å¤§äº1536 / 16 = 96ã€‚å¦åˆ™ï¼Œæ— æ³•åœ¨ç†è®ºä¸Šè¾¾åˆ°100%çš„Occupancyã€‚ï¼ˆå ç”¨ç‡ä¹Ÿä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œå…¶å®å¤§äº70%å°±å·®ä¸å¤šäº†ï¼Œå†å¾€ä¸Škernelçš„æ€§èƒ½å°±å’Œå ç”¨ç‡å…³ç³»ä¸å¤§äº†ï¼‰</p><p>å¯¹äº<strong>blockæ•°é‡</strong>ï¼Œçœ‹çœ‹occupancyï¼Œçœ‹çœ‹full waveæ•°é‡å’Œtail waveï¼Œæ ¹æ®è¿™äº›metricæ¥è°ƒæ•´blockæ•°é‡ï¼Œä½¿å¾—<strong>full waveå°½å¯èƒ½å¤šï¼Œtail waveä¸­çš„blockæ•°é‡ä¹Ÿå°½å¯èƒ½å¤šï¼Œoccupancyå°½å¯èƒ½å¤§</strong>ï¼Œå¯¹æ­¤cudaä¹Ÿæä¾›äº†ä¸€äº›APIæ¥è®¡ç®—ä½¿å¾—occupancyæœ€å¤§çš„blockæ•°é‡ã€‚</p><p><em>å›¾ä¸­ï¼Œå·¦ä¾§çš„full waveä¸º2ï¼Œå æ¯”ä¸º2/3ï¼Œtail waveä¸­åªæœ‰ä¸€ä¸ªblockï¼Œå æ¯”ä¸º1/4ï¼Œè¿™ä¿©çš„å æ¯”éƒ½ä¸é«˜ï¼Œæ‰€ä»¥éœ€è¦è°ƒæ•´blockæ•°é‡ï¼›è°ƒæ•´åå³ä¾§çš„full waveå æ¯”ä¸º4/5ï¼Œtail waveå æ¯”ä¸º2/4ï¼Œè¿™ä¿©çš„å æ¯”éƒ½é«˜äº†ï¼Œå› æ­¤å¯¹åº”kernelçš„æ€§èƒ½ä¹Ÿä¼šæ›´å¥½</em></p><figure><img src="/Notes/assets/img/33_2.c47c1d4f.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>ç©¶æç»éªŒå…¬å¼ï¼š</strong>(è¿™æ ·è®¾ç½®ä¸€èˆ¬å·®ä¸äº†ï¼ŒGemmä¾‹å¤–ï¼Œå¾—ç‰¹è°ƒ)</p><ul><li>blockæ•°é‡è®¾ç½® 1~4å€çš„SMæ•°é‡</li><li>threadæ•°é‡è®¾ç½® 256/512</li></ul><h3 id="_34-å‡è®¾æœ‰nä¸ªæ•°-ä½†æ˜¯ä½ åˆ†é…äº†å°äºnçš„æ€»çº¿ç¨‹æ•°-æ­¤æ—¶å¯ä»¥å¤„ç†å®Œå…¨éƒ¨æ•°æ®å—-å¦‚æœå¯ä»¥-å¦‚ä½•å¤„ç†" tabindex="-1"><a class="header-anchor" href="#_34-å‡è®¾æœ‰nä¸ªæ•°-ä½†æ˜¯ä½ åˆ†é…äº†å°äºnçš„æ€»çº¿ç¨‹æ•°-æ­¤æ—¶å¯ä»¥å¤„ç†å®Œå…¨éƒ¨æ•°æ®å—-å¦‚æœå¯ä»¥-å¦‚ä½•å¤„ç†"><span>34. å‡è®¾æœ‰Nä¸ªæ•°ï¼Œä½†æ˜¯ä½ åˆ†é…äº†å°äºNçš„æ€»çº¿ç¨‹æ•°ï¼Œæ­¤æ—¶å¯ä»¥å¤„ç†å®Œå…¨éƒ¨æ•°æ®å—ï¼Ÿå¦‚æœå¯ä»¥ï¼Œå¦‚ä½•å¤„ç†ï¼Ÿ</span></a></h3><p>å¯ä»¥å¤„ç†ï¼Œä¼ªä»£ç å¦‚ä¸‹</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N){</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    //do something</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> gridDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_35-shared-memory-bank-conflictçš„å®šä¹‰æ˜¯ä»€ä¹ˆæ ·çš„-æ˜“é”™" tabindex="-1"><a class="header-anchor" href="#_35-shared-memory-bank-conflictçš„å®šä¹‰æ˜¯ä»€ä¹ˆæ ·çš„-æ˜“é”™"><span>35. shared memory bank conflictçš„å®šä¹‰æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿï¼ˆæ˜“é”™ï¼‰</span></a></h3><p><strong>bank conflict</strong>ä»…å­˜åœ¨äº<strong>åŒä¸€phase</strong>çš„<strong>ä¸åŒslot</strong>ï¼ˆslotï¼šæ§½ï¼Œé’ˆå¯¹å•ä¸ªbankå†…çš„æ¦‚å¿µï¼Œä¸ä¸åŒbanké—´æ— å…³ï¼‰ä¹‹é—´ï¼Œè¯´å­˜åœ¨åŒä¸€warpçš„ä¸åŒçº¿ç¨‹é—´æ˜¯ä¸æ­£ç¡®çš„ã€‚</p><p>é‚£ä»€ä¹ˆæ˜¯åŒä¸€phaseï¼Ÿåˆ†ä¸‰ç§æƒ…å†µï¼šï¼ˆ1byte = 8bitsï¼‰</p><ol><li>æ¯ä¸ªçº¿ç¨‹è®¿é—®4bytes(ä¾‹å¦‚float)ï¼šä¸€ä¸ªwarpå†…çš„32ä¸ªçº¿ç¨‹å¤„äºåŒä¸€phase</li><li>æ¯ä¸ªçº¿ç¨‹è®¿é—®8bytes(ä¾‹å¦‚double)ï¼šä¸€ä¸ªwarpå†…çš„å‰16ä¸ªçº¿ç¨‹å¤„äºåŒä¸€phaseï¼Œå16ä¸ªçº¿ç¨‹å¤„äºå¦ä¸€ä¸ªphase</li><li>æ¯ä¸ªçº¿ç¨‹è®¿é—®16bytesï¼šä¸€ä¸ªwarpå†…çš„å‰8ä¸ªçº¿ç¨‹å¤„äºåŒä¸€phaseã€‚</li></ol><p>é—®ï¼šT0å’ŒT16è®¿é—®åŒä¸€slotä¼šä¸ä¼šbank conflictï¼Ÿç­”ï¼šä¸ä¼šï¼ˆT0å’ŒT16çº¿ç¨‹ä¸å±äºåŒä¸€ä¸ªphaseï¼‰</p><p>é—®ï¼šT0 T1è®¿é—®åŒä¸€slotä¼šä¸ä¼šbank conflictï¼Ÿç­”ï¼šä¸ä¼šï¼ˆè™½ç„¶T0å’ŒT1çº¿ç¨‹å±äºåŒä¸€ä¸ªphaseï¼Œä½†æ˜¯å®ƒä»¬è®¿é—®çš„æ˜¯bankä¸­çš„åŒä¸€slotï¼‰</p><p>é—®ï¼šT0 ç…§å¸¸è®¿é—®å½“å‰çš„0ï¼ŒT1ä¹Ÿè®¿é—®0ä¼šä¸ä¼šbank conflictï¼Ÿç­”ï¼šä¸ä¼šï¼ˆè¿™ä¸ªcaseå°±æ˜¯ä¸Šé¢è¿™ä¸ªé—®é¢˜çš„å…¸å‹ï¼Œæ­¤æ—¶ä¼šè§¦å‘å¹¿æ’­æ“ä½œï¼Œä¸ä¼šæœ‰conflictçš„ï¼‰</p><p>é—®ï¼šT0 ç…§å¸¸è®¿é—®å½“å‰çš„0ï¼ŒT1è®¿é—®åŸæœ¬T16è®¿é—®çš„é‚£å—æ•°æ®T16ä¼šä¸ä¼šbank conflictï¼Ÿç­”ï¼šä¼šï¼ˆæ­¤æ—¶T0å’ŒT1çº¿ç¨‹å±äºåŒä¸€ä¸ªphaseï¼Œä¸”å®ƒä»¬è®¿é—®çš„æ˜¯åŒä¸€bankä¸­çš„ä¸åŒslotï¼‰</p><p>ä¸‹å›¾ä¸­ç»¿è‰²ã€è“è‰²ä»£è¡¨äº†ä¸¤ä¸ªphaseï¼ˆå¯¹åº”äºæƒ…å†µ2.ï¼‰ï¼Œè€Œslotæ˜¯åŒä¸€bankå†…çš„æ¦‚å¿µï¼Œæ¯”å¦‚è¯´æ•°æ®å—0çš„å·¦åŠéƒ¨åˆ†å’Œ16çš„å·¦åŠéƒ¨åˆ†å®ƒä»¬å°±å±äºbank0çš„ä¸åŒslotã€‚<strong>æ— è®ºphaseå¦‚ä½•æ„æˆï¼Œä¸€ä¸ªbankä¸­åªå­˜ä¸€ä¸ªcachelineä¸­çš„4bytesæ•°æ®ï¼Œä¸€ä¸ªcachelineæ°¸è¿œéƒ½å›ºå®šæœ‰32ä¸ªbank</strong>ã€‚cachelineæ˜¯å›ºå®šå¤§å°çš„ï¼Œ128bytesï¼Œå› æ­¤æ‰æœ‰äº†åŒä¸€phaseçš„ä¸‰ç§æƒ…å†µï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯è¦åŒ¹é…ä¸Šcachelineçš„ã€‚</p><figure><img src="/Notes/assets/img/35.1cb4f1ea.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_36-å¦‚ä½•è§£å†³bank-conflict" tabindex="-1"><a class="header-anchor" href="#_36-å¦‚ä½•è§£å†³bank-conflict"><span>36. å¦‚ä½•è§£å†³bank conflictï¼Ÿ</span></a></h3><p><a href="https://zhuanlan.zhihu.com/p/4746910252" target="_blank" rel="noopener noreferrer">CUDA shared memoryé¿å…bank conflictçš„swizzlingæœºåˆ¶è§£æ</a><br> é¦–å…ˆä¼ ç»Ÿçš„transpose.cuè®¡ç®—å¦‚ä¸‹ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">__global__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> transpose_naive</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> d_A, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> M, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> d_B){</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> row </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> col </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    __shared__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">][</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(row </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> M </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> col </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N){</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">][</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> d_A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[row </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> col];</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        __syncthreads</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> n_col </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> n_row </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(n_row </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> n_col </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> M){</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            d_B</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[n_row </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> M </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> n_col] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">][</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸¤ç§æ–¹æ³•è§£å†³bank conflictï¼š</p><ul><li>æ–¹æ³•1ï¼špadding</li></ul><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">__shared__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">][</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>æ–¹æ³•2ï¼šswizzling<br> swizzlingæ˜¯ä¸€ä¸ªå¼‚æˆ–çš„ç®—æ³•ã€‚</li></ul><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">__global__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> transpose_swizzling</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> d_A, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> M, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> d_B){</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> row </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> col </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    __shared__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">][</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(row </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> M </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> col </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N){</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">][</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">^</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> d_A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[row </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> col];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //è¿™é‡Œå°±æ˜¯swizzling</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        __syncthreads</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> n_col </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> n_row </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(n_row </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> n_col </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> M){</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            d_B</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[n_row </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> M </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> n_col] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">][</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">^</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //è¿™é‡Œå°±æ˜¯swizzling</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_37-å¦‚ä½•é«˜æ•ˆè®¿é—®global-memory" tabindex="-1"><a class="header-anchor" href="#_37-å¦‚ä½•é«˜æ•ˆè®¿é—®global-memory"><span>37. å¦‚ä½•é«˜æ•ˆè®¿é—®global memoryï¼Ÿ</span></a></h3><ol><li>Aligned Memory accesså¯¹é½ï¼šè¦è·å–çš„Memoryé¦–åœ°å€å¯ä»¥æ•´é™¤L1/L2 cache lineå¤§å°ï¼Œå³å¯¹é½ï¼›</li><li>Coalesced Memory accessè¿ç»­ï¼šwarpçš„32ä¸ªthreadè¯·æ±‚çš„æ˜¯è¿ç»­çš„å†…å­˜å—ï¼›</li></ol><h3 id="_38-ä»¥ä¸‹å‡ ç§è®¿é—®global-memoryçš„case-æ•ˆç‡-å®é™…åˆ©ç”¨æ•°æ®é‡-æ€»è®¿é—®æ•°æ®é‡-ä¸ºå¤šå°‘" tabindex="-1"><a class="header-anchor" href="#_38-ä»¥ä¸‹å‡ ç§è®¿é—®global-memoryçš„case-æ•ˆç‡-å®é™…åˆ©ç”¨æ•°æ®é‡-æ€»è®¿é—®æ•°æ®é‡-ä¸ºå¤šå°‘"><span>38. ä»¥ä¸‹å‡ ç§è®¿é—®global memoryçš„caseï¼Œæ•ˆç‡(å®é™…åˆ©ç”¨æ•°æ®é‡/æ€»è®¿é—®æ•°æ®é‡)ä¸ºå¤šå°‘ï¼Ÿ</span></a></h3><figure><img src="/Notes/assets/img/38.d3d35594.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol><li><strong>100%</strong> :çº¿ç¨‹éœ€è¦äº†å¤šå°‘å°±æ‹¿è¿›æ¥å¤šå°‘ï¼Œæ²¡æœ‰å¤šä½™è®¿é—®ï¼Œä¸”ç¬¦åˆ37é¢˜ä¸­ç»™å‡ºçš„ä¸¤ç‚¹é«˜æ•ˆç­–ç•¥ï¼›</li><li><strong>100%</strong> :åŒä¸Šï¼Œæ²¡æœ‰å¤šä½™è®¿é—®ï¼Œä¸”ç¬¦åˆ37é¢˜ä¸­ç»™å‡ºçš„ä¸¤ç‚¹é«˜æ•ˆç­–ç•¥ï¼›</li><li><strong>50%</strong> :warpä¸­å‰16ä¸ªçº¿ç¨‹è®¿é—®äº†64-128,è€Œå16ä¸ªçº¿ç¨‹è®¿é—®äº†192-256,æ˜¯ä¸è¿ç»­çš„å†…å­˜å—ã€‚è¯»å–æ—¶ä¼šè¯»å–0-256çš„æ‰€æœ‰å†…å­˜ï¼›</li><li><strong>1/N</strong></li></ol><h3 id="_39-å¦‚æœè®¿é—®global-memoryçš„æ•ˆç‡ä½-é‚£æ˜¯å¦æ„å‘³ç€æœªè¢«åˆ©ç”¨åˆ°çš„æ•°æ®å°±æ²¡ç”¨äº†-å¦‚æœæœ‰-ä¸¾ä¸€ä¸ªä¾‹å­è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#_39-å¦‚æœè®¿é—®global-memoryçš„æ•ˆç‡ä½-é‚£æ˜¯å¦æ„å‘³ç€æœªè¢«åˆ©ç”¨åˆ°çš„æ•°æ®å°±æ²¡ç”¨äº†-å¦‚æœæœ‰-ä¸¾ä¸€ä¸ªä¾‹å­è¯´æ˜"><span>39. å¦‚æœè®¿é—®global memoryçš„æ•ˆç‡ä½ï¼Œé‚£æ˜¯å¦æ„å‘³ç€æœªè¢«åˆ©ç”¨åˆ°çš„æ•°æ®å°±æ²¡ç”¨äº†ï¼Ÿå¦‚æœæœ‰ï¼Œä¸¾ä¸€ä¸ªä¾‹å­è¯´æ˜</span></a></h3><p>ä¸æ˜¯ï¼Œæœªè¢«åˆ©ç”¨åˆ°çš„æ•°æ®ä¼šå­˜åœ¨L2/L1 cacheä¸­ï¼ˆè¿™ä¸ªcacheå°±æ˜¯ç»™38é¢˜ä¸­çš„ä¸¤ä¸ªç³Ÿç³•çš„caseæ“¦å±è‚¡çš„ï¼‰ï¼Œåœ¨æŸäº›å­˜åœ¨é‡å¤è®¿é—®æŸå—æ˜¾å­˜çš„ç®—ä¾‹ä¸­ï¼Œè¿™äº›å­˜åœ¨cacheä¸Šçš„æ•°æ®å¯ä»¥è¢«å¿«é€Ÿçš„è®¿é—®åˆ°ã€‚</p><p>ä¸¾ä¾‹ï¼šGEMMã€‚</p><h3 id="_40-constant-memoryçš„ä½œç”¨æ˜¯ä»€ä¹ˆ-ä¸¾ä¸ªä¾‹å­è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#_40-constant-memoryçš„ä½œç”¨æ˜¯ä»€ä¹ˆ-ä¸¾ä¸ªä¾‹å­è¯´æ˜"><span>40. constant memoryçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿä¸¾ä¸ªä¾‹å­è¯´æ˜</span></a></h3><p>å¸¸é‡å†…å­˜æ²¡æœ‰å…·ä½“çš„ç¡¬ä»¶å­˜å‚¨å•å…ƒï¼Œæ˜¯<strong>å…¨å±€å†…å­˜çš„ä¸€ç§è™šæ‹Ÿåœ°å€å½¢å¼ï¼Œå†…å­˜ç©ºé—´å°ï¼Œåªè¯»ï¼Œä½†æ˜¯è¯»å–çš„é€Ÿåº¦è¦æ¯”global memoryæ›´å¿«</strong>ã€‚å¸¸é‡å†…å­˜æœ‰ä¸¤ä¸ªç‰¹æ€§ï¼š</p><ol><li><strong>é«˜é€Ÿç¼“å­˜å¸¸é‡</strong>ï¼šå¦‚ä¸‹ï¼Œåœ¨hostç«¯ä½¿ç”¨cudaMemcpyToSymbolæ¥ä¼ é€’å·ç§¯æ ¸å‡½æ•°å¸¸é‡åˆ°å¸¸é‡å†…å­˜ï¼Œåç»­ä½¿ç”¨è¯¥æ ¸å‡½æ•°çš„æ—¶å€™ä¼šæ¯”è¯»global memoryå¿«å¾ˆå¤šï¼›</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">__constant__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> kernel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[KERNEL_SIZE </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> KERNEL_SIZE];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // åˆå§‹åŒ–å·ç§¯æ ¸</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    float</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> h_kernel</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[KERNEL_SIZE </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> KERNEL_SIZE] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    };</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // æ‹·è´åˆ°constant memory</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    cudaMemcpyToSymbol</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(kernel, h_kernel, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">sizeof</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(h_kernel));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ......</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    conv2D</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">numBlocks, threadsPerBlock</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;&gt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(...);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>å®ƒæ”¯æŒ<strong>å°†å•ä¸ªå€¼å¹¿æ’­åˆ°warpä¸­çš„æ¯ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ç”¨æ¯ä¸ªçº¿ç¨‹éƒ½load</strong>ï¼›å¦‚æœæ¯ä¸ªhalf-warp/full-warpä¸­çš„çº¿ç¨‹éœ€è¦è®¿é—®ä¸åŒçš„å†…å­˜åœ°å€ï¼Œè¿™ç§æƒ…å†µä¸‹ä¸é€‚åˆä½¿ç”¨å¸¸é‡å†…å­˜ã€‚</li></ol><h3 id="_41-simdå’Œsimtçš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_41-simdå’Œsimtçš„åŒºåˆ«"><span>41. SIMDå’ŒSIMTçš„åŒºåˆ«ï¼Ÿ</span></a></h3><p>ä¼ ç»ŸCPUå’Œå½“å‰ä¸€äº›é€šç”¨AIåŠ é€Ÿå™¨æ¯”å¦‚æ˜‡è…¾NPUä½¿ç”¨çš„æ˜¯SIMDç¼–ç¨‹ï¼Œé€šç”¨GPUé€šå¸¸é‡‡ç”¨SIMTç¼–ç¨‹ã€‚</p><p>é‡ç‚¹å…³æ³¨å‰4ä¸ªå¯¹æ¯”ï¼š</p><ol><li><p>SIMDé»˜è®¤æ˜¯ç”±å•çº¿ç¨‹issueçš„ä¸€æ¡å‘é‡æŒ‡ä»¤ï¼ŒSIMTé»˜è®¤æ˜¯å¤šçº¿ç¨‹åŒæ—¶issueä¸€æ¡ç›¸åŒæŒ‡ä»¤ï¼›</p></li><li><p>å¯„å­˜å™¨è§’åº¦ï¼ŒSIMDæ˜¯å…±ç”¨ä¸€å¥—å¯„å­˜å™¨ï¼ŒSIMTæ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç§æœ‰å¯„å­˜å™¨</p></li><li><p>SIMDä¸SIMTçš„ç®—åŠ›å¯¹æ¯”ï¼šç”±äºSIMDçš„å¯„å­˜å™¨åŸå› ï¼Œ<strong>SIMDæƒ³è¦ç®—åŠ›æ‰“æ»¡å¿…é¡»æ‰“æ»¡å…¶å¯„å­˜å™¨</strong>ï¼Œä¾‹å¦‚å¯¹äºå‘é‡å®½åº¦ä¸º4çš„SIMDï¼Œå¦‚æœåªç”¨äº†3ä¸ªslotçš„è¯ï¼ŒSIMDå°±æµªè´¹äº†ä¸€ä¸ªè®¡ç®—å•å…ƒã€‚è€Œ<strong>SIMTå°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼Œå®ƒçš„ç®—åŠ›å’Œå¯„å­˜å™¨æ‰“ä¸æ‰“æ»¡æ²¡å…³ç³»ï¼Œåªè¦èƒ½æŠŠcuda coreéƒ½åˆ©ç”¨èµ·æ¥å°±è¡Œã€‚</strong></p></li><li><p>éšç€çº¿ç¨‹æ•°çš„å¢å¤šï¼ŒSIMDåªèƒ½å°†å‘é‡çš„ç»´åº¦ä¸æ–­åŠ å¤§ï¼Œè€Œè¿™æ ·çš„è¯ä¼šäº§ç”Ÿæ›´å¤šçš„å‘é‡æµªè´¹ï¼ŒåŠŸè€—ä¹Ÿä¼šå˜é«˜ï¼›SIMTåˆ™æ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚</p></li><li><p>SIMDå’ŒSIMTé€»è¾‘å•å…ƒé¢ç§¯å¯¹æ¯”ï¼šå•çº¿ç¨‹ä¸‹ï¼ŒSIMDç›¸å¯¹SIMTéœ€è¦nå€çš„é€»è¾‘å•å…ƒã€‚å³<strong>å•ä¸ªçº¿ç¨‹çš„é¢ç§¯SIMDåŸºæœ¬æ¥è¿‘SIMTçš„nå€é¢ç§¯</strong>ã€‚</p></li><li><p>æ¯æ¬¡æ›´æ–°SIMDæŒ‡ä»¤ï¼ˆmmx -&gt; sse -&gt; sse4.2 -&gt; avx -&gt; avx2 -&gt; avx512 -&gt; amxï¼‰éƒ½æ˜¯å¢åŠ å…¶å¯„å­˜å™¨ä¸ªæ•°ã€å¯„å­˜å™¨ä½æ•°ã€ALUå®½åº¦ï¼Œè€ŒSIMTæ˜¯å¢åŠ coreæ•°ã€‚</p></li><li><p>ç¼–ç¨‹ä¸Šï¼ŒSIMDä½¿ç”¨C++ Intrinsicï¼Œè€Œä¸”æ¯ä¸€å¥—ISAè°ƒç”¨ä¸åŒçš„Intrinsicï¼Œè¿˜å¾—æ‰‹åŠ¨æ§åˆ¶/åˆ†é…å†…å­˜å™¨ï¼›SIMTä½¿ç”¨CUDAå³C/C++ç¼–ç¨‹æ¨¡å‹å³å¯ã€‚</p></li></ol><h3 id="_42-è®²è®²independent-thread-scheduling-ç‹¬ç«‹çº¿ç¨‹è°ƒåº¦-çš„æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#_42-è®²è®²independent-thread-scheduling-ç‹¬ç«‹çº¿ç¨‹è°ƒåº¦-çš„æ¦‚å¿µ"><span>42. è®²è®²Independent thread schedulingï¼ˆç‹¬ç«‹çº¿ç¨‹è°ƒåº¦ï¼‰çš„æ¦‚å¿µï¼Ÿ</span></a></h3><p><strong>ç‹¬ç«‹çº¿ç¨‹è°ƒåº¦åŠŸèƒ½æ˜¯ç”±Voltaæ¶æ„å¼•å…¥çš„ï¼Œå®ƒå…è®¸æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹æ‰§è¡Œï¼Œæ— éœ€ç­‰å¾…å…¶ä»–çº¿ç¨‹ã€‚</strong></p><p><strong>Voltaä¹‹å‰ï¼Œæ¯ä¸ªwarpåªæœ‰ä¸€ä¸ªå…¬å…±çš„æ´»è·ƒPC</strong>ï¼ˆProgram Counterç¨‹åºè®¡æ•°å™¨ï¼‰å¯ä»¥å‚ä¸åˆ°warp schedulerçš„ä»²è£ï¼Œæ‰€ä»¥ä¸€ä¸ªåˆ†æ”¯åˆ°åº•åè¦å¼¹æ ˆå–å‡ºå¦ä¸€ä¸ªåˆ†æ”¯çš„pcï¼Œç„¶åå¼€å§‹æ‰§è¡Œå¦ä¸€ä¸ªåˆ†æ”¯ï¼Œå¯¼è‡´ä»¥å‰æ˜¯åˆ†æ”¯å‰ä¸²è¡Œæ‰§è¡Œï¼Œè¿™ä¸ªç°è±¡å«åšwarp divergenceã€‚ï¼ˆå¦‚ä¸‹å›¾çš„ä¸ŠåŠéƒ¨åˆ†ï¼‰</p><p><strong>Voltaä¹‹åï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„PCï¼Œå¯ä»¥ç‹¬ç«‹æ‰§è¡Œï¼Œæ— éœ€ç­‰å¾…å…¶ä»–çº¿ç¨‹ã€‚<strong>å¯ä»¥åŒæ—¶å‚ä¸æ‰§è¡Œä»²è£ï¼Œè¿™æ ·èƒ½å½¢æˆ</strong>äº¤é”™æ‰§è¡Œ</strong>çš„æ•ˆæœã€‚æ³¨æ„ï¼šè¿™é‡Œå¯ä¸æ˜¯ä¸¤ä¸ªåˆ†æ”¯éƒ½æ‰§è¡Œï¼Œè€Œæ˜¯ä¸¤ä¸ªåˆ†æ”¯çš„çº¿ç¨‹äº¤é”™æ‰§è¡Œã€‚<strong>äº¤é”™çš„å¥½å¤„å°±æ˜¯å¯ä»¥æ©ç›–åŒä¸€åˆ†æ”¯ä¸åŒçº¿ç¨‹æ‰§è¡Œä¸åŒæŒ‡ä»¤çš„å»¶è¿Ÿã€‚</strong>ï¼ˆå¦‚ä¸‹å›¾ä¸‹åŠéƒ¨åˆ†ï¼Œæ©ç›–äº†Stallï¼‰ã€‚</p><p>ä»ç¨‹åºå®ç°çš„éœ€æ±‚ä¸Šçœ‹ï¼Œä¸€äº›é—®é¢˜ä»ç®—æ³•ä¸Šå°±å¾ˆéš¾é¿å…divergenceã€‚Independent thread schedulingå¯ä»¥æ›´å¥½çš„å¸®åŠ©å…¶éšè—å»¶è¿Ÿï¼Œä»è€Œå‡å°‘divergenceçš„æ€§èƒ½æŸå¤±ï¼Œä½†å¹¶ä¸èƒ½å‡å°‘divergenceæœ¬èº«ã€‚ä½†<strong>å‡å¦‚è¿™äº›å»¶è¿Ÿæœ¬æ¥å°±è¢«éšè—å¾—å¾ˆå¥½ï¼Œæˆ–è€…è¯´æœ¬æ¥å°±å‡ ä¹æ²¡ä»€ä¹ˆstallï¼ˆæ¯”å¦‚ç­‰å¾…è®¿å­˜ç»“æŸï¼‰ï¼Œé‚£å®ƒå¯¹æ€§èƒ½çš„å¸®åŠ©å°±å‡ ä¹æ²¡æœ‰äº†ã€‚</strong></p><p>åœ¨CUDAä¸­ï¼Œå“ªæ€•åªæœ‰ifè¯­å¥ï¼Œä¹Ÿä¼šå‘ç”Ÿwarp divergenceï¼Œå› ä¸ºwarpå†…çš„çº¿ç¨‹æ¡ä»¶å¯èƒ½ä¸åŒã€‚ä½†ç”±äºæ²¡æœ‰elseï¼Œåªä¼šæ‰§è¡Œä¸€æ¡è·¯å¾„ï¼Œä¸éœ€è¦åƒif/elseé‚£æ ·å¤šèµ°ä¸€éï¼Œå› æ­¤ä¸ä¼šå¯¹æ€§èƒ½é€ æˆæ˜¾è‘—å½±å“ã€‚</p><figure><img src="/Notes/assets/img/42.302a378c.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_42-1-å¦‚ä½•é¿å…warp-divergence" tabindex="-1"><a class="header-anchor" href="#_42-1-å¦‚ä½•é¿å…warp-divergence"><span>42.1 å¦‚ä½•é¿å…warp divergenceï¼Ÿ</span></a></h3><p>å¦‚ä¸‹ä»£ç ä¼šäº§ç”Ÿwarp divergenceï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tid </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(tid </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">%</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">){</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//åŒä¸€warpä¸­çš„å¶æ•°çº¿ç¨‹æ‰§è¡Œè¿™è¾¹</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//åŒä¸€warpä¸­çš„å¥‡æ•°çº¿ç¨‹æ‰§è¡Œè¿™è¾¹</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è§£å†³æ–¹æ³•ï¼š<strong>warp divergenceæ˜¯é’ˆå¯¹åŒä¸€warpå†…çš„æ¦‚å¿µï¼Œé‚£æˆ‘ä»¬å°±å°½é‡è®©åŒä¸€warpä¸­çš„çº¿ç¨‹æ‰§è¡Œç›¸åŒçš„æŒ‡ä»¤å³å¯</strong>ã€‚</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">((tid</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">%</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">){</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //tid/32æ˜¯warp idï¼Œ%2æ˜¯åˆ¤æ–­å¥‡å¶ã€‚ä½¿å¾—åŒä¸€warpæ‰§è¡Œç›¸åŒæŒ‡ä»¤</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//å¶æ•°warpè¿›å…¥è¿™è¾¹</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ...</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//å¥‡æ•°warpè¿›å…¥è¿™è¾¹</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_43-gpuæ˜¯ä»å“ªäº›æ–¹é¢ä½“ç°å‡ºè‡ªå·±æ˜¯ä»¥æé«˜ååä¸ºä¸­å¿ƒçš„" tabindex="-1"><a class="header-anchor" href="#_43-gpuæ˜¯ä»å“ªäº›æ–¹é¢ä½“ç°å‡ºè‡ªå·±æ˜¯ä»¥æé«˜ååä¸ºä¸­å¿ƒçš„"><span>43. GPUæ˜¯ä»å“ªäº›æ–¹é¢ä½“ç°å‡ºè‡ªå·±æ˜¯ä»¥æé«˜ååä¸ºä¸­å¿ƒçš„ï¼Ÿ</span></a></h3><p>é‡ç‚¹ç†è§£ç¬¬ä¸€ç‚¹ï¼š</p><ol><li><p>GPUä¼š<strong>å°½å¯èƒ½å‡å°‘ç©ºé—²ï¼Œæ€»ä¼šæœ‰warpåœ¨run</strong>ï¼šæ¯ä¸ªcycleï¼Œwarp scheduleréƒ½ä¼šscheduleä¸€ä¸ªwarpåˆ°dispatch portå‘å°„ï¼Œå½“å‘ç”Ÿæ•°æ®ä¾èµ–å¯¼è‡´stallæ—¶ï¼Œè°ƒåº¦ç®—æ³•ä¼šscheduleå…¶å®ƒå¯ç”¨çš„warpåˆ°dispatch portå‘å°„ï¼Œå½“å½“å‰warpæ‰§è¡Œçš„function unitå¿™ç¢Œæ—¶ï¼Œ<strong>è°ƒåº¦ç®—æ³•ä¼šscheduleä¸å¿™ç¢Œä¸”ä¸å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„warpå»dispatchå‘å°„</strong>ï¼Œæ€»ä¹‹ï¼Œ<strong>æ¯ä¸ªcycleï¼Œwarpéƒ½åœ¨å‘å°„æˆ–è€…åœ¨æ‰§è¡ŒæŒ‡ä»¤</strong></p></li><li><p>æ ¸æ•°å¤šï¼Œä½†æ¯ä¸ªæ ¸æ‰€å é¢ç§¯å°</p></li><li><p>cacheé¢ç§¯å°</p></li><li><p>æ§åˆ¶å•å…ƒé¢ç§¯å°</p></li></ol><h3 id="_44-gpuçš„å­˜å‚¨å±‚æ¬¡ç»“æ„æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#_44-gpuçš„å­˜å‚¨å±‚æ¬¡ç»“æ„æ˜¯ä»€ä¹ˆ"><span>44. GPUçš„å­˜å‚¨å±‚æ¬¡ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ</span></a></h3><ol><li><strong>å¯„å­˜å™¨</strong>ï¼ˆRegisterï¼‰</li></ol><ul><li>ç‰‡ä¸Š / ç‰‡å¤–ï¼š<strong>ç‰‡ä¸Šå­˜å‚¨</strong>ã€‚å¯„å­˜å™¨æ˜¯ GPU ä¸­æœ€æ¥è¿‘è®¡ç®—å•å…ƒçš„å­˜å‚¨ï¼Œ<strong>ç›´æ¥é›†æˆåœ¨æ¯ä¸ªæµå¤„ç†å™¨(SM)æ ¸å¿ƒå†…</strong>ã€‚</li><li>é€Ÿåº¦ï¼šé€Ÿåº¦æå¿«ï¼Œå‡ ä¹å’Œ GPU æ ¸å¿ƒçš„è®¡ç®—é€Ÿåº¦åŒæ­¥ï¼Œèƒ½å¤Ÿåœ¨<strong>ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…å®Œæˆè¯»å†™æ“ä½œ</strong>ï¼Œæ˜¯ GPU å­˜å‚¨å±‚æ¬¡ä¸­è®¿é—®é€Ÿåº¦æœ€å¿«çš„éƒ¨åˆ†ã€‚</li><li>å®¹é‡å¤§å°ï¼šå®¹é‡æœ‰é™ï¼Œ<strong>æ¯ä¸ªçº¿ç¨‹åªèƒ½ä½¿ç”¨å‡ ç™¾ä¸ªå¯„å­˜å™¨</strong>ï¼Œå…·ä½“å–å†³äº GPU çš„æ¶æ„å’Œè®¾è®¡ã€‚</li></ul><ol start="2"><li><strong>å…±äº«å†…å­˜</strong>ï¼ˆShared Memoryï¼‰</li></ol><ul><li>ç‰‡ä¸Š / ç‰‡å¤–ï¼š<strong>ç‰‡ä¸Šå­˜å‚¨</strong>ã€‚å…±äº«å†…å­˜ä½äº GPU èŠ¯ç‰‡ä¸Šï¼Œ<strong>ä¾›ä¸€ä¸ªçº¿ç¨‹å—å†…çš„æ‰€æœ‰çº¿ç¨‹å…±äº«ä½¿ç”¨</strong>ã€‚</li><li>é€Ÿåº¦ï¼šé€Ÿåº¦å¾ˆå¿«ï¼Œè®¿é—®å»¶è¿Ÿè¾ƒä½ï¼Œé€šå¸¸åœ¨<strong>å‡ ä¸ªæ—¶é’Ÿå‘¨æœŸå†…</strong>å°±èƒ½å®Œæˆè¯»å†™æ“ä½œï¼Œä»…æ¬¡äºå¯„å­˜å™¨çš„è®¿é—®é€Ÿåº¦ã€‚</li><li>å®¹é‡å¤§å°ï¼šå®¹é‡ç›¸å¯¹å¯„å­˜å™¨è¾ƒå¤§ï¼Œä½†ä»ç„¶æœ‰é™ï¼Œä¸€èˆ¬åœ¨å‡ å KB åˆ°å‡ ç™¾ KB ä¹‹é—´ã€‚ä¾‹å¦‚ï¼ŒNVIDIA çš„ä¸€äº› GPU çš„å…±äº«å†…å­˜å¤§å°ä¸º 48KB æˆ– 96KBã€‚</li></ul><ol start="3"><li><strong>L1/L2 ç¼“å­˜</strong>ï¼ˆL1/L2 cacheï¼‰</li></ol><ul><li><p>ç‰‡ä¸Š / ç‰‡å¤–ï¼š<strong>ç‰‡ä¸Šå­˜å‚¨</strong>ã€‚L1 å’Œ L2 ç¼“å­˜æ˜¯ä½äº GPU èŠ¯ç‰‡ä¸Šçš„é«˜é€Ÿç¼“å­˜ï¼Œç”¨äºå‡å°‘å¯¹å…¨å±€å†…å­˜çš„è®¿é—®æ¬¡æ•°ã€‚</p></li><li><p>é€Ÿåº¦ï¼šé€Ÿåº¦è¾ƒå¿«ï¼Œ<strong>L1 ç¼“å­˜çš„è®¿é—®é€Ÿåº¦æ¯” L2 ç¼“å­˜æ›´å¿«</strong>ã€‚L1 ç¼“å­˜çš„è®¿é—®å»¶è¿Ÿé€šå¸¸åœ¨<strong>å‡ ä¸ªåˆ°åå‡ ä¸ªæ—¶é’Ÿå‘¨æœŸ</strong>ï¼ŒL2 ç¼“å­˜çš„è®¿é—®å»¶è¿Ÿç›¸å¯¹è¾ƒé•¿ï¼Œä½†ä»ç„¶è¿œä½äºå…¨å±€å†…å­˜ã€‚</p></li><li><p>å®¹é‡å¤§å°ï¼šL1 ç¼“å­˜å®¹é‡è¾ƒå°ï¼Œä¸€èˆ¬åœ¨<strong>å‡  KB åˆ°å‡ å KB ä¹‹é—´</strong>ï¼›L2 ç¼“å­˜å®¹é‡ç›¸å¯¹è¾ƒå¤§ï¼Œé€šå¸¸åœ¨<strong>å‡ ç™¾ KB åˆ°å‡  MB ä¹‹é—´</strong>ã€‚ä¾‹å¦‚ï¼ŒNVIDIA çš„æŸäº› GPU çš„ L1 ç¼“å­˜å¤§å°ä¸º 64KBï¼ŒL2 ç¼“å­˜å¤§å°ä¸º 40MBã€‚</p></li><li><p>L1ä¸Shared Memoryå…±åˆ†å‡ åKBçš„å†…å­˜eã€‚</p></li></ul><ol start="4"><li><strong>å…¨å±€å†…å­˜</strong>ï¼ˆGlobal Memoryï¼‰</li></ol><ul><li>ç‰‡ä¸Š / ç‰‡å¤–ï¼š<strong>ç‰‡å¤–å­˜å‚¨</strong>ã€‚å…¨å±€å†…å­˜é€šå¸¸æ˜¯ GPU æ¿è½½çš„é«˜é€Ÿ DRAM/HBMï¼ˆåŠ¨æ€éšæœºå­˜å–å­˜å‚¨å™¨ï¼‰ï¼Œä½äº GPU èŠ¯ç‰‡å¤–éƒ¨ã€‚</li><li>é€Ÿåº¦ï¼šé€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ï¼Œè®¿é—®å»¶è¿Ÿè¾ƒé«˜ï¼Œé€šå¸¸åœ¨<strong>å‡ ååˆ°å‡ ç™¾ä¸ªæ—¶é’Ÿå‘¨æœŸ</strong>ã€‚ä¸ç‰‡ä¸Šå­˜å‚¨ç›¸æ¯”ï¼Œå…¨å±€å†…å­˜çš„è¯»å†™é€Ÿåº¦æ˜æ˜¾è¾ƒä½ã€‚</li><li>å®¹é‡å¤§å°ï¼šå®¹é‡è¾ƒå¤§ï¼Œä¸€èˆ¬åœ¨å‡  GB åˆ°å‡ å GB ä¹‹é—´ã€‚ä¾‹å¦‚ï¼Œå¸¸è§çš„æ¶ˆè´¹çº§ GPU çš„å…¨å±€å†…å­˜å®¹é‡ä¸º 4GBã€8GB æˆ– 16GBï¼Œè€Œä¸“ä¸šçº§ GPU çš„å…¨å±€å†…å­˜å®¹é‡å¯èƒ½æ›´å¤§ï¼Œè¾¾åˆ° 32GB ç”šè‡³æ›´å¤šã€‚</li></ul><ol start="5"><li><strong>å¸¸é‡å†…å­˜</strong>ï¼ˆConstant Memoryï¼‰</li></ol><ul><li>ç‰‡ä¸Š / ç‰‡å¤–ï¼šå¸¸é‡å†…å­˜å±äº<strong>ç‰‡ä¸Šå­˜å‚¨</strong>ã€‚å®ƒæ˜¯ GPU èŠ¯ç‰‡ä¸Š<strong>ä¸“é—¨ç”¨äºå­˜å‚¨å¸¸é‡æ•°æ®çš„ä¸€å—ç‰¹æ®Šå†…å­˜åŒºåŸŸ</strong>ã€‚</li><li>é€Ÿåº¦ï¼šè®¿é—®é€Ÿåº¦è¾ƒå¿«ã€‚å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ç›¸åŒçš„å¸¸é‡æ•°æ®æ—¶ï¼Œå¸¸é‡å†…å­˜èƒ½å¤Ÿæä¾›é«˜æ•ˆçš„è®¿é—®ï¼Œå› ä¸ºå®ƒå…·æœ‰ç¼“å­˜æœºåˆ¶ã€‚GPU ä¼šå°†å¸¸é‡æ•°æ®ç¼“å­˜èµ·æ¥ï¼Œè¿™æ ·åç»­çš„è®¿é—®å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è·å–ï¼Œä»è€Œå‡å°‘äº†è®¿é—®å»¶è¿Ÿã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè®¿é—®å¸¸é‡å†…å­˜çš„å»¶è¿Ÿæ¯”è®¿é—®å…¨å±€å†…å­˜è¦ä½å¾—å¤šï¼Œé€šå¸¸åœ¨<strong>å‡ åä¸ªæ—¶é’Ÿå‘¨æœŸå·¦å³</strong>ã€‚</li><li>å®¹é‡å¤§å°ï¼šå®¹é‡ç›¸å¯¹æœ‰é™ï¼Œä¸€èˆ¬åœ¨å‡ å KB å·¦å³ã€‚ä¾‹å¦‚ï¼ŒNVIDIA çš„ä¸€äº› GPU æ¶æ„ä¸­ï¼Œå¸¸é‡å†…å­˜çš„å¤§å°ä¸º 64KBã€‚ç”±äºå…¶å®¹é‡è¾ƒå°ï¼Œé€šå¸¸ç”¨äºå­˜å‚¨é‚£äº›åœ¨æ•´ä¸ªæ ¸å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šå‘ç”Ÿå˜åŒ–çš„å¸¸é‡æ•°æ®ï¼Œå¦‚æ•°å­¦å¸¸é‡ã€é…ç½®å‚æ•°ç­‰ã€‚</li></ul><ol start="6"><li><strong>æœ¬åœ°å†…å­˜</strong>ï¼ˆLocal Memoryï¼‰</li></ol><ul><li><p>ç‰‡ä¸Š / ç‰‡å¤–ï¼šä»æ¦‚å¿µä¸Šè®²ï¼Œæœ¬åœ°å†…å­˜æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹å•ç‹¬åˆ†é…çš„ç§æœ‰å­˜å‚¨ç©ºé—´ï¼Œä½†å®é™…ä¸Šå®ƒé€šå¸¸æ˜¯<strong>ç‰‡å¤–å­˜å‚¨</strong>ã€‚<strong>å½“å¯„å­˜å™¨æ•°é‡ä¸è¶³ä»¥å­˜å‚¨çº¿ç¨‹æ‰€éœ€çš„æ‰€æœ‰æ•°æ®æ—¶ï¼Œå‰©ä½™çš„æ•°æ®ä¼šè¢«å­˜æ”¾åˆ°æœ¬åœ°å†…å­˜ä¸­</strong>ã€‚<strong>æœ¬åœ°å†…å­˜é€šå¸¸æ˜¯åŸºäºå…¨å±€å†…å­˜å®ç°</strong>çš„ï¼Œå› æ­¤åœ¨ç‰©ç†ä¸Šä½äº GPU æ¿è½½çš„ DRAM ä¸­ã€‚</p></li><li><p>é€Ÿåº¦ï¼šè®¿é—®é€Ÿåº¦è¾ƒæ…¢ã€‚ç”±äº<strong>æœ¬åœ°å†…å­˜æœ¬è´¨ä¸Šä¾èµ–äºå…¨å±€å†…å­˜ï¼Œå…¶è®¿é—®å»¶è¿Ÿè¾ƒé«˜ï¼Œä¸å…¨å±€å†…å­˜çš„è®¿é—®å»¶è¿Ÿç›¸å½“ï¼Œé€šå¸¸åœ¨å‡ ååˆ°å‡ ç™¾ä¸ªæ—¶é’Ÿå‘¨æœŸ</strong>ã€‚è€Œä¸”ï¼Œæœ¬åœ°å†…å­˜çš„è®¿é—®æ¨¡å¼å¯èƒ½ä¼šå¯¼è‡´é¢å¤–çš„æ€§èƒ½å¼€é”€ï¼Œä¾‹å¦‚å½“å¤šä¸ªçº¿ç¨‹çš„æœ¬åœ°å†…å­˜è®¿é—®å‘ç”Ÿå†²çªæ—¶ï¼Œä¼šè¿›ä¸€æ­¥é™ä½è®¿é—®æ•ˆç‡ã€‚</p></li><li><p>å®¹é‡å¤§å°ï¼šå®¹é‡ç›¸å¯¹è¾ƒå¤§ï¼Œå…¶å¤§å°ä¸å…¨å±€å†…å­˜ç›¸å…³ï¼Œå› ä¸º<strong>å®ƒæ˜¯å…¨å±€å†…å­˜çš„ä¸€éƒ¨åˆ†</strong>ã€‚ä½†å¯¹äºå•ä¸ªçº¿ç¨‹æ¥è¯´ï¼Œå…¶å¯ç”¨çš„æœ¬åœ°å†…å­˜ç©ºé—´ä¹Ÿå—åˆ°ä¸€å®šé™åˆ¶ï¼Œå¹¶ä¸”å…·ä½“å¤§å°å–å†³äº GPU çš„æ¶æ„å’Œé…ç½®ã€‚</p></li><li><p><strong>Local Memoryæ˜¯ç»™å¯„å­˜å™¨æº¢å‡ºï¼ˆregister spillï¼‰æƒ…å†µæ“¦å±è‚¡çš„ï¼</strong></p></li></ul><h3 id="_45-å¯„å­˜å™¨æº¢å‡º-register-spill-æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#_45-å¯„å­˜å™¨æº¢å‡º-register-spill-æ˜¯ä»€ä¹ˆ"><span>45. å¯„å­˜å™¨æº¢å‡ºï¼ˆregister spillï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ</span></a></h3><p>å¯„å­˜å™¨ä¸å¤Ÿç”¨äº†ï¼Œä¸å¾—ä¸æŠŠæ•°æ®å­˜åˆ°å†…å­˜ï¼›åœ¨å¯„å­˜å™¨æ•°é‡ä¸å¤Ÿç”¨çš„æ—¶å€™ï¼Œæ¯”å¦‚GEMMé‡Œé¢é€šå¸¸ä¸€ä¸ªçº¿ç¨‹ä¼šä½¿ç”¨å¾ˆå¤šå¯„å­˜å™¨ï¼›</p><p>åœ¨ç¼–ç¨‹æ—¶æ˜¯ä¸å¸Œæœ›å®ƒå‘ç”Ÿçš„ï¼Œå› ä¸ºå‘ç”Ÿäº†ä¸ç®¡å»å†…å­˜/æ˜¾å­˜/local memoryè¿˜æ˜¯L1 cacheé‡Œé¢è¯»ï¼Œå»¶è¿Ÿè¿œå¤§äºè¯»å¯„å­˜å™¨ï¼Œå› æ­¤ä¼šé™ä½æ€§èƒ½ã€‚</p><h3 id="_46-register-spillçš„è§£å†³æ–¹æ³•-å¦‚ä½•å‡å°‘register-pressure" tabindex="-1"><a class="header-anchor" href="#_46-register-spillçš„è§£å†³æ–¹æ³•-å¦‚ä½•å‡å°‘register-pressure"><span>46. register spillçš„è§£å†³æ–¹æ³•ï¼Ÿå¦‚ä½•å‡å°‘register pressureï¼Ÿ</span></a></h3><ol><li><p><strong>æ§åˆ¶å¾ªç¯å±•å¼€(loop unrolling)çš„æ•°é‡</strong>ã€‚ï¼ˆå¾ªç¯å±•å¼€æœ¬è´¨ä¸Šæ˜¯ç»™å¾ªç¯æ‹†å¼€éƒ½åˆ†é…ä¸€éå¯„å­˜å™¨ä»¥å¢åŠ å¹¶è¡Œåº¦ï¼Œå¾ˆç±»ä¼¼30é¢˜ã€‚è¿™æ ·å°±ä¼šé€ æˆå¯„å­˜å™¨å‹åŠ›è¾ƒå¤§ï¼‰ã€‚</p></li><li><p>å°†å˜é‡çš„å®šä¹‰ç§»åŠ¨åˆ°è¦ç”¨åˆ°å®ƒä¹‹å‰ï¼Œå¦‚ä¸‹ä»£ç ï¼š</p></li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">...</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> c </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ”¹ä¸ºï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">...</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> c </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>åœ¨kernelç­¾åå¤„è®¾ç½®launch_bounds<strong>é™åˆ¶MAX_THREADS_PER_BLOCKå’ŒMIN_BLOCKS_PER_SM</strong>ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶å°†ä¼šè°ƒæ•´å¯„å­˜å™¨ä½¿ç”¨é‡ï¼Œå‡å°‘å¯„å­˜å™¨å‹åŠ›ï¼Œä»è€Œå¢å¤§å æœ‰ç‡ï¼ˆå¦‚ä½•è°ƒæ•´å‘¢ï¼Œå®ƒä¼šè‡ªåŠ¨è°ƒæ•´è®©å¯„å­˜å™¨ä½¿ç”¨é‡è‡³å°‘æ»¡è¶³MIN_BLOCKS_PER_SMä¸€ä¸ªSMä¸Šçš„æœ€å°blocké©»ç•™æ•°ï¼‰</li></ol><p>ä¾‹å­ï¼š<br> åœºæ™¯ï¼šä¼˜åŒ–ä¸€ä¸ªå‘é‡åŠ æ³•å†…æ ¸ã€‚</p><p>æœªä½¿ç”¨ launch_bounds çš„ç‰ˆæœ¬</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">__global__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> vecAdd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> A, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> B, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> C, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> idx </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (idx </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N) </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">C</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[idx] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[idx] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> B</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[idx];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¼–è¯‘å™¨ä¸çŸ¥é“å†…æ ¸çš„é¢„æœŸblock sizeï¼Œå¯èƒ½æ¿€è¿›åˆ†é…å¯„å­˜å™¨ï¼Œå¯¼è‡´Occupancyè¾ƒä½ã€‚</p><p>ä½¿ç”¨ launch_bounds çš„ç‰ˆæœ¬</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// æç¤ºç¼–è¯‘å™¨ï¼šæ­¤å†…æ ¸å°†ç”¨256çº¿ç¨‹/blockï¼Œä¸”è‡³å°‘éœ€è¦4ä¸ªblock/SM</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">__global__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> __launch_bounds__</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">256</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">vecAdd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> A, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> B, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> C, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> idx </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (idx </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N) </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">C</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[idx] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[idx] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> B</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[idx];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¼–è¯‘å™¨ä¼šä¼˜å…ˆä¿è¯ï¼š</p><ul><li>æ¯ä¸ªçº¿ç¨‹å—ä½¿ç”¨ â‰¤ 256çº¿ç¨‹ï¼ˆå®é™…å¯åŠ¨æ—¶ä¹Ÿå¿…é¡»â‰¤256ï¼‰ã€‚</li><li>æ¯ä¸ªSMè‡³å°‘é©»ç•™4ä¸ªçº¿ç¨‹å—ï¼ˆä¼˜åŒ–å¯„å­˜å™¨åˆ†é…è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼‰ã€‚<br> åŒæ—¶ï¼Œä½ åœ¨mainå‡½æ•°é‡Œé¢å¯åŠ¨çš„gridå’Œblockéœ€è¦é…åˆlaunch boundsï¼Œå®é™…çº¿ç¨‹æ•°é‡ä¸èƒ½è¶…è¿‡256ã€‚</li></ul><p><strong>ä¸ºä»€ä¹ˆæ§åˆ¶SMä¸Šé©»ç•™çš„æœ€å°blockæ•°é‡å°±èƒ½æ§åˆ¶å¯„å­˜å™¨å‘¢ï¼Ÿ</strong></p><p>è¿™æ˜¯å› ä¸ºå¦‚æœä¸æ§åˆ¶SMçš„blockæ•°é‡ï¼ŒSMå¯èƒ½ä¼šæ¿€è¿›åœ°åˆ†é…è¿‡å¤šçš„å¯„å­˜å™¨ç»™ä¸€ä¸ªblockï¼Œè¿™æ ·çš„è¯å¦‚æœå¤šä¸ªblocké©»ç•™åˆ°è¯¥SMä¸Šå°±ä¼šé€ æˆåç»­çš„blockå¯„å­˜å™¨ä¸å¤Ÿç”¨ï¼Œä»è€Œé€ æˆregister spillã€‚è€Œè®¾ç½®æœ€å°blockæ•°é‡åï¼ˆæ¯”å¦‚4ä¸ªï¼‰ï¼Œåˆ™æ˜¯å‘Šè¯‰SMä½ åˆ†é…çš„å¯„å­˜å™¨è‡³å°‘è¦æ»¡è¶³æ¯”å¦‚4ä¸ªblockçš„éœ€æ±‚ã€‚</p><h3 id="_47-float4ç±»å‹çš„ä½œç”¨æ˜¯ä»€ä¹ˆ-æ˜¯å¦æ€»èƒ½å¸¦æ¥æ€§èƒ½çš„æå‡" tabindex="-1"><a class="header-anchor" href="#_47-float4ç±»å‹çš„ä½œç”¨æ˜¯ä»€ä¹ˆ-æ˜¯å¦æ€»èƒ½å¸¦æ¥æ€§èƒ½çš„æå‡"><span>47. float4ç±»å‹çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯å¦æ€»èƒ½å¸¦æ¥æ€§èƒ½çš„æå‡ï¼Ÿ</span></a></h3><p>float4æ˜¯ä½¿ç”¨ä¸€æ¡æŒ‡ä»¤åŒæ—¶è¯»å–äº†4ä¸ªå…ƒç´ ï¼Œç›¸æ¯”ä¼ ç»Ÿè¯»å–å‡å°‘äº†ä¸‰ä¸ªloadæŒ‡ä»¤ï¼Œä»è€Œå‡å°‘äº†è®¿å­˜å»¶è¿Ÿï¼Œå¢å¤§ä»¿å­˜å¸¦å®½ã€‚</p><p><strong>å®ƒå¹¶ä¸æ˜¯æ€»èƒ½å¸¦æ¥æ­£æ”¶ç›Šï¼Œç›¸åæœ‰å¯èƒ½é€ æˆè´Ÿæ”¶ç›Š</strong></p><p>20*32ä¸ªæ•°æ®ç”¨äº†float4è¯»å–ååªéœ€è¦5ä¸ªwarpï¼Œä¸ç”¨float4åˆ™éœ€è¦20ä¸ªwarpï¼Œå¯ç”¨çœ‹å‡ºçº¿ç¨‹æ•°é‡é™ä½äº†ï¼Œé‚£ä¹ˆè¿™æœ‰å¯èƒ½å½±å“äº†GPUçš„å¹¶è¡Œåº¦ï¼Œå æœ‰ç‡é™ä½ï¼Œï¼ˆ20ä¸ªwarpæ¯”5ä¸ªwarpå“ªä¸ªæ›´å¥½å‘¢ï¼Ÿä¸å¥½è¯´ï¼Œä½†æ˜¯ä¸€èˆ¬20ä¸ªwarpæ˜¯ä¿é™©ç‚¹ã€‚launch 20ä¸ªwarp stallçš„æ¦‚ç‡æ¯”è¾ƒä½ï¼Œå› ä¸ºå¯è°ƒåº¦çš„warpå˜å¤šäº†ã€‚N-cuçš„è¡¨ç°ä¸ºeligible warpsçš„æ¯”ä¾‹æ˜¯æ¯”è¾ƒé«˜çš„ï¼‰</p><p>æ‰€ä»¥åº”è¯¥æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„tradeoffç‚¹ï¼Œä½¿å¾—æ—¢æ²¡æœ‰å½±å“GPUå¹¶è¡Œåº¦ï¼Œä¹Ÿåˆ©ç”¨äº†float4å¯¹å¸¦å®½çš„ä¼˜åŠ¿ï¼Œè¿™ä¸ªä¸»è¦æ˜¯æ ¹æ®æ•°æ®é‡å†³å®šï¼Œä»¥åŠ<strong>ä½¿ç”¨nsight computeæ¥profileæŸ¥çœ‹warp stateå’Œ scheduler statisitcsçš„eligible warpsæ¯”ä¾‹ï¼Œå¦‚æœæ¯”ä¾‹å¤§ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨float4</strong>ï¼ˆè¿™ä¸ªæ¯”ä¾‹è¡¨ç¤ºå½“å‰cycleä¸‹å‘å°„warpçš„å¯é€‰æ‹©æ€§ï¼Œè¶Šå¤§ä»£è¡¨å¯é€‰æ‹©çš„warpæ•°è¶Šå¤šï¼Œä¸€èˆ¬è¦å¤§äº1ï¼‰</p><h3 id="_48-cuda-kernel-launchè€—æ—¶ä¸»è¦æ˜¯è€—åœ¨å“ªé‡Œ" tabindex="-1"><a class="header-anchor" href="#_48-cuda-kernel-launchè€—æ—¶ä¸»è¦æ˜¯è€—åœ¨å“ªé‡Œ"><span>48. CUDA kernel launchè€—æ—¶ä¸»è¦æ˜¯è€—åœ¨å“ªé‡Œï¼Ÿ</span></a></h3><p>ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹ä¸¤éƒ¨åˆ†ï¼š</p><ol><li><p>CUDA kernelæ˜¯<strong>ç”±CPUæäº¤åˆ°GPU kernel engine</strong>çš„ï¼Œè¿™ä¸ªæäº¤æ˜¯éœ€è¦è€—æ—¶çš„ã€‚</p></li><li><p>æäº¤ä¹‹åï¼Œéœ€è¦<strong>ç­‰å¾…èµ„æº</strong>ã€‚æ¯ä»£GPUçš„kernel engineæ•°é‡ä¸ä¸€æ ·ï¼Œä½†æ˜¯æ€»çš„æ¥è¯´ï¼Œæ¯ä¸€ä¸ªkerneléƒ½ä¼šè¿›å…¥åˆ°kernel engineï¼ˆå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªé˜Ÿåˆ—ï¼‰æ’é˜Ÿï¼Œå½“kernelçš„<strong>è¾“å…¥æ•°æ®é€šè¿‡copy engineæ‹·è´åˆ°äº†GPU</strong>ä¸”<strong>kernelå¤„äºkernel engineé˜Ÿå¤´æ—¶</strong>ï¼Œè¯¥kernelæ‰ä¼šè¢«æ‰§è¡Œã€‚</p></li></ol><h3 id="_49-gpuä¸Šçš„å¼‚æ­¥å’ŒåŒæ­¥æ˜¯ä»€ä¹ˆæ„æ€" tabindex="-1"><a class="header-anchor" href="#_49-gpuä¸Šçš„å¼‚æ­¥å’ŒåŒæ­¥æ˜¯ä»€ä¹ˆæ„æ€"><span>49. GPUä¸Šçš„å¼‚æ­¥å’ŒåŒæ­¥æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</span></a></h3><p>å¼‚æ­¥åˆ†ä¸¤ä¸ªï¼Œå…¶ä¸€æ˜¯æŒ‡<strong>CPUå’ŒGPUå¹¶è¡Œæ‰§è¡Œä»»åŠ¡</strong>ï¼Œå…¶äºŒæ˜¯GPUä¸Šçš„édefault streamé—´å¹¶è¡Œæ‰§è¡Œä»»åŠ¡ï¼ˆ<strong>GPU streamçš„å¼‚æ­¥</strong>ï¼‰ã€‚</p><p>åŒæ­¥æŒ‡CPUç­‰å¾…GPUçš„æ‰§è¡Œå®Œæˆå†æ‰§è¡Œä¸‹ä¸€æ­¥ä»»åŠ¡æˆ–è€…GPUä¸Šçš„streamç­‰å¾…å¦ä¸€ä¸ªstreamæ‰§è¡Œå®Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</p><h3 id="_50-ä»€ä¹ˆæ˜¯gpuçš„occupancy-å®ƒä¸»è¦å—å“ªäº›å› ç´ çš„å½±å“å‘¢" tabindex="-1"><a class="header-anchor" href="#_50-ä»€ä¹ˆæ˜¯gpuçš„occupancy-å®ƒä¸»è¦å—å“ªäº›å› ç´ çš„å½±å“å‘¢"><span>50. ä»€ä¹ˆæ˜¯GPUçš„occupancyï¼Ÿå®ƒä¸»è¦å—å“ªäº›å› ç´ çš„å½±å“å‘¢ï¼Ÿ</span></a></h3><p>occupancyæ˜¯<strong>æŒ‡SMä¸Šæ´»è·ƒçš„warpæˆ–blockæ•° é™¤ä»¥ è¯¥SMçš„æœ€å¤§æ´»åŠ¨warpæˆ–blockæ•°</strong>ã€‚</p><p>ä¸»è¦å—ä»¥ä¸‹å› ç´ çš„å½±å“ï¼š</p><p><strong>å¯„å­˜å™¨ç”¨é‡é™åˆ¶</strong>ï¼šå‡è®¾ä¸€ä¸ªSMä¸Šæœ€å¤šæä¾›65536ä¸ªå¯„å­˜å™¨ï¼Œè¯¥SMç†è®ºæ”¯æŒçš„æœ€å¤š48ä¸ªwarpæ´»è·ƒã€‚ç°åœ¨å‡è®¾ä¸€ä¸ªkernelä¸­çš„ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨56ä¸ªå¯„å­˜å™¨ï¼Œåˆ™å®ƒçš„occupancyç®—æ³•ä¸ºï¼šé¦–å…ˆè¯¥kernelçš„æ¯ä¸ªwarpå°†ä¼šä½¿ç”¨32*56ä¸ªå¯„å­˜å™¨ï¼Œåˆ™è¯¥kernelæœ€å¤šæœ‰<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>65536</mn><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>32</mn><mo>âˆ—</mo><mn>56</mn><mo stretchy="false">)</mo><mo>=</mo><mn>36</mn></mrow><annotation encoding="application/x-tex">65536/(32*56) = 36</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">65536/</span><span class="mopen">(</span><span class="mord">32</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">56</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">36</span></span></span></span>ä¸ªwarpæ´»è·ƒï¼Œåˆ™è¯¥kernelçš„occupancyä¸º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>36</mn><mi mathvariant="normal">/</mi><mn>48</mn><mo>=</mo><mn>0.75</mn></mrow><annotation encoding="application/x-tex">36/48 = 0.75</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">36/48</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.75</span></span></span></span>ã€‚</p><p><strong>Shared memç”¨é‡</strong> å‡è®¾ä¸€ä¸ªSMä¸Šæœ€å¤§smemä¸º32678bytesï¼Œè¯¥SMç†è®ºæ”¯æŒçš„æœ€å¤š48ä¸ªwarpæ´»è·ƒã€‚ç°åœ¨å‡è®¾ä¸€ä¸ªkernelä¸­çš„ä¸€ä¸ªblockï¼ˆ128çº¿ç¨‹ï¼‰ä½¿ç”¨5120bytesçš„smemï¼Œä¸”è¿˜æœ‰å›ºå®š1024bytesçš„ç³»ç»Ÿå ç”¨ï¼Œåˆ™å®ƒçš„occupancyç®—æ³•ä¸ºï¼šé¦–å…ˆè¯¥kernelçš„æ¯ä¸ªwarpå°†ä¼šä½¿ç”¨<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>5120</mn><mo>+</mo><mn>1024</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>4</mn><mo>=</mo><mn>1536</mn></mrow><annotation encoding="application/x-tex">(5120+1024)/4= 1536</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">5120</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1024</span><span class="mclose">)</span><span class="mord">/4</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1536</span></span></span></span>ä¸ªå­—èŠ‚çš„smemï¼Œåˆ™è¯¥kernelæœ€å¤šæœ‰<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>32678</mn><mi mathvariant="normal">/</mi><mn>1536</mn><mo>=</mo><mn>20</mn></mrow><annotation encoding="application/x-tex">32678/1536 = 20</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">32678/1536</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">20</span></span></span></span>ä¸ªwarpæ´»è·ƒï¼Œåˆ™è¯¥kernelçš„occupancyä¸º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn><mi mathvariant="normal">/</mi><mn>48</mn><mo>=</mo><mn>0.42</mn></mrow><annotation encoding="application/x-tex">20/48 = 0.42</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">20/48</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.42</span></span></span></span>ã€‚</p><p>å®é™…å æœ‰ç‡ä¸åŒäºç†è®ºå æœ‰ç‡ï¼Œå®ƒå—ä¸€äº›å…¶ä»–å› ç´ å½±å“æ¯”å¦‚è´Ÿè½½ä¸å‡è¡¡ï¼ˆ33é¢˜ï¼‰ï¼Œéœ€è¦å®é™…å»è·‘kernelï¼Œé€šè¿‡ncuæ¥åˆ¤æ–­å æœ‰ç‡çš„å¤§å°ï¼</p><h3 id="_51-å¯¹äºreduceç±»çš„ç®—å­-è€ƒè™‘shapeä¸º-m-n-n-1-reduceåçš„shapeä¸º-m-1-é‚£ä¹ˆå¯¹äºm-nçš„æƒ…å†µå¦‚ä½•åšä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_51-å¯¹äºreduceç±»çš„ç®—å­-è€ƒè™‘shapeä¸º-m-n-n-1-reduceåçš„shapeä¸º-m-1-é‚£ä¹ˆå¯¹äºm-nçš„æƒ…å†µå¦‚ä½•åšä¼˜åŒ–"><span>51. å¯¹äºreduceç±»çš„ç®—å­ï¼Œè€ƒè™‘shapeä¸º[M,N]ï¼ŒN&gt;1ï¼Œreduceåçš„shapeä¸º[M,1]ï¼Œé‚£ä¹ˆå¯¹äºM&gt;&gt;Nçš„æƒ…å†µå¦‚ä½•åšä¼˜åŒ–ï¼Ÿ</span></a></h3><p>å…¶å®reduceç®—å­æˆ‘ä»¬è§‰å¾—ä¼˜åŒ–ä¸ªå·®ä¸å¤šå°±å¤Ÿäº†ï¼Œå› ä¸ºè¿™ä¸ªç®—å­åœ¨æ¨¡å‹æ¨ç†ä¸­çš„ä½¿ç”¨é¢‘ç‡ä¸é«˜ï¼Œå¹¶ä¸”å³ä½¿æ ¹æ®ä¸åŒçš„é•¿åº¦å»åšé’ˆå¯¹æ€§çš„ä¼˜åŒ–ï¼Œæ€§èƒ½æå‡ä¹Ÿæœ‰é™ï¼Œå¯¹æ ¸å¿ƒçš„performanceå½±å“å¾ˆå°ã€‚å› æ­¤è¿™é‡Œåªæ˜¯å¯¹é¢è¯•çš„ä¸€ä¸ªè§£ç­”ï¼Œå›ç­”æ€è·¯å³å¯ã€‚</p><p>æ ¸å¿ƒï¼š<strong>å°½å¯èƒ½çš„ç”¨æ»¡GPU çš„ SM æ•°é‡</strong>ï¼Œfull waveå æ¯”é«˜ä¸€ç‚¹ï¼Œtail waveä¸­çš„å®é™…æ‰§è¡Œæ¯”ä¾‹ä¹Ÿè¦é«˜ä¸€ç‚¹ã€‚ä»¤å…¶å°½é‡ä¸ºsmsï¼ˆæ»¡SMæ•°é‡ï¼‰ã€‚</p><ol><li><p>å¯¹äºM,</p><ul><li><p>If M &lt; sms åˆ†é…Mä¸ªblockï¼Œæ¯ä¸ªblockçš„threadsæ•°é‡128 256 512ï¼ˆç»éªŒå€¼å³å¯ï¼‰</p></li><li><p>Else if sms &lt; M &lt; 2*sms åˆ†é…smsä¸ªblockï¼Œå†ç”¨forå¾ªç¯å¤„ç†å‰©ä½™M</p></li><li><p>Else if 2<em>sms &lt; M &lt; 3</em>sms åˆ†é…2*smsä¸ªblockï¼Œå†ç”¨forå¾ªç¯å¤„ç†å‰©ä½™M</p></li></ul></li><li><p>å¯¹äºNï¼Œ</p><ul><li><p>If N &lt; 1024, è¯¥è¡Œåˆ†é…1ä¸ªblockï¼Œæ¯ä¸ªblockå¾ªç¯å¤„ç†ceil(1024 / threads)æ¬¡</p></li><li><p>Else 1024 &lt; N &lt; 2048, æ”¹è¡Œåˆ†é…2ä¸ªblockï¼Œæ¯ä¸ªblockå¾ªç¯å¤„ç†ceil(1024 / threads)æ¬¡</p></li><li><p>Else a * 1024 &lt; N &lt; (a +1) * 1024, æ”¹è¡Œåˆ†é…a+1ä¸ªblockï¼Œæ¯ä¸ªblockå¾ªç¯å¤„ç†ceil(1024 / threads)æ¬¡</p></li></ul></li><li><p>å¯¹äºM&lt;&lt;N, =&gt; Næ–¹å‘åˆ†é…å¤šä¸ªblockå¤„ç†ï¼Œæ•°æ®ç›´æ¥ä»global memoryåˆ°registeråšreduceã€‚</p></li><li><p>å¯¹äºM&gt;&gt;N, =&gt; Næ–¹å‘åˆ†é…1ä¸ªblockå¤„ç†ï¼Œæ•°æ®å¯ä»¥å…ˆä¿å­˜åˆ°shared memoryå†reduceã€‚</p></li></ol><p>ä»¥ä¸Šï¼Œéæ ‡å‡†ç­”æ¡ˆï¼Œif elseåˆ†ç±»çš„è¶Šç»†ï¼Œåˆ†é…ç²’åº¦è¶Šç»†ï¼Œæ€§èƒ½è¶Šå¥½</p><h2 id="å…­-å¤§æ¨¡å‹é‡åŒ–" tabindex="-1"><a class="header-anchor" href="#å…­-å¤§æ¨¡å‹é‡åŒ–"><span>å…­. å¤§æ¨¡å‹é‡åŒ–</span></a></h2><h3 id="_52-ä»‹ç»ä¸€ä¸‹calibration-æ ¡å‡†-çš„åŸç†-ä¸ºä»€ä¹ˆè¦åšcalibration" tabindex="-1"><a class="header-anchor" href="#_52-ä»‹ç»ä¸€ä¸‹calibration-æ ¡å‡†-çš„åŸç†-ä¸ºä»€ä¹ˆè¦åšcalibration"><span>52. ä»‹ç»ä¸€ä¸‹calibration(æ ¡å‡†)çš„åŸç†ï¼Ÿä¸ºä»€ä¹ˆè¦åšcalibrationï¼Ÿ</span></a></h3><p>Calibrationç”¨äº<strong>ç¡®å®šæ¿€æ´»å€¼ï¼ˆActivationï¼‰ï¼ˆæ³¨æ„ä¸é’ˆå¯¹weightæƒé‡ï¼‰çš„ç¼©æ”¾å› å­ï¼ˆscaleï¼‰å’Œé›¶ç‚¹ï¼ˆzero-pointï¼‰ï¼Œä»¥ä¾¿å°†æµ®ç‚¹æ•°è½¬æ¢ä¸ºæ•´æ•°ï¼ˆå¦‚ INT8ï¼‰</strong>ã€‚åˆ©ç”¨æ ·æœ¬æ•°æ®å¯¹æ¨¡å‹è¿›è¡Œä¸€éæ¨ç†ï¼Œæ¨ç†ç»“æœä¸­æ±‚å‡ºscaleå’Œzero-pointï¼Œåç»­çš„é‡åŒ–è¿‡ç¨‹ä¸­æ ¹æ®è¿™ä¸¤ä¸ªå€¼æ¥é‡åŒ–æ¿€æ´»å€¼ã€‚</p><p>ä¸ºä»€ä¹ˆè¦åšå®ƒï¼Ÿ <strong>activationæ¿€æ´»å€¼çš„åŠ¨æ€å˜åŒ–èŒƒå›´å¤§</strong>ï¼Œæ‰€ä»¥éœ€è¦ç”¨çœŸå®æ•°æ®æå‰æ¨ç†ä¸€éæ‹¿åˆ°activationçš„èŒƒå›´ï¼Œä»¥æ­¤å‡å°activationçš„é‡åŒ–è¯¯å·®ã€‚</p><h3 id="_52-1-å…³äºcalibrationçš„ç®—æ³•è¯·ä»‹ç»å‡ ä¸ª" tabindex="-1"><a class="header-anchor" href="#_52-1-å…³äºcalibrationçš„ç®—æ³•è¯·ä»‹ç»å‡ ä¸ª"><span>52.1 å…³äºcalibrationçš„ç®—æ³•è¯·ä»‹ç»å‡ ä¸ªï¼Ÿ</span></a></h3><p>å®—æ—¨éƒ½æ˜¯æ‰¾å‡ºæœ€å°é‡åŒ–è¯¯å·®ï¼Œé‡åŒ–è¯¯å·®è¶Šå°ï¼Œé‡åŒ–ç²¾åº¦è¶Šé«˜ã€‚ä¾‹å¦‚æœ‰ï¼š</p><p><strong>minmax</strong>ï¼šç›´æ¥æ‹¿activationçš„å®æ—¶minå’Œmaxä»£å…¥ä¸‹é¢å…¬å¼</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mo>=</mo><mfrac><mrow><mi>m</mi><mi>a</mi><mi>x</mi><mo>âˆ’</mo><mi>m</mi><mi>i</mi><mi>n</mi></mrow><mrow><msup><mn>2</mn><mrow><mi>b</mi><mi>i</mi><mi>t</mi></mrow></msup><mo>âˆ’</mo><mn>1</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex">scale = \frac{max - min}{2^{bit}-1} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">sc</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1059em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3365em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7751em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">bi</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">min</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p><strong>KLæ•£åº¦</strong>ï¼š</p><ol><li>ç»Ÿè®¡æ¿€æ´»å€¼çš„ç›´æ–¹å›¾ï¼ˆHistogramï¼‰ï¼Œå¹¶å‡è®¾å…¶æœä»æŸç§æ¦‚ç‡åˆ†å¸ƒï¼ˆå¦‚é«˜æ–¯åˆ†å¸ƒï¼‰ã€‚</li><li>é€‰æ‹©ä¸€ä¸ªæœ€ä¼˜çš„æˆªæ–­ç‚¹ï¼ˆthresholdï¼‰ï¼Œå°†å¤§äºè¯¥é˜ˆå€¼çš„éƒ¨åˆ†æˆªæ–­ï¼Œå‡å°‘ outliers çš„å½±å“ã€‚</li><li>é€šè¿‡ KL æ•£åº¦ï¼ˆKullback-Leibler Divergenceï¼‰ è®¡ç®—é‡åŒ–ååˆ†å¸ƒå’ŒåŸå§‹åˆ†å¸ƒä¹‹é—´çš„è·ç¦»ï¼Œé€‰æ‹©æœ€ä¼˜é˜ˆå€¼ï¼Œæ­¤é˜ˆå€¼å³minå’Œmaxï¼Œç„¶åå†è¿ç”¨min maxç®—æ³•</li></ol><h3 id="_53-é‡åŒ–äº§ç”Ÿçš„ç²¾åº¦é—®é¢˜-ä¸€èˆ¬èƒ½é‡‡ç”¨ä»€ä¹ˆæ–¹æ³•æ¥è§£å†³" tabindex="-1"><a class="header-anchor" href="#_53-é‡åŒ–äº§ç”Ÿçš„ç²¾åº¦é—®é¢˜-ä¸€èˆ¬èƒ½é‡‡ç”¨ä»€ä¹ˆæ–¹æ³•æ¥è§£å†³"><span>53. é‡åŒ–äº§ç”Ÿçš„ç²¾åº¦é—®é¢˜ï¼Œä¸€èˆ¬èƒ½é‡‡ç”¨ä»€ä¹ˆæ–¹æ³•æ¥è§£å†³ï¼Ÿ</span></a></h3><p><strong>é€šè¿‡æ‰“å°çš„æ–¹æ³•ï¼Œæ‰¾åˆ°å“ªä¸ªopå’Œlayeré€ æˆçš„é—®é¢˜æ¯”è¾ƒå¤§</strong>ï¼š</p><ol><li><p>æ‰“å°fp32å’Œint8æ¯å±‚é‡åŒ–layerçš„å€¼å¹¶è®¡ç®—äºŒè€…é—´çš„è¯¯å·®ï¼ˆæ¯”å¦‚MSEï¼‰</p></li><li><p>æ ¹æ®MSEæ’åºï¼Œå¤§çš„ä¼˜å…ˆfall backå›fp32</p></li></ol><p><strong>é€šè¿‡ç»éªŒçš„æ–¹æ³•ï¼Œæ‰¾åˆ°å“ªä¸ªopå’Œlayeré€ æˆçš„é—®é¢˜æ¯”è¾ƒå¤§ï¼ˆä¸€èˆ¬æ˜¯ç¬¬ä¸€ä¸ªæˆ–è€…æœ€åä¸€ä¸ªlayerï¼‰</strong>ï¼š</p><ol><li>ç¬¬ä¸€ä¸ªé‡åŒ–çš„layerï¼Œå› å…¶é¦–å…ˆè¢«é‡åŒ–ï¼Œä½œä¸ºé‡åŒ–çš„å…¥å£ï¼Œå¼•èµ·çš„è¯¯å·®å¯èƒ½æœ€å¤§ï¼Œå¯ä»¥è¯•ç€å…ˆfall backã€‚</li><li>æœ€åä¸€ä¸ªé‡åŒ–çš„layerï¼Œå› å…¶æœ€åè¢«é‡åŒ–ï¼Œä½œä¸ºé‡åŒ–çš„å‡ºå£ï¼Œè¯¯å·®ç´¯è®¡æœ€å¤§ï¼Œå¯ä»¥è¯•ç€å…ˆfall backã€‚</li></ol><p><strong>äºŒåˆ†æ³•ï¼ˆç®—æ³•å±‚é¢è§£å†³ï¼‰</strong>ï¼š</p><p>ä¸æ–­fall backä¸€åŠæ‰€æœ‰é‡åŒ–layeræ•°é‡ï¼Œæœ€ç»ˆæ‰¾å‡ºå¼•èµ·è¯¯å·®çš„ç›®æ ‡layerã€‚</p><h2 id="ä¸ƒ-å¤§æ¨¡å‹æ¨ç†" tabindex="-1"><a class="header-anchor" href="#ä¸ƒ-å¤§æ¨¡å‹æ¨ç†"><span>ä¸ƒ. å¤§æ¨¡å‹æ¨ç†</span></a></h2><h3 id="_54-bert-transformerå’Œgpt-transformerçš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_54-bert-transformerå’Œgpt-transformerçš„åŒºåˆ«"><span>54 BERT transformerå’ŒGPT transformerçš„åŒºåˆ«ï¼Ÿ</span></a></h3><ol><li>Encoder vs Decoder</li><li>åŒå‘æ³¨æ„åŠ› vs å•å‘æ³¨æ„åŠ›ï¼Œå‰è€…è€ƒè™‘å·¦å³ä¸Šä¸‹æ–‡ç†è§£æ–‡æœ¬è¯­ä¹‰æ—¶æ›´å…¨é¢ï¼Œæ¯”å¦‚å®Œå½¢å¡«ç©ºï¼Œåè€…åªèƒ½çœ‹åˆ°è¿‡å¾€çš„tokenï¼Œç„¶åæ¥ç”Ÿæˆå°†æ¥çš„tokenã€‚</li><li>berté€šè¿‡Masked Language Modelï¼ˆMLMï¼‰çš„æ–¹å¼ï¼Œéšæœºæ©ç›–è¾“å…¥æ–‡æœ¬ä¸­çš„æŸäº›è¯ï¼Œç„¶åè®©æ¨¡å‹é¢„æµ‹è¿™äº›è¢«æ©ç›–çš„è¯ï¼Œç±»ä¼¼äºå®Œå½¢å¡«ç©ºï¼›gpté€šè¿‡é¢„æµ‹ä¸‹ä¸€ä¸ªè¯æ¥åšè®­ç»ƒ</li></ol><h3 id="_55-ä¸ºä»€ä¹ˆå½“å‰å¤§æ¨¡å‹éƒ½æ˜¯decoder-onlyæ¶æ„" tabindex="-1"><a class="header-anchor" href="#_55-ä¸ºä»€ä¹ˆå½“å‰å¤§æ¨¡å‹éƒ½æ˜¯decoder-onlyæ¶æ„"><span>55.ä¸ºä»€ä¹ˆå½“å‰å¤§æ¨¡å‹éƒ½æ˜¯Decoder-onlyæ¶æ„ï¼Ÿ</span></a></h3><p>æŠ„ç€èƒŒä¸€èƒŒ</p><ol><li>ä»ç ”ç©¶ç»éªŒä¸Šæ¥è®²ï¼Œè¯¥æ¶æ„å¯¹ä¸‹æ¸¸ä»»åŠ¡çš„Zero-shotå’ŒFew-shotä»»åŠ¡<strong>æ³›åŒ–èƒ½åŠ›æ›´å¼º</strong>ã€‚</li><li>ç›¸æ¯”äºåŒå‘æ³¨æ„åŠ›ï¼Œdecoderæ¶æ„çš„ä¸‹ä¸‰è§’çŸ©é˜µä¸ºæ»¡ç§©çŠ¶æ€ï¼Œ<strong>å»ºæ¨¡èƒ½åŠ›æ›´å¼º</strong>ã€‚</li><li>decoderæ¶æ„çš„kv cacheå¯ä»¥å¤ç”¨ï¼Œ<strong>å¯¹å¤šè½®å¯¹è¯æ›´åŠ å‹å¥½</strong>ã€‚</li><li>decoder only+ next tokené¢„æµ‹çš„æ¨¡å¼ï¼Œæ¯ä¸ªä½ç½®æ‰€èƒ½æ¥è§¦çš„ä¿¡æ¯ç›¸æ¯”å…¶ä»–æ¶æ„æœ‰é™ï¼Œå› æ­¤é¢„æµ‹ä¸‹ä¸€ä¸ªtokençš„éš¾åº¦æ›´å¤§ï¼Œè®­ç»ƒå‡ºçš„<strong>æ¨¡å‹é€šç”¨è¡¨å¾èƒ½åŠ›æ›´å¼º</strong>ã€‚</li></ol><h3 id="_56-ä¸ºä»€ä¹ˆå­˜åœ¨kv-cache-è€Œä¸å­˜åœ¨q-cache" tabindex="-1"><a class="header-anchor" href="#_56-ä¸ºä»€ä¹ˆå­˜åœ¨kv-cache-è€Œä¸å­˜åœ¨q-cache"><span>56. ä¸ºä»€ä¹ˆå­˜åœ¨kv cacheï¼Œè€Œä¸å­˜åœ¨q cacheï¼Ÿ</span></a></h3><figure><img src="/Notes/assets/img/56_1.4c20e720.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å¿½ç•¥1/sqrt(dk)ï¼Œ</p><figure><img src="/Notes/assets/img/56_2.38d5a3a9.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>åŠ å…¥Causal Maskä¼šå˜æˆè¿™æ ·:</p><p><img src="/Notes/assets/img/56_3.6f5638fc.png" alt="" loading="lazy"><br><img src="/Notes/assets/img/56_4.5ba17e1b.png" alt="" loading="lazy"></p><p>å¯ä»¥çœ‹å‡º<strong>åœ¨åºåˆ—çš„tä½ç½®ï¼ŒQåªæœ‰å½“å‰ä½ç½®çš„ qt å‚ä¸äº†è®¡ç®—ï¼Œè€ŒKå’ŒVå¤šä¸ªä½ç½®å‚ä¸äº†è®¡ç®—</strong>ï¼Œæ‰€ä»¥éœ€è¦KV Cacheï¼Œè€Œä¸éœ€è¦Q Cacheã€‚</p><p>é‚£æˆ‘ç°ç®—kvä¸å°±å¥½äº†ï¼Œä¸ºå•¥è¦å­˜ä¸‹æ¥å‘¢ï¼Ÿ</p><p>å…¶å®<strong>è®¡ç®— Kã€V çŸ©é˜µçš„è¿‡ç¨‹æ˜¯ä¸ªå…¸å‹çš„å†…å­˜å¯†é›†å‹è¿‡ç¨‹</strong>ï¼Œå®ƒéœ€è¦åŠ è½½æ¯ä¸€å±‚çš„ Kã€V linear weightã€‚ä¹Ÿå°±æ˜¯å¦‚æœä¸åšä»»ä½•ç¼“å­˜ï¼Œå‡è®¾ prompt é•¿åº¦å¾ˆçŸ­è€Œè¾“å‡ºé•¿åº¦æ¥è¿‘ token çš„æœ€å¤§é•¿åº¦ 4096ï¼Œåˆ°äº†æœ€åä¸€ä¸ª token çš„æ—¶å€™ï¼Œå•æ˜¯é‡å¤è®¡ç®—å‰é¢æ¯ä¸ª token çš„ Kã€V çŸ©é˜µï¼Œå°±éœ€è¦è¯»å–å†…å­˜ 4096 * layeræ•°é‡ * 2(kå’Œv) * hidden size * hidden size= 40T ï¼Œæ¯æ¬¡ 2 ä¸ªå­—èŠ‚ï¼Œè¦çŸ¥é“ H100 çš„æ˜¾å­˜å¸¦å®½åªæœ‰ 3.35 TB/sï¼Œ4090 æ›´æ˜¯åªæœ‰ 1 TB/sï¼Œè¿™å•æ˜¯æœ€åä¸€ä¸ª token å°±å¾—è€—æ‰ä¸€å¼ å¡å‡ åç§’çš„æ—¶é—´æ¥ç®—å‡ºkvã€‚è¿™æ ·ï¼Œtoken çš„è¾“å‡ºå°±ä¼šè¶Šæ¥è¶Šæ…¢ã€‚</p><p>å¯ä»¥çœ‹<a href="https://summer536.github.io/Notes/zh/posts/Deepseek_MLA.html" target="_blank" rel="noopener noreferrer">Deepseek_MLA.md</a>çš„1.3èŠ‚å¯¹kv cacheçš„æ˜¾å­˜å ç”¨è®¡ç®—è¿›è¡Œäº†åˆ†æã€‚</p><h3 id="_57-å¤§æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­-æ˜¯å“ªäº›éƒ¨åˆ†å ç”¨äº†æ˜¾å­˜-å¤§æ¨¡å‹æ¨ç†å‘¢" tabindex="-1"><a class="header-anchor" href="#_57-å¤§æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­-æ˜¯å“ªäº›éƒ¨åˆ†å ç”¨äº†æ˜¾å­˜-å¤§æ¨¡å‹æ¨ç†å‘¢"><span>57. å¤§æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ˜¯å“ªäº›éƒ¨åˆ†å ç”¨äº†æ˜¾å­˜ï¼Ÿå¤§æ¨¡å‹æ¨ç†å‘¢ï¼Ÿ</span></a></h3><p>å‚è€ƒèµ„æ–™ï¼š<a href="https://zhuanlan.zhihu.com/p/624740065" target="_blank" rel="noopener noreferrer">åˆ†ætransformeræ¨¡å‹çš„å‚æ•°é‡ã€è®¡ç®—é‡ã€ä¸­é—´æ¿€æ´»ã€KV cache - çŸ¥ä¹</a></p><ul><li><p>è®­ç»ƒï¼š<strong>weights(fp16/bf16) + gradient(fp16/bf16) + Adamä¼˜åŒ–å™¨ä¸€é˜¶åŠ¨é‡(fp32) + AdamäºŒé˜¶åŠ¨é‡(fp32)</strong> + Adamå­˜å‚¨å¤‡ä»½çš„weights(fp32)å’Œgradients(fp32)</p></li><li><p>æ¨ç†ï¼š<strong>weights(fp16) + kv cache(fp16)</strong> + ä¸­é—´æ¿€æ´»å€¼</p></li></ul><h3 id="_58-æ¥ä¸Šé¢˜-ç»™å®šå¤§æ¨¡å‹çš„å‚æ•°é‡-ä¼°è®¡è®­ç»ƒå’Œæ¨ç†çš„æ˜¾å­˜å ç”¨" tabindex="-1"><a class="header-anchor" href="#_58-æ¥ä¸Šé¢˜-ç»™å®šå¤§æ¨¡å‹çš„å‚æ•°é‡-ä¼°è®¡è®­ç»ƒå’Œæ¨ç†çš„æ˜¾å­˜å ç”¨"><span>58. æ¥ä¸Šé¢˜ï¼Œç»™å®šå¤§æ¨¡å‹çš„å‚æ•°é‡ï¼Œä¼°è®¡è®­ç»ƒå’Œæ¨ç†çš„æ˜¾å­˜å ç”¨</span></a></h3><p>å‚è€ƒèµ„æ–™ï¼š<a href="https://zhuanlan.zhihu.com/p/624740065" target="_blank" rel="noopener noreferrer">åˆ†ætransformeræ¨¡å‹çš„å‚æ•°é‡ã€è®¡ç®—é‡ã€ä¸­é—´æ¿€æ´»ã€KV cache - çŸ¥ä¹</a></p><p>å‡å¦‚ç°åœ¨æœ‰7bå¤§æ¨¡å‹,batch sizeä¸º8ï¼Œseqlenä¸º8192ï¼Œhidden_sizeä¸º4096ï¼Œlayeræ•°é‡ä¸º80</p><ul><li><p>è®­ç»ƒï¼š7 * 2(weights) + 7 * 2(gradient) + 7 * 4 * 2(Adamä¸€é˜¶å’ŒäºŒé˜¶åŠ¨é‡) + 7 * 4(Adamå­˜å‚¨å¤‡ä»½çš„weights) = 112GB<br><strong>ï¼ˆä¸€èˆ¬ä¼šå°†å¤‡ä»½çš„gradientsä¸¢æ‰ï¼‰</strong></p></li><li><p>æ¨ç†ï¼škv cache(fp16) = bs * seqlen * hidden_size * layer * 2(fp16) * 2(kå’Œv) = 8 * 8192 * 4096 * 80 * 2 * 2 = 85GB;<br> æ€»æ¨ç†æ˜¾å­˜å ç”¨ = 85GB + 7 * 2(weights) + ä¸­é—´æ¿€æ´»å€¼ï¼ˆæ¯å±‚çš„ä¸­é—´æ¿€æ´»éƒ½ä¸ä¼šå¤ç”¨ï¼Œç”¨å®Œå³åˆ é™¤ï¼Œå…¶å ç”¨å¯å¿½ç•¥ã€‚å¦‚æœéè¦è®¡ç®—çš„è¯ï¼Œç®—ä¸€ä¸ªæœ€å¤§çš„ä¸­é—´æ¿€æ´»å³Q*Kçš„è¾“å‡º(bs,num_heads,seqlen,seqlen)å³å¯ï¼‰ = 85GB + 14GB = 99GB</p></li></ul><h3 id="_59-è®²ä¸€ä¸‹deepseek-mlaæœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_59-è®²ä¸€ä¸‹deepseek-mlaæœºåˆ¶"><span>59. è®²ä¸€ä¸‹Deepseek MLAæœºåˆ¶</span></a></h3><p>è¯¦ç»†è§<a href="https://summer536.github.io/Notes/zh/posts/Deepseek_MLA.html" target="_blank" rel="noopener noreferrer">Deepseek_MLA.md</a><br><img src="/Notes/assets/img/59.9246615b.jpg" alt="" loading="lazy"></p><ol><li><strong>éRoPEéƒ¨åˆ†</strong>ï¼šqc=Wq * inputï¼Œkc=Wk * input, vc = Wv * <strong>inputä¸‰è€…çš„Wæ¢æˆäº†LoRAä¼¼çš„é™ç§©å’Œå‡ç§©çŸ©é˜µ</strong>ï¼Œå³q_no_rope=input * WDQ * WUQ, kvåŒç†</li><li><strong>RoPEéƒ¨åˆ†</strong>ï¼šä»…é’ˆå¯¹qkï¼Œä¸é’ˆå¯¹vï¼Œqå’Œkçš„ropeåˆ†é‡æ˜¯deepseeké¢å¤–å¢åŠ çš„ï¼Œhead sizeä¸º64ï¼Œq_ropeç”±input * WDQ * WQRå¾—åˆ°ï¼Œk_ropeç”±input * WKRå¾—åˆ°, kéœ€è¦åšBroadcastã€‚</li><li><strong>éropeéƒ¨åˆ†å’Œropeéƒ¨åˆ†concatèµ·æ¥</strong>å¾—åˆ°q=[qc;q_rope] k=[kc;k_rope]ï¼Œv=[vc]ï¼Œåœ¨naiveç‰ˆæœ¬ä¸­ï¼Œscale dot product attnå¤„<strong>naiveç‰ˆæœ¬ä»ç„¶æ˜¯MHA</strong>ã€‚</li><li>åœ¨ä¼˜åŒ–çš„çŸ©é˜µå¸æ”¶ç‰ˆæœ¬ä¸­(<a href="https://www.bilibili.com/video/BV1F5NvzbEdy/%EF%BC%89%EF%BC%8C" target="_blank" rel="noopener noreferrer">https://www.bilibili.com/video/BV1F5NvzbEdy/ï¼‰ï¼Œ</a> <strong>çŸ©é˜µå¸æ”¶ç‰ˆæœ¬ï¼šå«ropeéƒ¨åˆ†çš„qkåšMQAï¼Œä¸å«RoPEéƒ¨åˆ†åšMHA</strong>ã€‚</li></ol><h3 id="_60-mlaç›¸æ¯”äºmqaã€gqaã€mhaçš„ä¼˜åŠ¿" tabindex="-1"><a class="header-anchor" href="#_60-mlaç›¸æ¯”äºmqaã€gqaã€mhaçš„ä¼˜åŠ¿"><span>60. MLAç›¸æ¯”äºMQAã€GQAã€MHAçš„ä¼˜åŠ¿ï¼Ÿ</span></a></h3><p>è¯¦ç»†è§<a href="https://summer536.github.io/Notes/zh/posts/Deepseek_MLA.html" target="_blank" rel="noopener noreferrer">Deepseek_MLA.md</a>çš„2.4å°èŠ‚</p><p>MLAç¼“å­˜çš„Latent KVæ¯”è¾ƒçŸ­ï¼ˆç›¸å½“äº<strong>2.25ä¸ªMQAçš„ç¼“å­˜é‡</strong>ï¼‰ï¼Œä½†MLAæœ‰æ¢å¤å…¨head k,v çš„èƒ½åŠ›ï¼ˆé€šè¿‡WUQå’ŒWUKï¼‰ï¼Œ<strong>ç‰¹å¾è¡¨è¾¾èƒ½åŠ›æ˜¾è‘—æ¯”GQAã€MQAè¦å¼º</strong>ã€‚æ‰€ä»¥MLAèƒ½åšåˆ°<strong>åˆå¿«åˆçœåˆå¼º</strong>ã€‚</p><h3 id="_61-moeæ¨¡å‹ç›¸æ¯”äºémoeæ¨¡å‹çš„å˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_61-moeæ¨¡å‹ç›¸æ¯”äºémoeæ¨¡å‹çš„å˜åŒ–"><span>61. MoEæ¨¡å‹ç›¸æ¯”äºéMoEæ¨¡å‹çš„å˜åŒ–ï¼Ÿ</span></a></h3><p><img src="/Notes/assets/img/61.be5c0984.png" alt="" loading="lazy"><br> MLPï¼šæŒ‡FFNå‰é¦ˆç¥ç»ç½‘ç»œï¼Œæ˜¯transformerä¸­é™¤äº†self attentionä¹‹å¤–çš„å¦ä¸€ä¸ªé‡è¦çš„ç»„æˆéƒ¨åˆ†ã€‚</p><p>åŸæœ¬çš„éMoEæ¨¡å‹å…¶hidden_statesï¼ˆå³self attentionçš„è¾“å‡ºï¼‰ç›´æ¥é€åˆ°MLPå°±å¯ä»¥äº†ã€‚</p><p>ç°åœ¨MoEå°†MLPåˆ†ä¸ºäº†å„ä¸ªä¸“å®¶ï¼ˆdeepseekä¸­è¿˜å°†ä¸“å®¶åˆ†ä¸ºäº† <em>å…±äº«ä¸“å®¶(æ‰€æœ‰tokenå…¨éƒ¨ä½¿ç”¨)</em> ä»¥åŠ <em>è·¯ç”±ä¸“å®¶(tokenåˆ†å‘)</em> ä¸¤ç§ï¼‰ã€‚MoEä¸­æ¯ä¸ªtokenéœ€è¦ç»è¿‡é—¨æ§ç½‘ç»œ(<strong>Router</strong>)ï¼Œè®¡ç®—å‡ºæ¯ä¸ª<strong>ä¸“å®¶çš„æƒé‡</strong>ï¼Œç„¶åæ ¹æ®æƒé‡å°†tokené€åˆ°å¯¹åº”çš„<strong>ä¸“å®¶ä¸­è®¡ç®—ï¼Œè®¡ç®—è¿‡ç¨‹ä¾ç„¶æ˜¯MLP</strong>ã€‚æœ€åå†å¤šä¸ªä¸“å®¶è®¡ç®—å‡ºæ¥çš„<strong>weightåšä¸€ä¸ªåŠ æƒå’Œ</strong>ç„¶åå†è¾“å‡ºã€‚</p><h3 id="_62-ä»¥ä¸Šmoe-kernelçš„æ½œåœ¨ä¼˜åŒ–ç‚¹" tabindex="-1"><a class="header-anchor" href="#_62-ä»¥ä¸Šmoe-kernelçš„æ½œåœ¨ä¼˜åŒ–ç‚¹"><span>62. ä»¥ä¸ŠMoE kernelçš„æ½œåœ¨ä¼˜åŒ–ç‚¹ï¼Ÿ</span></a></h3><figure><img src="/Notes/assets/img/62.80f6fbef.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å…ˆè®²å•å¡ï¼š</p><ol><li>routered expertï¼ˆä¸Šå›¾ä¸­é—´çº¢æ¡†ï¼‰çš„ä¼˜åŒ–ï¼š<strong>ä¸åŒè·¯ç”±ä¸“å®¶é—´çš„æƒé‡è®¡ç®—å¯ä»¥é‡‡ç”¨Group GEMM</strong>æ¥åŠ é€Ÿï¼Œå¹¶ä¸”å¯ä»¥<strong>èåˆSwiglu</strong>çš„åšèåˆç®—å­å‡å°launchå¼€é”€ã€‚</li></ol><ul><li>æ™®é€šGEMMï¼šä¸€æ¬¡è°ƒç”¨å¤„ç†ä¸€ä¸ªçŸ©é˜µä¹˜ï¼Œä¸»è¦ç”¨äºå¸¸è§„çš„çŸ©é˜µä¹˜æ³•ã€‚</li><li>Batch GEMMï¼šå¤šä¸ªç‹¬ç«‹ GEMMä¸€æ¬¡ kernel å¯åŠ¨å¹¶è¡Œè®¡ç®—ã€‚ä¸»è¦ç”¨äºå‡ ä¸ªå…±äº«ä¸“å®¶æƒé‡çš„å¹¶è¡Œè®¡ç®—ã€‚</li><li><strong>Group GEMM</strong>ï¼šåŒæ ·é€‚ç”¨äºå¤šä¸ªç‹¬ç«‹GEMMåŒæ—¶è®¡ç®—ï¼Œå¹¶ä¸”å®ƒå…è®¸ä¸€ç»„ GEMM çš„çŸ©é˜µå¤§å°ä¸åŒã€‚ä¸»è¦ç”¨äºä¸åŒè·¯ç”±ä¸“å®¶é—´çš„æƒé‡è®¡ç®—ã€‚Batch gemmå°±æ˜¯Group gemmçš„ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚</li><li>è¿™é‡Œé‡ç‚¹è®²ä¸€ä¸‹ä¸åŒè·¯ç”±ä¸“å®¶é—´çš„æƒé‡è®¡ç®—çš„ä¼˜åŒ–æ€è·¯ï¼š é¦–å…ˆä¸åŒä¸“å®¶åˆ†é…å¾—åˆ°çš„Tokençš„idå’Œæ•°é‡éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œæœ‰çš„å¤šæœ‰çš„å°‘ï¼Œä¹Ÿå°±æ˜¯çŸ©é˜µä¹˜ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>âˆ—</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A*B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> çš„Ashapeï¼ˆå› ä¸ºtokenæ•°ä¸ä¸€æ ·ï¼Œè¯¥çŸ©é˜µè¡Œæ•°ä¸ä¸€æ ·ï¼‰ä¸åŒï¼›ä¸æ­¤åŒæ—¶ä¸åŒä¸“å®¶çš„weightä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯çŸ©é˜µä¹˜ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>âˆ—</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A*B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> çš„Bå¤§å°ä¸åŒã€‚æ‰€ä»¥è¿™æ—¶æœ€naiveçš„åŠæ³•å°±æ˜¯å¯¹æ¯ä¸ªä¸“å®¶éƒ½launchä¸€ä¸ªGEMMè®©ä»–ä»¬åˆ†åˆ«è®¡ç®—ï¼›å…¶æ¬¡æƒ³åˆ°çš„ä¼˜åŒ–æ‰‹æ®µå°±æ˜¯å°†Açš„shape paddingåˆ°ä¸€æ ·ï¼Œç„¶åå°±å¯ä»¥åšBatchGEMMäº†ï¼›æœ€åçš„ä¼˜åŒ–å°±æ˜¯ä½¿ç”¨GroupGEMMï¼Œå®ƒå…è®¸Açš„shapeä¸åŒï¼Œéå¸¸é€‚ç”¨äºè¿™é‡Œã€‚</li></ul><ol start="2"><li>åšä¸€äº›<strong>kernelç®—å­çš„ä¼˜åŒ–</strong>ï¼šæ¯”å¦‚ä¼˜åŒ–TopK kernelï¼Œsort kernelï¼ˆè°ƒcub::Sortï¼‰ç­‰ã€‚</li></ol><p>å†è®²å¤šå¡ï¼ˆå¤šGPUé—´åšEPä¸“å®¶å¹¶è¡Œï¼‰ï¼š</p><p>éœ€è¦ä¼˜åŒ–3å’Œ4ä¸¤ä¸ªç®—å­çš„æ€§èƒ½ï¼Œä¸»è¦æ˜¯é€šä¿¡çš„å¼€é”€ã€‚</p><ol start="3"><li><p>all to all dispatchï¼šè´Ÿè´£ä¸Šå›¾ä¸­copy_input_tokenså³ä¾§ç®­å¤´çš„tokenåˆ†å‘</p></li><li><p>all to all combineï¼šè´Ÿè´£ä¸Šå›¾ä¸­routered expertsçº¢æ¡†ä¸‹æ–¹çš„unpermutedï¼Œè·¨å¡çš„tokenèšåˆã€‚å¹¶ä¸”è¿™ä¸ªæ˜¯unpermutedæ˜¯å¯ä»¥å’Œä¸‹æ–¹çš„reduce_outputåšç®—å­çš„èåˆçš„ã€‚</p></li></ol><ul><li><a href="https://zhuanlan.zhihu.com/p/28867733102" target="_blank" rel="noopener noreferrer">ä¸€ç‚¹æµ…è§ï¼šdeepep ä¸ºä»€ä¹ˆå¿«ï¼Ÿ</a>è¿™ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»äº†all to all dispatchä»¥åŠall to all combineçš„æ¦‚å¿µå’Œä¼˜åŒ–ã€‚ç®€è¨€ä¹‹ï¼Œå‰è€…å°±æ˜¯åštokenç»™ä¸åŒè·¯ç”±ä¸“å®¶çš„åˆ†å‘ï¼Œåè€…å°±æ˜¯åšä¸åŒè·¯ç”±ä¸“å®¶çš„è®¡ç®—ç»“æœçš„èšåˆã€‚</li></ul><h3 id="_63-æ¨ç†å’Œè®­ç»ƒçš„gpuçš„ä¾§é‡æ€§" tabindex="-1"><a class="header-anchor" href="#_63-æ¨ç†å’Œè®­ç»ƒçš„gpuçš„ä¾§é‡æ€§"><span>63. æ¨ç†å’Œè®­ç»ƒçš„GPUçš„ä¾§é‡æ€§ï¼š</span></a></h3><p><strong>è®­ç»ƒè¦ç”¨é«˜ç«¯å¤§å¡ï¼Œæ¨ç†æ€§èƒ½ä½çš„å¡å°±å¯ä»¥ã€‚</strong></p><p><strong>è®­ç»ƒéœ€è¦é«˜é€šä¿¡å¸¦å®½ï¼Œé«˜ç²¾åº¦æµ®ç‚¹è¿ç®—</strong></p><p><strong>è®­ç»ƒè¦ç”¨é«˜ç²¾åº¦FP32,BF16ï¼›æ¨ç†ä½ç²¾åº¦å³å¯FP16ï¼ŒINT8</strong></p><figure><img src="/Notes/assets/img/63.a76bdfe6.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_64-æˆ‘ä»¬éƒ½çŸ¥é“éšç€å¥å­é•¿åº¦seqlençš„å¢åŠ -ä¼¼ä¹transformerçš„è®¡ç®—é‡è¶Šæ¥è¶Šå¤š-é‚£ä¹ˆå¯¹äºencoderè€Œè¨€-seqlençš„å¢åŠ -è®¡ç®—é‡ã€è®¿å­˜é‡å’Œè®¡ç®—å¯†åº¦æ˜¯ä¸€ç›´å¢åŠ å—-å¯¹äºdecoderå‘¢" tabindex="-1"><a class="header-anchor" href="#_64-æˆ‘ä»¬éƒ½çŸ¥é“éšç€å¥å­é•¿åº¦seqlençš„å¢åŠ -ä¼¼ä¹transformerçš„è®¡ç®—é‡è¶Šæ¥è¶Šå¤š-é‚£ä¹ˆå¯¹äºencoderè€Œè¨€-seqlençš„å¢åŠ -è®¡ç®—é‡ã€è®¿å­˜é‡å’Œè®¡ç®—å¯†åº¦æ˜¯ä¸€ç›´å¢åŠ å—-å¯¹äºdecoderå‘¢"><span>64. æˆ‘ä»¬éƒ½çŸ¥é“éšç€å¥å­é•¿åº¦seqlençš„å¢åŠ ï¼Œä¼¼ä¹transformerçš„è®¡ç®—é‡è¶Šæ¥è¶Šå¤šï¼Œé‚£ä¹ˆå¯¹äºencoderè€Œè¨€ï¼Œseqlençš„å¢åŠ ï¼Œè®¡ç®—é‡ã€è®¿å­˜é‡å’Œè®¡ç®—å¯†åº¦æ˜¯ä¸€ç›´å¢åŠ å—ï¼Ÿå¯¹äºdecoderå‘¢ï¼Ÿ</span></a></h3><p><a href="https://arxiv.org/abs/2302.14017" target="_blank" rel="noopener noreferrer">å‚è€ƒè®ºæ–‡</a></p><p>encoder(bert)å’Œdecoder(gpt2)çš„<strong>è®¡ç®—é‡</strong>å’Œ<strong>è®¿å­˜é‡</strong>éšseqlençš„å˜åŒ–:</p><figure><img src="/Notes/assets/img/64.bd59b14a.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol><li>å·¦å›¾æ˜¾ç¤ºäºŒè€…è®¡ç®—é‡éšseqlenæ˜¯çº¿æ€§å¢åŠ çš„ã€‚</li><li>å³å›¾æ˜¾ç¤ºäºŒè€…è®¿å­˜é‡GPT2æ˜¯å¢åŠ å¾ˆå¤šçš„ï¼ŒåŸå› æ˜¯decodeæ˜¯ç”Ÿæˆå¼æ¨¡å‹ï¼Œéšç€seqlençš„å¢åŠ ï¼Œç”Ÿæˆä¸‹ä¸€ä¸ªtokenéœ€è¦è®¿é—®çš„kv cacheä¼šè¶Šæ¥è¶Šå¤šã€‚</li></ol><p>encoder(bert)å’Œdecoder(gpt2)çš„<strong>è®¡ç®—å¯†åº¦</strong>ï¼ˆ=è®¡ç®—é‡/è®¿å­˜é‡ï¼‰éšseqlençš„å˜åŒ–ï¼š<br><img src="/Notes/assets/img/64_2.69bf547e.png" alt="" loading="lazy"></p><ol start="3"><li>è¿™é‡Œæœ‰ä¸ªæœ‰è¶£çš„ç°è±¡ï¼Œ<strong>bertçš„è®¡ç®—å¯†åº¦æ˜¯å…ˆå¢å¤§åå‡å°çš„</strong>ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</li></ol><ul><li>è¿™æ˜¯å› ä¸ºåœ¨attentioné‡Œé¢ <strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo>âˆ—</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">q * k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6597em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></strong> å¾—åˆ°çš„ S çš„ shape æ˜¯ [batch size, head num, seqlen, seqlen] ï¼Œ<strong>è®¡ç®—é‡å’Œseqlenæˆå¹³æ–¹é˜¶</strong>ï¼Œä»¥åŠ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo>âˆ—</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">q*k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6597em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> åé¢çš„ <strong>attention mask å’Œ softmax ç­‰ elementwise æ“ä½œ</strong>çš„<strong>è®¿å­˜é‡å¢é•¿ä¹Ÿå’Œ seqlen æˆå¹³æ–¹é˜¶</strong>ï¼Œæ‰€ä»¥éšç€ seqlen çš„é€æ¸å¢å¤§ï¼Œberté‡Œé¢çš„è®¡ç®—é‡å’Œè®¿å­˜é‡éƒ½ä¼šå¢åŠ ã€‚</li><li>å¹¶ä¸”<strong>seqlenå°çš„æ—¶å€™</strong>æ•´ä¸ªæ¨¡å‹å±‚é¢<strong>FFN</strong>ï¼ˆbatch size, seqlenï¼Œhidden size)*(hidden size, hidden size)ç›¸å¯¹attentionçš„è®¿å­˜é‡å’Œè®¡ç®—é‡<strong>å‘ˆä¸»å¯¼</strong>è¶‹åŠ¿ï¼Œæ‰€ä»¥æ­¤æ—¶è®¡ç®—å¯†åº¦å¢å¤§</li><li>ä½†æ˜¯seqlenè¾¾åˆ°æŸä¸ªæ‹ç‚¹åï¼ˆ<strong>seqlen&gt;hiddensizeå</strong>) <strong>attention å¼€å§‹å‘ˆä¸»å¯¼è¶‹åŠ¿</strong>ï¼Œè®¿å­˜é‡ç”±äº<strong>attention maskå’Œsoftmaxçš„å­˜åœ¨å¢é•¿çš„æ›´å¤šï¼Œæ‰€ä»¥è®¡ç®—å¯†åº¦æ€»ä½“å‘ˆå‡å°</strong>æ€åŠ¿ã€‚</li></ul><ol start="4"><li><strong>GPTçš„è®¡ç®—å¯†åº¦å§‹ç»ˆæ²¡å˜</strong>ï¼Œè¿™æ˜¯å› ä¸ºdecodeé˜¶æ®µseqlenå§‹ç»ˆä¸º1ï¼Œåªå¯¹k lenæœ‰å½±å“ï¼Œå¢åŠ çš„è®¡ç®—é‡å’Œè®¿å­˜é‡æ¯”ä¾‹å¤§è‡´ç›¸ç­‰ï¼Œæ‰€ä»¥æ•´ä½“è®¡ç®—å¯†åº¦ç¨³å®šã€‚</li></ol><h3 id="_65-flash-attention-v1è§£å†³äº†ä»€ä¹ˆé—®é¢˜-å®ƒå¯ä»¥ç›´æ¥ç”¨äºæ¨ç†å—" tabindex="-1"><a class="header-anchor" href="#_65-flash-attention-v1è§£å†³äº†ä»€ä¹ˆé—®é¢˜-å®ƒå¯ä»¥ç›´æ¥ç”¨äºæ¨ç†å—"><span>65. Flash attention V1è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Œå®ƒå¯ä»¥ç›´æ¥ç”¨äºæ¨ç†å—ï¼Ÿ</span></a></h3><p>è¯¦ç»†è§<a href="https://summer536.github.io/Notes/zh/posts/flashattention.html" target="_blank" rel="noopener noreferrer">Flashattention.md</a></p><p><img src="/Notes/assets/img/65.b61a8a9d.png" alt="" loading="lazy"><br> ä¸Šå›¾self attentionç®—å­ä¸­å¦‚æœä¸åšç®—å­èåˆï¼Œä»–ä»¬éƒ½æ˜¯[seqlen, seqlen]çš„ä¸­é—´bufferï¼Œå ç”¨çš„æ˜¾å­˜ç©ºé—´å¾ˆå¤§çš„ã€‚Flash attention V1åšçš„å°±æ˜¯åšè¿™äº›ç®—å­çš„èåˆã€‚</p><p><strong>ä¸å¯ä»¥ç›´æ¥ç”¨äºæ¨ç†ï¼Œåç»­æœ‰ä¸“é—¨çš„flash-decoding æ¥åšæ¨ç†ä¸Šçš„ä¼˜åŒ–ï¼ˆæœ¬è´¨ä¸Šæ˜¯åœ¨K lenç»´åº¦åšäº†å¹¶è¡Œï¼‰ã€‚</strong> è§81é¢˜ã€‚</p><h3 id="_66-vllmæå‡ºçš„kv-cacheç®¡ç†æœºåˆ¶è§£å†³äº†ä»€ä¹ˆé—®é¢˜" tabindex="-1"><a class="header-anchor" href="#_66-vllmæå‡ºçš„kv-cacheç®¡ç†æœºåˆ¶è§£å†³äº†ä»€ä¹ˆé—®é¢˜"><span>66. vLLMæå‡ºçš„kv cacheç®¡ç†æœºåˆ¶è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ</span></a></h3><p>å»ºè®®æœ‰æ—¶é—´ä¸€å®šè¦ç²¾è¯»paper:ã€Š<a href="https://arxiv.org/pdf/2309.06180" target="_blank" rel="noopener noreferrer">Efficient Memory Management for Large Language Model Serving with PagedAttention</a>ã€‹æœ‰è®²å…³äºparallel samplingçš„kv cacheèŠ‚çº¦ï¼›</p><p>å¦‚ä¸‹ï¼Œåœ¨è¯¥æœºåˆ¶æå‡ºä¹‹å‰ï¼Œkv cacheåªæœ‰<strong>ä¸è¶…è¿‡40%çš„å­˜å‚¨ç”¨æ¥å­˜å‚¨tokençš„hidden states</strong>ï¼Œå…¶å®ƒç©ºé—´ä¸º<strong>é¢„ç•™çš„ç©ºé—´</strong>ã€<strong>å†…éƒ¨ç¢ç‰‡</strong>(kv cacheä¸ºmax seq lenè€Œç•™ï¼‰ã€<strong>å¤–éƒ¨ç¢ç‰‡</strong>ï¼ˆä¸»è¦æ˜¯new mallocé€ æˆçš„ï¼‰</p><figure><img src="/Notes/assets/img/66.2a10bdf5.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_67-vllmæå‡ºçš„kv-cacheç®¡ç†æœºåˆ¶å…·ä½“æ˜¯æ€ä¹ˆæ ·çš„æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_67-vllmæå‡ºçš„kv-cacheç®¡ç†æœºåˆ¶å…·ä½“æ˜¯æ€ä¹ˆæ ·çš„æœºåˆ¶"><span>67. vLLMæå‡ºçš„kv cacheç®¡ç†æœºåˆ¶å…·ä½“æ˜¯æ€ä¹ˆæ ·çš„æœºåˆ¶ï¼Ÿ</span></a></h3><p><strong>ä»¥blockä¸ºç²’åº¦æ¥ç®¡ç†kv cache</strong>ï¼Œblock sizeä¸ºä¸€ä¸ªblockçš„slotæ•°é‡ï¼Œä¸€ä¸ªslotä»£è¡¨ä¸€ä¸ªtokençš„hidden unitsï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæœ€å¤šæµªè´¹æœ€åä¸€ä¸ªblockçš„å®¹é‡ï¼Œå³block3çš„å‰©ä½™æœªå¡«æ»¡çš„slotsï¼Œç›¸æ¯”ä¹‹å‰ï¼Œæå¤§çš„å‡å°äº†æµªè´¹çš„æ˜¾å­˜ã€‚</p><p><img src="/Notes/assets/img/67_1.1596e672.png" alt="" loading="lazy"><br><img src="/Notes/assets/img/67_3.9d47b858.png" alt="" loading="lazy"></p><p>å¦‚ä¸Šå›¾ï¼Œblocksizeè®¾ç½®ä¸ºäº†4ï¼Œå®ƒä»…ä»…æµªè´¹äº†Block3çš„3ä¸ªslotsï¼Œä»¥åŠBlock5çš„1ä¸ªslotsã€‚</p><h3 id="_68-å¦‚æœdecoding-algorithmä¸ºbeam-search-vllmä¼šå¯¹kv-cacheå¦‚ä½•ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#_68-å¦‚æœdecoding-algorithmä¸ºbeam-search-vllmä¼šå¯¹kv-cacheå¦‚ä½•ç®¡ç†"><span>68. å¦‚æœdecoding algorithmä¸ºbeam searchï¼ŒvLLMä¼šå¯¹kv cacheå¦‚ä½•ç®¡ç†ï¼Ÿ</span></a></h3><p>Bearm searchç°åœ¨å…³æ³¨åº¦æ¯”è¾ƒä½äº†ï¼Œçœ‹çœ‹å°±è¡Œ<br><img src="/Notes/assets/img/68_1.a26f6209.png" alt="" loading="lazy"><br><img src="/Notes/assets/img/68_2.991c43fc.png" alt="" loading="lazy"><br> å‡å¦‚beam width=4ï¼ŒåŸºäº<strong>shared block</strong>å’Œ<strong>copy on write blockæœºåˆ¶</strong>ï¼Œblock0ä¸º4ä¸ªå€™é€‰äººsharedçš„blockï¼Œå› ä¸º æ­¤åˆ»4ä¸ªå€™é€‰äººçš„å†…å®¹æ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚éƒ½æ˜¯&quot;ä½ æ˜¯å´å½¦ç¥–&quot;ï¼›ä¸‹ä¸€ä¸ªæ—¶åˆ»ï¼Œå€™é€‰äºº3å¼€å§‹åˆ†å‰ï¼Œè¯´æ˜å®ƒçš„ç”Ÿæˆå†…å®¹å’Œå¦å¤–ä¸‰ä¸ªä¸åŒäº†ï¼Œæ¯”å¦‚å€™é€‰äºº012æ­¤æ—¶ä¸º&quot;ä½ æ˜¯å´å½¦ç¥–ï¼Œé‚£æˆ‘æ˜¯è°&quot;ï¼Œå€™é€‰äºº3ä¸º&quot;ä½ æ˜¯å´å½¦ç¥–ï¼Œä½ å¥½å¸…å•Š&quot;ï¼›ä¸‹ä¸€ä¸ªæ—¶åˆ»ï¼Œç±»ä¼¼ï¼›ä¸‹ä¸€ä¸ªæ—¶åˆ»ï¼Œ4ä¸ªå€™é€‰äººç”Ÿæˆçš„å†…å®¹éƒ½ä¸ä¸€æ ·äº†ï¼Œæ‰€ä»¥é€šè¿‡copy on writeç”Ÿæˆäº†block5å’Œ7ï¼Œæ­¤æ—¶å€™é€‰äºº0çš„å¥å­çš„kvå°±ä¿å­˜åœ¨block0135ï¼Œå€™é€‰äºº2çš„å¥å­çš„kvå°±ä¿å­˜åœ¨block0137ï¼›ä¸‹ä¸€ä¸ªæ—¶åˆ»ï¼Œå€™é€‰äºº1å’Œ2çš„ä¸¤ä¸ªbeamä¸º4*4=16ä¸ªbeamä¸­çš„top4ï¼Œè¢«é€‰ä¸­ç»§ç»­åšbeam searchï¼Œäºæ˜¯ï¼Œä¹‹å‰å€™é€‰äºº0å’Œ3çš„block5å’Œblock8å°±æ²¡ç”¨äº†ï¼Œå¼•ç”¨è®¡æ•°ä¸º0ï¼Œè¢«é‡Šæ”¾æ‰ã€‚<br> ç”±æ­¤æ¥æœ€å¤§ç¨‹åº¦èŠ‚çº¦kv cache blockçš„åˆ†é…ã€‚</p><h3 id="_69-vllmä½œä¸ºä¸€ä¸ªservingæ¡†æ¶-æå‡ºçš„è¯·æ±‚scheduleæœºåˆ¶è§£å†³äº†ä»€ä¹ˆé—®é¢˜" tabindex="-1"><a class="header-anchor" href="#_69-vllmä½œä¸ºä¸€ä¸ªservingæ¡†æ¶-æå‡ºçš„è¯·æ±‚scheduleæœºåˆ¶è§£å†³äº†ä»€ä¹ˆé—®é¢˜"><span>69. vLLMä½œä¸ºä¸€ä¸ªservingæ¡†æ¶ï¼Œæå‡ºçš„è¯·æ±‚scheduleæœºåˆ¶è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ</span></a></h3><p>ä¸»è¦æ˜¯è§£å†³äº†<strong>early-finished</strong>å’Œ<strong>late-joining</strong>çš„é—®é¢˜ï¼Œå¦‚ä¸‹å›¾x1å’Œx2ä¸¤ä¸ªå¥å­æ‰“åŒ…ä¸ºä¸€ä¸ªbatché€åˆ°æ¨ç†å¼•æ“ï¼Œx2åœ¨iter2ç”Ÿæˆyouä¹‹åå°±ç»“æŸäº†ï¼Œè¿™ä¸ªå³early-finishedï¼Œç„¶è€Œx1è¦åˆ°iter4æ‰ç»“æŸï¼Œè¿™ä½¿å¾—x2ä¸å¾—ä¸ç­‰å¾…åˆ°iter4æ‰èƒ½é‡Šæ”¾ï¼Œé‚£ä¹ˆåœ¨è¯·æ±‚é˜Ÿåˆ—é‡Œæ’é˜Ÿç­‰å¾…çš„è¯·æ±‚å°±åªæœ‰åœ¨iter5æ‰å¼€å§‹è¢«é€åˆ°æ¨ç†å¼•æ“ï¼Œè¿™ä¸ªå³late-joiningã€‚</p><p><strong>continuous batching = iteration level schedule</strong></p><figure><img src="/Notes/assets/img/69.ffe5c5b4.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_70-ä»‹ç»ä¸€ä¸‹iteration-level-schedule" tabindex="-1"><a class="header-anchor" href="#_70-ä»‹ç»ä¸€ä¸‹iteration-level-schedule"><span>70. ä»‹ç»ä¸€ä¸‹iteration level scheduleï¼Ÿ</span></a></h3><p>iter-level scheduleã€‚ä¸Šé¢˜é‚£ç§request-level scheduleï¼Œé€ æˆäº†early finishedå’Œlate joiningï¼Œè¿›ä¸€æ­¥é€ æˆäº†è¯·æ±‚çš„æ— è°“ç­‰å¾…ï¼Œæµªè´¹äº†GPUè®¡ç®—èµ„æºï¼Œä¹Ÿé™ä½äº†ååï¼›äºæ˜¯<strong>iter-level scheduleåœ¨æ¯ä¸ªiteréƒ½æ£€æŸ¥æ˜¯å¦æœ‰å¥å­ç”Ÿæˆå®Œæ¯•ï¼Œå¦‚æœæœ‰ï¼Œå°±åŠæ—¶é‡Šæ”¾è¯¥å¥å­çš„å ç”¨èµ„æº(æ¯”å¦‚kv cache)ï¼Œå¹¶ä¸”æŠŠrequesté˜Ÿåˆ—ä¸­çš„å¾…æ¨ç†requestç»™åŠ å…¥è¿›æ¥æ‰§è¡Œæ¨ç†</strong>ã€‚ï¼ˆå¦‚69é¢˜å›¾ï¼‰</p><h3 id="_71-è¯´å‡ºå¤§æ¨¡å‹æ¨ç†ä¼˜åŒ–ä¸­ä½ çŸ¥é“çš„ç®—å­èåˆä¾‹å­" tabindex="-1"><a class="header-anchor" href="#_71-è¯´å‡ºå¤§æ¨¡å‹æ¨ç†ä¼˜åŒ–ä¸­ä½ çŸ¥é“çš„ç®—å­èåˆä¾‹å­"><span>71. è¯´å‡ºå¤§æ¨¡å‹æ¨ç†ä¼˜åŒ–ä¸­ä½ çŸ¥é“çš„ç®—å­èåˆä¾‹å­ï¼Ÿ</span></a></h3><p>Flash decodingï¼Œpaged attnï¼Œaddresidual+layernormï¼ŒMaskScaledSoftmaxï¼ŒFlashMLA, fusedMoE</p><p>åŒ…æ‹¬62é¢˜ä¸­çš„ group gemm + Swigluï¼Œ ä»¥åŠ unpermuted + reduce_outputã€‚</p><h3 id="_72-ç®—å­èåˆä¸ºä»€ä¹ˆå¯ä»¥å¸¦æ¥æ€§èƒ½æå‡" tabindex="-1"><a class="header-anchor" href="#_72-ç®—å­èåˆä¸ºä»€ä¹ˆå¯ä»¥å¸¦æ¥æ€§èƒ½æå‡"><span>72. ç®—å­èåˆä¸ºä»€ä¹ˆå¯ä»¥å¸¦æ¥æ€§èƒ½æå‡ï¼Ÿ</span></a></h3><ol><li><strong>å‡å°‘kernel launchå¼€é”€</strong>ï¼ˆ48é¢˜ï¼‰</li><li><strong>å‡å°‘ç®—å­ä¹‹é—´ä¸­é—´tensorå¯¹å…¨å±€å†…å­˜çš„è¯»å–å’Œå†™å…¥</strong>, ä¾‹å¦‚ï¼šconv+bias</li></ol><h3 id="_73-æ—¢ç„¶ç®—å­èåˆè¿™ä¹ˆç‰›é€¼-ä¸ºä»€ä¹ˆä¸èƒ½èå°½èæŠŠæ•´ä¸ªæ¨¡å‹çš„ç®—å­éƒ½èåˆèµ·æ¥" tabindex="-1"><a class="header-anchor" href="#_73-æ—¢ç„¶ç®—å­èåˆè¿™ä¹ˆç‰›é€¼-ä¸ºä»€ä¹ˆä¸èƒ½èå°½èæŠŠæ•´ä¸ªæ¨¡å‹çš„ç®—å­éƒ½èåˆèµ·æ¥"><span>73. æ—¢ç„¶ç®—å­èåˆè¿™ä¹ˆç‰›é€¼ï¼Œä¸ºä»€ä¹ˆä¸èƒ½èå°½èæŠŠæ•´ä¸ªæ¨¡å‹çš„ç®—å­éƒ½èåˆèµ·æ¥ï¼Ÿ</span></a></h3><ol><li><strong>ç®—å­èåˆè¦æ±‚èåˆå‰åæ•°å­¦ç­‰ä»·</strong>ï¼Œå¹¶ä¸æ˜¯ä»»ä½•å‡ ä¸ªç®—å­éƒ½èƒ½åšåˆ°èåˆåå¯ä»¥ç­‰ä»·ï¼Œè¿™é‡Œæ˜¯å·¥ç¨‹å®ç°éš¾åº¦</li><li><strong>ç¡¬ä»¶SRAMï¼ˆå…±äº«å†…å­˜ï¼‰ã€regæœ‰é™</strong> å› ä¸ºèåˆæ˜¯éœ€è¦æŠŠkernelçš„ä¸­é—´bufferå†™åˆ°å…±äº«å†…å­˜å’Œå¯„å­˜å™¨ä¸­çš„ã€‚</li><li>æ•´ä¸ªèåˆçš„å¤§ç®—å­ä¸å…·å¤‡æ™®é€‚æ€§ï¼Œæ”¶ç›Šä¸æ­£æ¯”äºæŠ•å…¥ã€‚å› ä¸ºå„ä¸ªæ¨¡å‹çš„æ¶æ„éƒ½æ˜¯ä¸åŒçš„ã€‚</li></ol><h3 id="_74-éšä¾¿ä¸¤ä¸ªç®—å­åšèåˆå°±èƒ½å¸¦æ¥æ€§èƒ½æå‡å—-ä¸ºä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#_74-éšä¾¿ä¸¤ä¸ªç®—å­åšèåˆå°±èƒ½å¸¦æ¥æ€§èƒ½æå‡å—-ä¸ºä»€ä¹ˆ"><span>74. éšä¾¿ä¸¤ä¸ªç®—å­åšèåˆå°±èƒ½å¸¦æ¥æ€§èƒ½æå‡å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</span></a></h3><p>ä¸ä¼šä¸€å®šèƒ½å¸¦æ¥æ€§èƒ½æå‡ã€‚</p><p>å› ä¸º<strong>ç®—å­èåˆçš„å¤§éƒ¨åˆ†æ”¶ç›Šçš„å‰æ</strong>æ˜¯ä¸‹ä¸€ä¸ª<strong>ç®—å­æ˜¯è®¿å­˜å¯†é›†å‹</strong>ï¼ˆconv2d+bias+reluï¼‰ï¼Œé‚£ä¹ˆèåˆåè¯¥ç®—å­å¯ä»¥çœå»ç®—å­ä¸ç®—å­ä¹‹é—´çš„memory trafficï¼Œå³è®¿å­˜é‡å‡å°‘å¸¦æ¥çš„æ”¶ç›Šï¼Œå¦åˆ™ï¼Œå¦‚æœä¸‹ä¸€ä¸ªç®—å­æ˜¯è®¡ç®—å¯†é›†å‹ï¼Œç“¶é¢ˆéƒ½ä¸åœ¨äºè®¿å­˜ï¼Œé‚£ä¹ˆæ”¶ç›Šå‡ ä¹ä¸º0ï¼Œæ¯”å¦‚<strong>ä¸¤ä¸ªç“¶é¢ˆä¸ºè®¡ç®—çš„è®¡ç®—å¯†é›†å‹matmulèåˆï¼Œæ”¶ç›Šå‡ ä¹ä¸º0</strong>ï¼Œä½†æ˜¯matmulå’Œbiasaddåšèåˆï¼Œé‚£ä¹ˆæ”¶ç›Šä¼šå¾ˆå¤§: Time(matmul) + Time(biasadd) &gt; Time(matmul+biasadd)</p><h3 id="_75-å¤§æ¨¡å‹é‡åŒ–å’Œä¹‹å‰çš„å°æ¨¡å‹é‡åŒ–åŒºåˆ«åœ¨äºå“ª" tabindex="-1"><a class="header-anchor" href="#_75-å¤§æ¨¡å‹é‡åŒ–å’Œä¹‹å‰çš„å°æ¨¡å‹é‡åŒ–åŒºåˆ«åœ¨äºå“ª"><span>75. å¤§æ¨¡å‹é‡åŒ–å’Œä¹‹å‰çš„å°æ¨¡å‹é‡åŒ–åŒºåˆ«åœ¨äºå“ªï¼Ÿ</span></a></h3><ol><li><p><strong>å¤§æ¨¡å‹çš„activationæœ‰å¾ˆå¤šå¼‚å¸¸å€¼outlier</strong>ï¼Œå¹¶ä¸”è¿™äº›outlieråˆ†å¸ƒåœ¨æŸå‡ åˆ—ï¼Œå¦‚æœæŒ‰ç…§å°æ¨¡å‹per tensor/perchannelé‡åŒ–çš„å¥—è·¯ï¼Œé‚£ä¹ˆè¿™äº›outlierå°†ä¼šç¼©å°é‡åŒ–çš„æœ‰æ•ˆèŒƒå›´ï¼Œå¢å¤§é‡åŒ–è¯¯å·®ï¼Œæ‰€ä»¥å¤§æ¨¡å‹é‡åŒ–æå‡ºäº†å¾ˆå¤šé’ˆå¯¹outlierçš„é‡åŒ–ideaï¼Œæ¯”å¦‚<strong>æŠŠè¿™éƒ¨åˆ†outlieræŠ½å–å‡ºæ¥ï¼Œä¿æŒä¸ºé«˜ç²¾åº¦(fp16)ï¼Œå‰©ä¸‹çš„ä¸ºä½ç²¾åº¦(int8/int4)</strong>ï¼Œå‚è€ƒ<a href="https://arxiv.org/pdf/2208.07339" target="_blank" rel="noopener noreferrer">llm.int8</a>è¿™ç¯‡paper(æ–‡ç« ä¸­æŒ‡å‡ºä¸€èˆ¬å¤§äº7Bçš„æ¨¡å‹å°±ä¼šå‡ºç°è¿™ä¸­å¼‚å¸¸å€¼çš„æƒ…å†µ)</p></li><li><p>å¤§æ¨¡å‹çš„weightå¹¶ä¸æ˜¯æ¯ä¸€è¡Œæ¯ä¸€åˆ—é‡è¦æ€§éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéœ€è¦<strong>ç”„é€‰å‡ºé‡è¦çš„weight</strong>ï¼Œå…¶å®ƒä¸é‡è¦çš„ï¼Œå¯ä»¥é‡åŒ–ä¸ºæ›´ä½çš„ç²¾åº¦(int3/int4)ï¼Œå‚è€ƒ<a href="https://summer536.github.io/Notes/zh/posts/AWQ.html" target="_blank" rel="noopener noreferrer">AWQ</a></p></li></ol><h3 id="_76-å¤§æ¨¡å‹é‡åŒ–ä¸»è¦é‡åŒ–å“ªäº›ç®—å­-ä¸ºä»€ä¹ˆä¸é‡åŒ–å…¶ä»–ç®—å­" tabindex="-1"><a class="header-anchor" href="#_76-å¤§æ¨¡å‹é‡åŒ–ä¸»è¦é‡åŒ–å“ªäº›ç®—å­-ä¸ºä»€ä¹ˆä¸é‡åŒ–å…¶ä»–ç®—å­"><span>76. å¤§æ¨¡å‹é‡åŒ–ä¸»è¦é‡åŒ–å“ªäº›ç®—å­ï¼Ÿä¸ºä»€ä¹ˆä¸é‡åŒ–å…¶ä»–ç®—å­ï¼Ÿ</span></a></h3><p>ä¸€èˆ¬é‡åŒ–Linearã€‚</p><ol><li>ä»æ˜¾å­˜å ç”¨ä¸Šè€ƒè™‘ï¼šlinearå ç”¨çš„æ˜¾å­˜æœ€å¤§ã€‚</li><li>ä»æ—¶é—´å æ¯”ä¸Šè€ƒè™‘ï¼šlinearå æ¯”æœ€å¤§ã€‚</li><li>ç²¾åº¦å½±å“ä¸Šè€ƒè™‘ï¼šlinearå¯¹ç²¾åº¦æ”¹å˜ä¸å¤ªæ•æ„Ÿï¼Œè€Œsoftmaxã€layernormå¯¹ç²¾åº¦æ”¹å˜æ¯”è¾ƒæ•æ„Ÿï¼ˆç”šè‡³ä»–ä»¬è¿˜éœ€è¦FP32å»åšï¼‰ã€‚</li><li>weigthä¸Šè€ƒè™‘ï¼šlinearçš„weightæœ€å¤šï¼Œsoftmaxå’Œlayernormè¿™ç§éƒ½æ²¡å•¥weightå‘€ã€‚</li></ol><h3 id="_77-å¤§æ¨¡å‹é‡åŒ–ä¸ºä»€ä¹ˆä¸€èˆ¬ä¸é‡åŒ–æ¿€æ´»activation" tabindex="-1"><a class="header-anchor" href="#_77-å¤§æ¨¡å‹é‡åŒ–ä¸ºä»€ä¹ˆä¸€èˆ¬ä¸é‡åŒ–æ¿€æ´»activation"><span>77. å¤§æ¨¡å‹é‡åŒ–ä¸ºä»€ä¹ˆä¸€èˆ¬ä¸é‡åŒ–æ¿€æ´»activationï¼Ÿ</span></a></h3><p>å‚è€ƒä¸Šé¢˜çš„ä¸‰æ–¹é¢ï¼Œæ¿€æ´»åœ¨æ¨ç†è¿‡ç¨‹ä¸­çš„æ˜¾å­˜å æ¯”ä½ï¼ˆç”¨å®Œå³åˆ ï¼‰ï¼Œä¸èˆ¬ä¸åˆ°3%ï¼ŒåŠ ä¸Šæ¿€æ´»çš„æ•°æ®åˆ†å¸ƒä¸å‡åŒ€ï¼Œé‡åŒ–éš¾åº¦å¾ˆå¤§ã€‚</p><h3 id="_78-kv-cacheæœ‰å“ªäº›ä¼˜åŒ–æ‰‹æ®µ" tabindex="-1"><a class="header-anchor" href="#_78-kv-cacheæœ‰å“ªäº›ä¼˜åŒ–æ‰‹æ®µ"><span>78. kv cacheæœ‰å“ªäº›ä¼˜åŒ–æ‰‹æ®µï¼Ÿ</span></a></h3><ol><li>GQAï¼ŒMQAï¼ŒMLA</li><li>é‡åŒ–ï¼Œ int8/fp8/int4</li><li>Blockçº§å†…å­˜ä¼˜åŒ–ï¼Œä¾‹å¦‚ï¼špaged attention</li><li>æ»‘åŠ¨çª—å£KVï¼Œä¾‹å¦‚ï¼šLongformer</li><li>H2Oï¼Œé‡è¦æ€§æ’åºï¼ŒTOPKçš„tokençš„kvä¿ç•™</li><li>NSA/MOBAï¼Œç¨€ç–åŒ–kv cache</li></ol><p><strong>ä¸Šé¢è¿™äº›ä¼˜åŒ–çš„æ–¹æ³•æœ‰å“ªäº›éœ€è¦æ”¹å˜æ¨¡å‹è®­ç»ƒçš„æ–¹æ³•ï¼Œæœ‰å“ªäº›åªæ˜¯å·¥ç¨‹ä¸Šçš„ä¼˜åŒ–æ‰‹æ®µï¼Ÿ</strong></p><p>ç­”ï¼š1ã€6éœ€è¦åœ¨æ¨¡å‹è®­ç»ƒæ—¶å°±æŒ‰è¯¥ç­–ç•¥è®­ç»ƒå¥½ï¼›</p><p>2ã€3ã€4ã€5éƒ½æ˜¯å·¥ç¨‹ä¸Šçš„ä¼˜åŒ–ï¼Œä¸æ¨¡å‹è®­ç»ƒæ— å…³ã€‚</p><h3 id="_79-flash-attention-v2-ç›¸æ¯”-v1æœ‰å“ªäº›æ”¹è¿›" tabindex="-1"><a class="header-anchor" href="#_79-flash-attention-v2-ç›¸æ¯”-v1æœ‰å“ªäº›æ”¹è¿›"><span>79. Flash attention V2 ç›¸æ¯” V1æœ‰å“ªäº›æ”¹è¿›ï¼Ÿ</span></a></h3><p>è¯¦ç»†è§<a href="https://summer536.github.io/Notes/zh/posts/flashattention.html" target="_blank" rel="noopener noreferrer">Flashattention.md</a></p><p>V1: <strong>KVçš„åˆ—ä¸ºå¤–å¾ªç¯,Qçš„è¡Œä¸ºå†…å¾ªç¯</strong>,ä¸€æ¬¡å‡º<strong>å…¨éƒ¨çš„ç»“æœO(i)</strong>,ä½†æ˜¯éœ€è¦é€šè¿‡å¤–å¾ªç¯æ¥<strong>ä¸æ–­æ›´æ–°å®Œæ•´çš„O(i)</strong>, ç›´åˆ°å¤–å¾ªç¯ç»“æŸæ›´æ–°ä¸ºæ­£ç¡®çš„O(i)</p><p>V2: äº¤æ¢å¾ªç¯é¡ºåºï¼Œ<strong>Qçš„è¡Œä¸ºå¤–å¾ªç¯ï¼ŒKVçš„åˆ—ä¸ºå†…å¾ªç¯</strong>ï¼Œä¸€æ¬¡æ€§å‡º<strong>ä¸€ä¸ªç»“æœå—O(i)</strong>ï¼Œä½¿å¾—å†…å¾ªç¯ç»“æŸååª<strong>åšä¸€æ¬¡rescalingå°±å¯ä»¥å¾—åˆ°å®Œæ•´çš„O(i)</strong></p><ol><li><p><strong>éçŸ©é˜µä¹˜æ³•éƒ¨åˆ†çš„è®¡ç®—é‡å¾—åˆ°äº†å‡å°‘</strong>ï¼Œå…·ä½“åœ¨äºv1åœ¨æ¯æ¬¡kåˆ—å¾ªç¯åï¼Œå¾—åˆ°äº†æ–°çš„mï¼ˆx_max) å’Œl (sum(exp(x-m)), ç„¶åä¼šå»æ›´æ–°ä¸Šä¸€ä¸ªå¾ªç¯å¯¹åº”blockçš„åˆ†å­å¤„çš„mä»¥åŠåˆ†æ¯å¤„çš„lï¼Œv2å‘ç°æ²¡æœ‰å¿…è¦æ¯æ¬¡kåˆ—å¾ªç¯éƒ½å…ˆæ›´æ–°låå‚ä¸P * Vï¼Œåªéœ€åœ¨æœ€åä¸€æ¬¡å¾ªç¯å®Œæˆlçš„æ›´æ–°åå†å»ä½œä¸ºOçš„åˆ†æ¯å³å¯ã€‚ï¼ˆå³V2åªè€ƒè™‘ä¸€æ¬¡softmaxçš„åˆ†æ¯è®¡ç®—ï¼Œåœ¨æœ€åä¸€æ­¥ç®—ä¸€æ¬¡å³å¯ï¼‰</p></li><li><p><strong>ä¼˜åŒ–warpsåœ¨QKçŸ©é˜µä¸Šçš„è¯»å†™ï¼Œä»è€Œå‡å°‘äº†warpé—´çš„é¢å¤–é€šä¿¡</strong>ï¼Œå¦‚ä¸‹å›¾ï¼Œv2ä¸­ï¼Œwarp1-4å‡å¯ä»¥è®¿é—®ä¸€æ•´ä¸ªk_lenï¼Œé‚£ä¹ˆåœ¨QK * Vçš„è¿‡ç¨‹ä¸­ï¼Œæ— éœ€åšwarpä¹‹é—´çš„reduceï¼Œç„¶è€Œå¯¹äºv1ï¼Œåˆ™éœ€è¦warp1-4åšwarpé—´çš„reduceï¼Œæœ€ç»ˆæ‰èƒ½å¾—åˆ°Oç»“æœ<br><img src="/Notes/assets/img/79_3.42bbf74a.png" alt="" loading="lazy"></p></li><li><p><strong>å¯¹seqlenç»´åº¦å……åˆ†å¹¶è¡Œ</strong>ï¼Œä¸»è¦è€ƒè™‘åˆ°batchsize*numheadså°äºSMä¸ªæ•°çš„æƒ…å†µä¸‹ï¼Œæ— æ³•æ‰“æ»¡SMç®—åŠ›ï¼Œæ­¤æ—¶seqlenä¸€èˆ¬éƒ½å¾ˆå¤§ï¼Œéœ€è¦å¯¹seqlenç»´åº¦å……åˆ†å¹¶è¡Œã€‚ä¸»è¦çš„å®ç°å°±æ˜¯åœ¨äºFlashAttention-2å°†Qç§»åˆ°äº†å¤–å¾ªç¯ï¼ŒKVç§»åˆ°äº†å†…å¾ªç¯ï¼Œç”±äºæ”¹è¿›äº†ç®—æ³•ä½¿å¾—warpsä¹‹é—´ä¸å†éœ€è¦ç›¸äº’é€šä¿¡å»å¤„ç†Qï¼Œæ‰€ä»¥å¤–å¾ªç¯å¯ä»¥æ”¾åœ¨ä¸åŒçš„blockä¸Šã€‚</p></li></ol><h3 id="_80-flash-attention-v1-v2ç°æœ‰çš„å¤„ç†attention-maskä»£ç ä½ è®¤ä¸ºæ˜¯å¦æœ‰æ€§èƒ½ç¼ºé™·-å¦‚æœä¸æ˜¯-å¯ä»¥å¦‚ä½•ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_80-flash-attention-v1-v2ç°æœ‰çš„å¤„ç†attention-maskä»£ç ä½ è®¤ä¸ºæ˜¯å¦æœ‰æ€§èƒ½ç¼ºé™·-å¦‚æœä¸æ˜¯-å¯ä»¥å¦‚ä½•ä¼˜åŒ–"><span>80. Flash attention v1 v2ç°æœ‰çš„å¤„ç†attention maskä»£ç ä½ è®¤ä¸ºæ˜¯å¦æœ‰æ€§èƒ½ç¼ºé™·ï¼Ÿå¦‚æœä¸æ˜¯ï¼Œå¯ä»¥å¦‚ä½•ä¼˜åŒ–ï¼Ÿ</span></a></h3><p>æœ‰ï¼ŒFlash attention v1 v2å…¶å®å®ƒ<strong>å¯¹å¤šç§maskæ–¹æ³•çš„æ”¯æŒæ˜¯ä¸è¶³çš„ï¼Œå®ƒåªæ”¯æŒä¸€äº›å¸¸è§„çš„mask</strong>ã€‚ä½†æ˜¯æ¨¡å‹è®­ç»ƒå…¶å®æ˜¯éœ€è¦å¤šç§maskç­–ç•¥çš„ï¼Œå®ƒä»¬æƒ³å°†è¿™äº›maskåº”ç”¨äºflash attention ä½†åˆä¸æƒ³ç”±äºä¸é€‚é…å¯¼è‡´å…¶æ€§èƒ½çš„é™ä½ã€‚<strong>ç™¾åº¦çš„Paddleå›¢é˜Ÿè§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œè¯¦è§<a href="https://mp.weixin.qq.com/s/6ROApQR5Pf_sRHOaYjcIWA" target="_blank" rel="noopener noreferrer">FlashMask</a></strong></p><p>ç¼ºé™·åœ¨äºï¼šæ ‡å‡†çš„flash attention çš„ maskä¸ºä¸€ä¸ªshapeä¸º[batchsize, head num, q len, k len]çš„ç¨ å¯†çŸ©é˜µï¼Œè¿™ä¸ªç¨ å¯†çŸ©é˜µä¼šå’Œattention score Sç›¸åŠ ï¼Œç„¶ååšsoftmaxï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹å¯¹åº”çš„å…¬å¼æ˜¯softmax(S+Mask), flashattentionçš„åšæ³•æ˜¯ç›´æ¥Så’ŒMaskç›¸åŠ ï¼Œè¿™é‡Œçš„æ€§èƒ½ç¼ºé™·åœ¨äºéœ€è¦ä»HBMè¯»shapeä¸º[batchsize, head num, q len, k len]çš„maskç¨ å¯†çŸ©é˜µï¼Œè¿™ä¸ªçŸ©é˜µæ˜¯O(N^2)çš„ï¼Œä¸å¥å­é•¿åº¦å‘ˆå¹³æ–¹é˜¶ã€‚</p><h3 id="_81-flash-decodingä¸»è¦åšäº†ä»€ä¹ˆä¼˜åŒ–æ¥è§£å†³ä»€ä¹ˆé—®é¢˜-è¿™ç§ideaåœ¨ä½•ç§åœºæ™¯ä¸‹æå‡æœ€å¤§" tabindex="-1"><a class="header-anchor" href="#_81-flash-decodingä¸»è¦åšäº†ä»€ä¹ˆä¼˜åŒ–æ¥è§£å†³ä»€ä¹ˆé—®é¢˜-è¿™ç§ideaåœ¨ä½•ç§åœºæ™¯ä¸‹æå‡æœ€å¤§"><span>81.flash decodingä¸»è¦åšäº†ä»€ä¹ˆä¼˜åŒ–æ¥è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿè¿™ç§ideaåœ¨ä½•ç§åœºæ™¯ä¸‹æå‡æœ€å¤§</span></a></h3><ol><li><p><strong>K lenç»´åº¦çš„å……åˆ†å¹¶è¡Œ</strong>ã€‚æ¨ç†é˜¶æ®µï¼Œattentionä¸­<strong>q*k^T</strong>éƒ¨åˆ†çš„shapeå˜æ¢ä¸º[batch size, num heads, <strong>q_len, head dim</strong>]x[batch size, num heads, <strong>head dim, k_len</strong>], å…¶ä¸­<strong>k_lenè¡¨ç¤ºä¸Šä¸‹æ–‡é•¿åº¦</strong>ï¼Œæ¯”å¦‚å¤šè½®å¯¹è¯çš„æ—¶å€™ï¼Œä½ ä¸gptçš„ç¬¬äº”è½®å¯¹è¯ï¼Œæ­¤æ—¶k_lenç­‰äºä¹‹å‰æ‰€æœ‰è½®æ¬¡ä½ æ–¹çš„å¥å­é•¿åº¦+gptæ–¹åå‡ºçš„å¥å­é•¿åº¦ï¼Œè€Œ<strong>q_lenä»…ä»…ä¸ºå½“å‰ç¬¬äº”è½®ä½ æ–¹çš„å¥å­é•¿åº¦</strong>ï¼Œå› æ­¤k_lenæ­¤åˆ»ä¸€èˆ¬è¿œå¤§äºq_lenï¼Œè€Œv1æ²¡æœ‰åœ¨k_lenç»´åº¦åˆ†é…å¤šä¸ªblockå¹¶è¡Œå¤„ç†ï¼Œåªåœ¨q_lenç»´åº¦åˆ†é…äº†q_lenä¸ªblockï¼Œä»¥åŠbatch sizeç»´åº¦åˆ†é…batch sizeä¸ªblockï¼Œä»¥åŠnum headsç»´åº¦åˆ†é…num headsä¸ªblock,<strong>å¦‚æœæ­¤æ—¶åˆšå¥½ä½äºå¤§æ¨¡å‹æ¨ç†çš„decodeé˜¶æ®µï¼Œé‚£ä¹ˆq_lenä¸º1</strong>ï¼Œå†åŠ ä¸Šbatch sizeæ¯”è¾ƒå°ï¼Œé‚£ä¹ˆè¿™æ˜¾ç„¶ä¸èƒ½å……åˆ†åˆ©ç”¨SMèµ„æºï¼Œæ‰€ä»¥flash decodingåœ¨k_lenç»´åº¦åˆ†é…å¤šä¸ªblockæ¥å¹¶è¡Œå¤„ç†ä¸€éƒ¨åˆ†seqï¼Œæœ€ç»ˆæ¯ä¸ªblockåšä¸€ä¸ªé¢å¤–çš„reduceï¼ŒæŠŠç»“æœèšåˆèµ·æ¥ï¼Œæ‰æ˜¯æœ€ç»ˆçš„Oç»“æœï¼Œè¿™ä¸ªä¹Ÿå«åšsplitKã€‚</p></li><li><p>åœ¨batch sizeè¶Šå°ï¼Œq lenè¶Šå°ï¼Œk lenè¶Šå¤§çš„åœºæ™¯ï¼Œæå‡æœ€å¤§ã€‚<br><img src="/Notes/assets/img/81.febf497a.png" alt="" loading="lazy"></p></li></ol><h3 id="_82-flash-attention-v3ä¼˜åŒ–äº†å•¥" tabindex="-1"><a class="header-anchor" href="#_82-flash-attention-v3ä¼˜åŒ–äº†å•¥"><span>82. flash attention v3ä¼˜åŒ–äº†å•¥ï¼Ÿ</span></a></h3><p><a href="https://mp.weixin.qq.com/s/cclvT7PxQzdkm9nYfWbhmQ" target="_blank" rel="noopener noreferrer">FlashAttention-V3è§£è¯»ä¹‹Hopper GPUç‰ˆFlashAttention (ä¸Šç¯‡)</a></p><p><a href="https://mp.weixin.qq.com/s/9sDJlHQRzSiuTc_EmwjxzA" target="_blank" rel="noopener noreferrer">FlashAttention-V3è§£è¯»ä¹‹FP8/FP16/BF16å…³é”®ç»†èŠ‚å®ç° (ä¸‹ç¯‡)</a></p><p>Flash attention V3ä¸»è¦æ˜¯å¯¹Hopperæ¶æ„çš„ä¼˜åŒ–ï¼Œå…¶ä»–ä¸V2ä¸€æ ·ã€‚</p><p>è¿™ä¸ªç®€å•äº†è§£ä¸€ä¸‹å³å¯ï¼Œå› ä¸ºç°åœ¨Hopperæ¶æ„ç”¨çš„å…¬å¸è¿˜ä¸å¤šã€‚</p><ol><li><p>ç”Ÿäº§è€…producerå’Œæ¶ˆè´¹è€…çš„å¼‚æ­¥åŒ–ï¼šåˆ©ç”¨TMAåšæ•°æ®æ¬è¿è®©tensor coreæ©ç›–æ•°æ®æ¬è¿å»¶è¿Ÿï¼›éœ€è¦ä¾é Hopperæ¶æ„çš„&quot;TMA&quot;å’Œ&quot;barrier&quot;ï¼Œå› æ­¤æ— æ³•é€‚ç”¨å…¶ä»–çš„æ¶æ„ã€‚</p></li><li><p>GEMM å’Œ softmaxçš„overlapï¼š Hopperä¸­å°†ä¹‹å‰çš„MMAæ›¿æ¢ä¸ºWGMMAï¼ˆtensor coreï¼‰ï¼Œä»¥å®ç°å¤©ç„¶ä¸softmaxçš„cuda coreçš„å¼‚æ­¥ã€‚åˆ©ç”¨ç®—åŠ›é«˜çš„çš„tensor core busyæ©ç›–ç®—åŠ›ä½çš„cuda coreè®¡ç®—expã€‚éœ€è¦ä¾èµ–Hopperæ¶æ„çš„WGMMAæŠ€æœ¯ã€‚</p></li><li><p>é¦–æ¬¡æ”¯æŒFP8 FlashAttentionã€‚</p></li></ol><h3 id="_83-ä¸¾å‡ºå¤§æ¨¡å‹åº”ç”¨é¢†åŸŸshared-prefixçš„å‡ºç°åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#_83-ä¸¾å‡ºå¤§æ¨¡å‹åº”ç”¨é¢†åŸŸshared-prefixçš„å‡ºç°åœºæ™¯"><span>83. ä¸¾å‡ºå¤§æ¨¡å‹åº”ç”¨é¢†åŸŸshared prefixçš„å‡ºç°åœºæ™¯</span></a></h3><p><strong>System prompt</strong>ï¼š<br><img src="/Notes/assets/img/82_1.f9e56ab0.png" alt="" loading="lazy"><br><strong>å¤šè½®å¯¹è¯</strong><br><img src="/Notes/assets/img/82_2.1e3f4233.png" alt="" loading="lazy"></p><h3 id="_83-1-ä¸ºä»€ä¹ˆè¦è¿›è¡Œprefix-cacheä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_83-1-ä¸ºä»€ä¹ˆè¦è¿›è¡Œprefix-cacheä¼˜åŒ–"><span>83.1 ä¸ºä»€ä¹ˆè¦è¿›è¡Œprefix cacheä¼˜åŒ–ï¼Ÿ</span></a></h3><p><a href="https://zhuanlan.zhihu.com/p/693556044" target="_blank" rel="noopener noreferrer">[Prefillä¼˜åŒ–][ä¸‡å­—]ğŸ”¥åŸç†&amp;å›¾è§£vLLM Automatic Prefix Cache(RadixAttention): é¦–Tokenæ—¶å»¶ä¼˜åŒ–</a></p><p><a href="https://zhuanlan.zhihu.com/p/695799736" target="_blank" rel="noopener noreferrer">[Tritonç¼–ç¨‹][è¿›é˜¶]ğŸ“švLLM Triton Prefix Prefill Kernelå›¾è§£</a></p><p><strong>é¿å…æ¯è½®å¯¹è¯éƒ½å»recompute prefix/generated kv, å› ä¸ºprefillé˜¶æ®µæœ¬èº«å°±æ˜¯compute boundï¼Œç®—åŠ›æœ‰é™ï¼Œæ‰€ä»¥åº”è¯¥é¿å…recomputeï¼Œä»è€Œé™ä½TTFT</strong></p><p><strong>SGlang åŸºæ•°æ ‘æ˜¯å¦‚ä½•æ§åˆ¶è¦ä¸è¦åˆ†ç¦»ç»“ç‚¹çš„ï¼Ÿ</strong></p><p>SGLang çš„åŸºæ•°æ ‘å¹¶ä¸æ˜¯ä¸€å¼€å§‹å°±æŠŠæ¯ä¸ª token å•ç‹¬å­˜å‚¨ï¼Œè€Œæ˜¯æŠŠè¿ç»­çš„å…¬å…± token å‹ç¼©æˆä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><p>å½“æ–°çš„è¯·æ±‚åˆ°æ¥ï¼Œå¦‚æœå®ƒçš„å‰ç¼€å’Œå·²æœ‰è¯·æ±‚å®Œå…¨ä¸€è‡´ï¼Œå°±ç›´æ¥å…±äº«è¿™ä¸€æ®µ KV Cacheï¼›<br> å¦‚æœåœ¨æŸä¸ª token å¤„å‡ºç°åˆ†æ­§ï¼ŒåŸºæ•°æ ‘å°±ä¼š<strong>åŠ¨æ€æ‹†åˆ†èŠ‚ç‚¹</strong>ï¼Œè®©å…¬å…±éƒ¨åˆ†ç»§ç»­å…±äº«ï¼Œè€Œä¸åŒéƒ¨åˆ†å„è‡ªåˆ†æ”¯ã€‚</p><p>è¿™ç§æœºåˆ¶èƒ½æœ€å¤§åŒ– Prefix + Generate é˜¶æ®µ KV Cache çš„é‡ç”¨ï¼Œæå‡ååå’Œæ˜¾å­˜æ•ˆç‡ã€‚</p><h3 id="_83-2-vllmçš„hash-radixattention-è‡ªåŠ¨å‰ç¼€ç¼“å­˜-ä¸sglangçš„radixattentionåœ¨å®ç°åŸç†ã€å·¥ç¨‹è®¾è®¡å’Œæ€§èƒ½è¡¨ç°ä¸Šçš„æ ¸å¿ƒåŒºåˆ«æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#_83-2-vllmçš„hash-radixattention-è‡ªåŠ¨å‰ç¼€ç¼“å­˜-ä¸sglangçš„radixattentionåœ¨å®ç°åŸç†ã€å·¥ç¨‹è®¾è®¡å’Œæ€§èƒ½è¡¨ç°ä¸Šçš„æ ¸å¿ƒåŒºåˆ«æ€»ç»“"><span>83.2 vLLMçš„Hash RadixAttentionï¼ˆè‡ªåŠ¨å‰ç¼€ç¼“å­˜ï¼‰ä¸SGLangçš„RadixAttentionåœ¨å®ç°åŸç†ã€å·¥ç¨‹è®¾è®¡å’Œæ€§èƒ½è¡¨ç°ä¸Šçš„æ ¸å¿ƒåŒºåˆ«æ€»ç»“ï¼Ÿ</span></a></h3><figure><img src="/Notes/assets/img/83_2.c37a675b.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="_84-å¦‚ä½•æ¨å¯¼radix-attention-æˆ–è€…shared-prefix-decomposing-attentionçš„æ­£ç¡®æ€§" tabindex="-1"><a class="header-anchor" href="#_84-å¦‚ä½•æ¨å¯¼radix-attention-æˆ–è€…shared-prefix-decomposing-attentionçš„æ­£ç¡®æ€§"><span>84. å¦‚ä½•æ¨å¯¼Radix attention æˆ–è€…shared prefix decomposing attentionçš„æ­£ç¡®æ€§ï¼Ÿ</span></a></h3><p>æ­¥éª¤ï¼š</p><ol><li>new_q_len * cached_kv; apply Flash attention</li><li>new_q_len * new_kv; apply Flash attention</li><li>reduce or merge states(æŠŠ1å’Œ2ç®—å‡ºæ¥çš„hidden state reduceä¸€ä¸‹)</li></ol><figure><img src="/Notes/assets/img/84.abc626d4.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å¯ä»¥çœ‹åˆ°æ–¹ç¨‹8å°±æ˜¯å¯¹åº”çš„reduceæ“ä½œï¼Œè®°ä½å°±å¥½ã€‚<br> Chunk attention:</p><p><a href="https://arxiv.org/pdf/2402.05099" target="_blank" rel="noopener noreferrer">Hydragen: High-Throughput LLM Inference with Shared Prefixes</a></p><p><a href="https://docs.flashinfer.ai/tutorials/recursive_attention.html" target="_blank" rel="noopener noreferrer">Attention States and Recursive Attention</a></p><h3 id="_85-ä¼ä¸šå†…éƒ¨çŸ¥è¯†æŸ¥è¯¢æ˜¯ä¸€ä¸ªå…¸å‹çš„document-qaä»»åŠ¡-åœ¨è¿™ç§åœºæ™¯ä¸‹-å½“ä¸¤ä¸ªè¯·æ±‚-query-åŒæ—¶å‘èµ·æŸ¥è¯¢-ä½ è®¤ä¸ºå“ªç§attention-è®¡ç®—æ–¹æ³•æ€§èƒ½æœ€é«˜" tabindex="-1"><a class="header-anchor" href="#_85-ä¼ä¸šå†…éƒ¨çŸ¥è¯†æŸ¥è¯¢æ˜¯ä¸€ä¸ªå…¸å‹çš„document-qaä»»åŠ¡-åœ¨è¿™ç§åœºæ™¯ä¸‹-å½“ä¸¤ä¸ªè¯·æ±‚-query-åŒæ—¶å‘èµ·æŸ¥è¯¢-ä½ è®¤ä¸ºå“ªç§attention-è®¡ç®—æ–¹æ³•æ€§èƒ½æœ€é«˜"><span>85. ä¼ä¸šå†…éƒ¨çŸ¥è¯†æŸ¥è¯¢æ˜¯ä¸€ä¸ªå…¸å‹çš„document QAä»»åŠ¡ï¼Œåœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œå½“ä¸¤ä¸ªè¯·æ±‚ï¼ˆqueryï¼‰åŒæ—¶å‘èµ·æŸ¥è¯¢ï¼Œä½ è®¤ä¸ºå“ªç§attention è®¡ç®—æ–¹æ³•æ€§èƒ½æœ€é«˜ï¼Ÿ</span></a></h3><p>vLLM/SGlangé’ˆå¯¹ä¸åŒçš„ä»»åŠ¡æœ‰å¾ˆå¤šçš„back endï¼Œéœ€è¦é€‰æ‹©ä¸€ä¸ªï¼š</p><p>A.ä¸€æ¬¡multi query attention ï¼ˆå³ä¸‹å›¾ï¼‰</p><p>B.ä¸¤æ¬¡single query attention ï¼ˆå³ä¸‹å›¾ç¬¬ä¸‰è¡Œåªæœ‰ä¸€ä¸ªè“è‰²æ–¹å—çš„æƒ…å†µï¼‰</p><p><strong>C.ä¸€æ¬¡multi query attention+ä¸¤æ¬¡single query attentionï¼Œè€ŒåæŠŠç»“æœreduce or merge</strong><br><img src="/Notes/assets/img/85.1edabc18.png" alt="" loading="lazy"></p><p>ç­”æ¡ˆï¼šCï¼ŒdocumentQAæœ¬èº«å°±æœ‰ä¸€ä¸ªå†…ç½®çš„promptï¼Œè€Œä¸¤ä¸ªè¯·æ±‚åˆæœ‰å„è‡ªè‡ªå·±çš„promptï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å…ˆç”¨ä¸€æ¬¡MQAå°†å…¬æœ‰çš„ç¬¬ä¸€ä¸ªpromptè®¡ç®—å‡ºæ¥ï¼Œç„¶ååœ¨ä½¿ç”¨ä¸¤æ¬¡SQAåˆ†åˆ«è®¡ç®—å„è‡ªç‹¬æœ‰çš„promptï¼Œæœ€åæŠŠç»“æœreduce or mergeã€‚</p><p>æç¤ºï¼šæ­¤ç§åœºæ™¯åˆç§°batch shared prefix kv cacheï¼Œæ­¤å¤„<strong>attention kernelåˆå«cascade inference kernel(flashinfer) or æ·±åº¦ä¸º2çš„radix attention(sglang)</strong></p><h3 id="_86-vllmæœ‰ä»€ä¹ˆä¸è¶³" tabindex="-1"><a class="header-anchor" href="#_86-vllmæœ‰ä»€ä¹ˆä¸è¶³"><span>86. vLLMæœ‰ä»€ä¹ˆä¸è¶³ï¼Ÿ</span></a></h3><p><strong>æ›¾ç»å­˜åœ¨å¾ˆä¸¥é‡çš„cpuå¼€é”€é—®é¢˜</strong> ç°åœ¨è§£å†³ä¸€äº›äº†ã€‚</p><p><a href="https://mp.weixin.qq.com/s/ZH6vzQFg9NNoPRyTgtdY4Q?token=474473637&amp;lang=zh_CN" target="_blank" rel="noopener noreferrer">Deep dive vLLMå’ŒSGLangæ¨ç†æ¡†æ¶çš„CPUå¼€é”€</a></p><p>nsight-system/torchprofæŸ¥çœ‹:<br><img src="/Notes/assets/img/86.fc8667e1.png" alt="" loading="lazy"></p><p>çº¢æ¡†å†…æ˜¯GPUæ²¡æœ‰è¿è¡Œçš„æ—¶é—´ã€‚</p><p>é‚£ä¹ˆvLLMçš„cpuå¼€é”€ä½“ç°åœ¨å“ªé‡Œå‘¢ï¼Ÿä¸»è¦æ˜¯å‡†å¤‡æ•°æ®ï¼ˆçº¢è‰²å’Œç»¿è‰²ï¼‰ä»¥åŠdetokenizeï¼ˆç²‰è‰²ï¼‰ã€‚<br><img src="/Notes/assets/img/86_2.56c7cc08.png" alt="" loading="lazy"><br> çœ‹èµ·æ¥è¿™äº›æ“ä½œæ˜¯æ²¡æ³•çœçš„ï¼Œé‚£ä¹ˆå¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿä¸€ä¸ªç»å…¸çš„æ€è·¯å°±æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨GPUè¿è¡Œçš„æ—¶å€™å°±åšè¿™äº›æ“ä½œï¼Œä»¥æ©ç›–è¿™äº›cpuå¼€é”€ã€‚ï¼ˆä¸‹ä¸€é¢˜çš„SGlangå°±æ˜¯è¿™ä¹ˆåšçš„ï¼‰</p><h3 id="_87-sglangæ˜¯å¦‚ä½•è§£å†³vllmçš„cpuå¼€é”€é—®é¢˜çš„" tabindex="-1"><a class="header-anchor" href="#_87-sglangæ˜¯å¦‚ä½•è§£å†³vllmçš„cpuå¼€é”€é—®é¢˜çš„"><span>87. SGlangæ˜¯å¦‚ä½•è§£å†³vLLMçš„cpuå¼€é”€é—®é¢˜çš„ï¼Ÿ</span></a></h3><figure><img src="/Notes/assets/img/87.37dedafd.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>1.æ€»ä½“æ¥çœ‹ï¼Œå¤§æ¨¡å‹æ¨ç†éƒ½å¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼ša.ä»tokenizerè¿›ç¨‹ï¼ˆtokenize manageré‡Œé¢ï¼‰æ¥å—è¿‡æ¥çš„è¯·æ±‚ã€b.step forwardã€c.push resultåˆ°detoken</p><p><strong>SGlangå°†è¿™ä¸‰æ­¥æ”¾åœ¨ä¸‰ä¸ªè¿›ç¨‹ä¸­ï¼Œä»¥å®ç°å¼‚æ­¥æ‰§è¡Œã€‚</strong>ï¼ˆä¾èµ–å…³ç³»æ€ä¹ˆåŠå‘¢ï¼Ÿä½¿ç”¨cpuçš„è¿›ç¨‹åŒæ­¥å°±å¥½ã€‚æ¯”å¦‚å½“æ‹¿åˆ°tokenizerçš„ç»“æœåï¼Œforwardçš„è¿›ç¨‹ç«‹åˆ»æ”¶åˆ°åŒæ­¥ç„¶åå¼€å§‹æ‰§è¡Œforwardã€‚ï¼‰</p><p>2.è¿›ä¸€æ­¥è®²step forwardå†…éƒ¨ï¼Œæ¯ä¸ªstepçš„forwardä¹‹é—´ä»ç„¶ä¼šè¿›è¡Œå¤æ‚çš„batch scheduleç­–ç•¥ï¼ˆä¸Šå›¾çš„ç»¿è‰²éƒ¨åˆ†ï¼‰ï¼ŒåŒ…æ‹¬è®¡ç®—æ­¤stepçš„batch sizeã€åˆ†é…kv cacheï¼Œè¿™éƒ¨åˆ†scheduleç­–ç•¥åœ¨å†…éƒ¨æ²¡æœ‰å’Œmodel forwardå¼‚æ­¥èµ·æ¥ï¼Œ<strong>ä¾èµ–åœ¨äºscheduleréœ€è¦token idï¼Œè¿™ä¾èµ–äºä¸Šä¸€ä¸ªstepçš„fwdç»“æœ</strong>ï¼Œä½†æ˜¯schedulerï¼ˆ<em>å®ƒä¸éœ€è¦ç¡®å®šçš„çŸ¥é“tokenidæ˜¯ä»€ä¹ˆï¼Œåªéœ€è¦çŸ¥é“tokenå¾—æ•°é‡å³å¯</em>ï¼‰çœŸæ­£éœ€è¦çš„tokenæ•°é‡ï¼Œè€Œæˆ‘ä»¬decoderé˜¶æ®µçš„tokenä¸º1ï¼Œè¿™å®Œå…¨å¯ä»¥æå‰å°±çŸ¥é“ï¼Œä¸éœ€è¦ç­‰å¾…ä¸Šä¸€ä¸ªstepå‡ºç°ç»“æœï¼Œé‚£ä¹ˆç”±æ­¤<strong>schedulerå’Œmodel forwardå°±å¯ä»¥å¹¶è¡Œ</strong>ï¼ˆä¸‹å›¾çš„Overlapped schedulerï¼‰<br><img src="/Notes/assets/img/87_1.71e3d41b.png" alt="" loading="lazy"><br><img src="/Notes/assets/img/87_2.4c5d51bf.png" alt="" loading="lazy"></p><!-- ![](Figure/Interview/87_3.png)
![](Figure/Interview/87_4.png) --><h3 id="_88-ä¸ºä»€ä¹ˆæ¨¡å‹ååéšbatchsizeçš„å¢å¤§è€Œå¢å¤§" tabindex="-1"><a class="header-anchor" href="#_88-ä¸ºä»€ä¹ˆæ¨¡å‹ååéšbatchsizeçš„å¢å¤§è€Œå¢å¤§"><span>88. ä¸ºä»€ä¹ˆæ¨¡å‹ååéšbatchsizeçš„å¢å¤§è€Œå¢å¤§ï¼Ÿ</span></a></h3><ol><li><strong>å¹¶è¡Œè®¡ç®—æ•ˆç‡æå‡</strong></li></ol><ul><li>å¢å¤§Batch Sizeä¼šè®©æ¯ä¸ªè®¡ç®—å•å…ƒï¼ˆCUDA Core/Tensor Coreï¼‰å¤„ç†æ›´å¤šæ•°æ®ï¼Œå‡å°‘ç©ºé—²å‘¨æœŸã€‚ <ul><li>ç¤ºä¾‹ï¼šè‹¥Batch Size=1ä¸”å¤„äºdecodeé˜¶æ®µï¼ŒGPUè®¡ç®—å•å…ƒå¯èƒ½åªæœ‰10%è¢«åˆ©ç”¨ï¼ˆè¿™é‡Œè®¡ç®—å¯èƒ½åªç”¨åˆ°CUDA coreï¼‰ï¼›Batch Size=32æ—¶ï¼Œåˆ©ç”¨ç‡å¯è¾¾80%+ï¼ˆè¿™é‡Œç”±äºsizeå˜å¤§ï¼Œè®¡ç®—ä¼šç”¨åˆ°tensor coreï¼Œå³°å€¼ç®—åŠ›æ›´å¤§ï¼‰ã€‚</li></ul></li><li>GEMMåœ¨è¾ƒå¤§å°ºå¯¸æ—¶èƒ½æ›´é«˜æ•ˆåˆ©ç”¨ç¡¬ä»¶ï¼š <ul><li>å°çŸ©é˜µï¼š <ul><li>è®¡ç®—/å†…å­˜è®¿é—®æ¯”ä½ï¼Œglobal memoryè®¿å­˜å»¶è¿Ÿ/æ˜¾å­˜å¸¦å®½æˆä¸ºç“¶é¢ˆ</li><li>ä¸æ˜“æ»¡è¶³mmaå°ºå¯¸è¦æ±‚ï¼Œep. M16n8k16ï¼ˆæœ€ä½çš„è¦æ±‚ï¼Œå¦‚æœè¾¾ä¸åˆ°åªèƒ½è€è€å®å®å»ç”¨FMAäº†ï¼‰</li></ul></li><li>å¤§çŸ©é˜µï¼šè®¡ç®—/å†…å­˜è®¿é—®æ¯”é«˜ï¼Œç®—åŠ›æˆä¸ºç“¶é¢ˆã€‚ <ul><li>è½»æ˜“æ»¡è¶³mmaå°ºå¯¸è¦æ±‚ï¼Œå……åˆ†åˆ©ç”¨tensorcoreç®—åŠ›</li></ul></li></ul></li></ul><ol start="2"><li><strong>kernel launchå¼€é”€åˆ†æ‘Š</strong></li></ol><ul><li>ç¤ºä¾‹ï¼šKernelå¯åŠ¨è€—æ—¶10Î¼sï¼ŒBatch=1æ—¶æ¯æ ·æœ¬10Î¼sï¼›Batch=128æ—¶æ¯æ ·æœ¬ä»…0.08Î¼sã€‚</li></ul><h3 id="_89-ä¸ºä»€ä¹ˆé™ä½kv-cacheè¿™ä¹ˆé‡è¦" tabindex="-1"><a class="header-anchor" href="#_89-ä¸ºä»€ä¹ˆé™ä½kv-cacheè¿™ä¹ˆé‡è¦"><span>89. ä¸ºä»€ä¹ˆé™ä½kv cacheè¿™ä¹ˆé‡è¦ï¼Ÿ</span></a></h3><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹LLMçš„æ¨ç†éƒ½æ˜¯åœ¨GPUä¸Šè¿›è¡Œï¼Œ<strong>å•å¼ GPUçš„æ˜¾å­˜æ˜¯æœ‰é™çš„</strong>ï¼Œä¸€éƒ¨åˆ†æˆ‘ä»¬è¦ç”¨æ¥å­˜æ”¾æ¨¡å‹çš„å‚æ•°å’Œå‰å‘è®¡ç®—çš„ä¸­é—´æ¿€æ´»å€¼ï¼Œï¼›å¦å¤–ä¸€éƒ¨åˆ†æˆ‘ä»¬è¦ç”¨æ¥å­˜æ”¾KV Cacheï¼Œè¿™éƒ¨åˆ†åœ¨æ¨ç†è¿‡ç¨‹ä¸­æ˜¯åŠ¨æ€å¢é•¿çš„ï¼Œå½“Contexté•¿åº¦è¶³å¤Ÿé•¿æ—¶ï¼Œå®ƒçš„å¤§å°å°±ä¼šå ä¸»å¯¼åœ°ä½ï¼Œå¯èƒ½è¶…å‡ºä¸€å¼ å¡ç”šè‡³ä¸€å°æœºï¼ˆ8å¼ å¡ï¼‰çš„æ€»æ˜¾å­˜é‡ã€‚</p><p>åœ¨GPUä¸Šéƒ¨ç½²æ¨¡å‹çš„åŸåˆ™æ˜¯ï¼š<strong>èƒ½ä¸€å¼ å¡éƒ¨ç½²çš„ï¼Œå°±ä¸è¦è·¨å¤šå¼ å¡ï¼›èƒ½ä¸€å°æœºéƒ¨ç½²çš„ï¼Œå°±ä¸è¦è·¨å¤šå°æœº</strong>ã€‚è¿™æ˜¯å› ä¸ºâ€œå¡å†…é€šä¿¡å¸¦å®½ &gt; å¡é—´é€šä¿¡å¸¦å®½ &gt; æœºé—´é€šä¿¡å¸¦å®½â€ï¼Œç”±äº**â€œæœ¨æ¡¶æ•ˆåº”â€**ï¼Œæ¨¡å‹éƒ¨ç½²æ—¶è·¨çš„è®¾å¤‡è¶Šå¤šï¼Œå—è®¾å¤‡é—´é€šä¿¡å¸¦å®½çš„â€œæ‹–ç´¯â€å°±è¶Šå¤§ï¼Œäº‹å®ä¸Šå³ä¾¿æ˜¯å•å¡H100å†…SRAMä¸HBMçš„å¸¦å®½å·²ç»è¾¾åˆ°äº†3TB/sï¼Œä½†å¯¹äºShort Contextæ¥è¯´è¿™ä¸ªé€Ÿåº¦ä¾ç„¶è¿˜æ˜¯æ¨ç†çš„ç“¶é¢ˆï¼Œæ›´ä¸ç”¨è¯´æ›´æ…¢çš„å¡é—´ã€æœºé—´é€šä¿¡äº†ã€‚</p><p>æ‰€ä»¥ï¼Œ<strong>å‡å°‘KV Cacheçš„ç›®çš„å°±æ˜¯è¦å®ç°åœ¨æ›´å°‘çš„è®¾å¤‡ä¸Šæ¨ç†æ›´é•¿çš„Context</strong>ï¼Œæˆ–è€…<strong>åœ¨ç›¸åŒçš„Contexté•¿åº¦ä¸‹è®©æ¨ç†çš„batch sizeæ›´å¤§</strong>ï¼Œä»è€Œå®ç°æ›´å¿«çš„æ¨ç†é€Ÿåº¦æˆ–è€…æ›´å¤§çš„ååæ€»é‡ã€‚ä»è€Œä¸ºäº†å®ç°æ›´ä½çš„æ¨ç†æˆæœ¬ã€‚</p><h3 id="_90-å¤§æ¨¡å‹æ¨ç†å¼•æ“é€šå¸¸ç”±å“ªäº›éƒ¨åˆ†ç»„æˆ-ä¸éå¤§æ¨¡å‹çš„æ¨ç†å¼•æ“çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#_90-å¤§æ¨¡å‹æ¨ç†å¼•æ“é€šå¸¸ç”±å“ªäº›éƒ¨åˆ†ç»„æˆ-ä¸éå¤§æ¨¡å‹çš„æ¨ç†å¼•æ“çš„åŒºåˆ«"><span>90. å¤§æ¨¡å‹æ¨ç†å¼•æ“é€šå¸¸ç”±å“ªäº›éƒ¨åˆ†ç»„æˆï¼Ÿä¸éå¤§æ¨¡å‹çš„æ¨ç†å¼•æ“çš„åŒºåˆ«ï¼Ÿ</span></a></h3><p>Sglangï¼š<br> ç”¨æˆ·ç«¯ + æœåŠ¡ç«¯ï¼ˆTokenlizeï¼ŒForwardï¼ŒDetokenizeï¼‰</p><figure><img src="/Notes/assets/img/90.b0d9d552.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>TVMç­‰éå¤§æ¨¡å‹æ¨ç†å¼•æ“/ç¼–è¯‘å™¨ï¼š</p><p>å®ƒä»¬è¦æ¥æ”¶ä¸åŒç±»å‹çš„å°æ¨¡å‹ï¼Œå¤æ‚æ€§ä¼šå¥½å¾ˆå¤šã€‚</p><p>é€šè¿‡ä¸€ç³»åˆ—Relay Passeså»ä¼˜åŒ–å›¾ï¼›é€šè¿‡AutoTVMæ¥æ§åˆ¶å›¾ä¸Šçš„ä¸€äº›ç®—å­ï¼›å›¾ä¼˜åŒ–å®Œæˆåå†é™çº§ä¸ºæ›´ä½å±‚æ¬¡çš„è¡¨ç¤ºï¼Œç„¶åè¿˜æœ‰ä¸€äº›passeså¤„ç†ä½å±‚æ¬¡çš„è¡¨ç¤ºã€‚ç„¶åå†è¿›è¡Œä»£ç ç”Ÿæˆï¼ˆTarget translationï¼‰æ¥ç”Ÿæˆruntimeç±»å‹çš„IRï¼Œè¢«ä¸€äº›LLVM/TensorRTç­‰ç¼–è¯‘å™¨æ¥æ”¶ã€‚</p><figure><img src="/Notes/assets/img/90_1.32c95996.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="å…«-leetcode" tabindex="-1"><a class="header-anchor" href="#å…«-leetcode"><span>å…«. Leetcode</span></a></h2><p>ä¼˜å…ˆçº§ç¬¬ä¸€ï¼šDFS ã€ äºŒå‰æ ‘<br> äºŒå‰æ ‘çš„è§£æ³•å’Œç¼–è¯‘å™¨éå¸¸ç›¸ä¼¼ã€‚</p><p>ä¼˜å…ˆçº§ç¬¬äºŒï¼šäºŒåˆ†æŸ¥æ‰¾ã€é“¾è¡¨</p><p>ä¼˜å…ˆçº§ç¬¬ä¸‰ï¼šæ‹“æ‰‘æ’åºï¼ˆä¸¤ä¸ªè¯¾ç¨‹è¡¨ï¼‰</p><h3 id="_91-c-å®ç°ç»å…¸æ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_91-c-å®ç°ç»å…¸æ•°æ®ç»“æ„"><span>91. C++å®ç°ç»å…¸æ•°æ®ç»“æ„</span></a></h3><ol><li>Vector</li><li>List</li><li>String</li></ol><p>æ„é€ å‡½æ•°ã€ææ„å‡½æ•°ã€æ‹·è´æ„é€ å‡½æ•°ã€æ‹·è´èµ‹å€¼å‡½æ•°ã€ç§»åŠ¨æ„é€ å‡½æ•°ã€ç§»åŠ¨èµ‹å€¼å‡½æ•°</p><h3 id="_92-c-å†™ç®—å­" tabindex="-1"><a class="header-anchor" href="#_92-c-å†™ç®—å­"><span>92. C++å†™ç®—å­</span></a></h3><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//Softmax</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// e^(xi - max(xi)) / sigma(e^(xi - max(xi))), æ±‚[row, cols]çš„softmax</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> softmax</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> input</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> output</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> row</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> cols</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> row; i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        float</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> max_val </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> input</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> cols];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> j </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; j </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> cols; j</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            max_val </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> max</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(max_val, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">input</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> cols </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> j]);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        float</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> sum_exp </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> j </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; j </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> cols; j</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            sum_exp </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> exp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">input</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> cols </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> j] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> max_val);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> j </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; j </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> cols; j</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            output</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> cols </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> j] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> exp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">input</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> cols </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> j] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> max_val) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> sum_exp;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_93-cudaå†™ç®—å­" tabindex="-1"><a class="header-anchor" href="#_93-cudaå†™ç®—å­"><span>93. CUDAå†™ç®—å­</span></a></h3><ol><li>Reduce</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">__global__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> reduce_v1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> input, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> output, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> idx </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    __shared__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(idx </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N){</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[tid] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> input</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[idx];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[tid] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    __syncthreads</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> step </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; step </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; step </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">){</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(tid </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">%</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">step) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">){</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[tid] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[tid </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> step];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        __syncthreads</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(tidx </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">d_output</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">__global__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> reduce_v2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> input, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> output, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> idx </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    __shared__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(idx </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N){</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[tid] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> input</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[idx];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[tid] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    __syncthreads</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> step </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; step </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; step </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">){</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //è¿™é‡Œå’Œ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(tid </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> step){</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> //è¿™é‡Œä¸åŒ</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[tid] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[tid </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> step];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        __syncthreads</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(tidx </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">d_output</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>Transpose</li></ol><figure><img src="/Notes/assets/img/94_1.cd69ea45.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">__global__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> transpose</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> input, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> output) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> row </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> col </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tidx </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tidy </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    __shared__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">][</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (row </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> M </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> col </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[tidx][tidy] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> input</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[row </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> col];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//è¿™é‡Œå­˜blockçš„æ—¶å€™å·²ç»åšäº†è½¬ç½®äº†ï¼Œå¦‚ä¸Šå›¾çš„ä¸­é—´</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        __syncthreads</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> newrow </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> newcol </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> blockDim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">y</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> threadIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(newrow </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> newcol </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> M){</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            output</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[newrow </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> M </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> newcol] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[tidy][tidx];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//s_data[tidy][tidx]æ˜¯åšäº†è¯­ä¹‰æ¢å¤ï¼Œå¦‚ä¸Šå›¾çš„å³è¾¹</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            __syncthreads</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">__global__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> transpose</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> input, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> output) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    __shared__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">][</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">33</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//paddingæ³•è§£å†³bank conflict</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">__global__ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> transpose</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> input, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">float*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> output) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[tidx][tidy</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">^</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tidx] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> input</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[row </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> N </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> col];</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    output</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[newrow </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> M </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> newcol] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> s_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[tidy][tidx</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">^</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tidy];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//swizzlingæ³•è§£å†³bank conflict</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li><p>Softmax<br><img src="/Notes/assets/img/94_2.d4e34867.png" alt="" loading="lazy"></p></li><li><p>GEMM</p></li></ol></div><!----><!----><!----></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/your-username/your-repo/edit/main/src/zh/posts/interview.md" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">æœ€è¿‘æ›´æ–°ï¼š</span><time class="vp-meta-info" datetime="2025-09-12T09:54:49.000Z" data-allow-mismatch>2025/9/12 09:54</time></div><div class="contributors"><span class="vp-meta-label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="vp-meta-info" title="email: gaoyuqing536@gmail.com">yqgao</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/Notes/zh/posts/Inference.html" aria-label="InferenceæœåŠ¡çš„ä¸€äº›å¸¸è§é—®é¢˜"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->InferenceæœåŠ¡çš„ä¸€äº›å¸¸è§é—®é¢˜</div></a><a class="route-link auto-link next" href="/Notes/zh/posts/MoE.html" aria-label="MoE"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">MoE<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">é»˜è®¤é¡µè„š</div><div class="vp-copyright">Copyright Â© 2025 GYQ </div></footer></div><!--]--><!--[--><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script src="/Notes/assets/js/runtime~app.712cebb1.js" defer></script><script src="/Notes/assets/js/2047.24e5abc8.js" defer></script><script src="/Notes/assets/js/app.c0f0669f.js" defer></script>
  </body>
</html>
