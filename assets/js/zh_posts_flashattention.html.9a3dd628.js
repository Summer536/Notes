"use strict";(self.webpackChunkvuepress=self.webpackChunkvuepress||[]).push([[609],{6262:(s,a)=>{a.A=(s,a)=>{const n=s.__vccOpts||s;for(const[s,t]of a)n[s]=t;return n}},7586:(s,a,n)=>{n.r(a),n.d(a,{comp:()=>O,data:()=>V});var t=n(641);const m=n.p+"assets/img/FAV1_0.de162840.png",p=n.p+"assets/img/FAV1_2.92bf628c.png",l=n.p+"assets/img/MACandFlops.6e053a7e.png",e=n.p+"assets/img/FAV1_6.b5674640.png",i=n.p+"assets/img/FAV1_5.3ad82930.png",r=n.p+"assets/img/step1(1).30d8e3e9.png",c=n.p+"assets/img/step2.3cdd4bb5.png",h=n.p+"assets/img/step3.cb090cb8.png",o=n.p+"assets/img/step4.56d0b2a7.png",g=n.p+"assets/img/Tiling1.54a9a0e7.png",k=n.p+"assets/img/tiling2.c503ef2d.png",y=n.p+"assets/img/FAV1_9.f393d210.png",u=n.p+"assets/img/step5.67af80d2.png",d=n.p+"assets/img/step6.bb1625d5.png",L=n.p+"assets/img/step7.f061591b.png",v=n.p+"assets/img/step8.460a0111.png",w=n.p+"assets/img/step9.f83f2175.png",b=n.p+"assets/img/FAV1_10.1dc07bab.png",x=n.p+"assets/img/step10.9cd5a0a6.png",z=n.p+"assets/img/step11.02df6c75.png",f=n.p+"assets/img/FAV1_11.b77d3ed6.png",M=n.p+"assets/img/FAV1_12.26d002f4.png",j=n.p+"assets/img/FAV1_13.dd18521a.png",_=n.p+"assets/img/step12.8d95336e.png",B=n.p+"assets/img/step13.48e537c0.png",N=n.p+"assets/img/FAV1_14.ff8cae98.png",S={},O=(0,n(6262).A)(S,[["render",function(s,a){return(0,t.uX)(),(0,t.CE)("div",null,[a[0]||(a[0]=(0,t.Lk)("h1",{id:"flashattention",tabindex:"-1"},[(0,t.Lk)("a",{class:"header-anchor",href:"#flashattention"},[(0,t.Lk)("span",null,"Flashattention")])],-1)),a[1]||(a[1]=(0,t.Lk)("h2",{id:"简介",tabindex:"-1"},[(0,t.Lk)("a",{class:"header-anchor",href:"#简介"},[(0,t.Lk)("span",null,"简介")])],-1)),a[2]||(a[2]=(0,t.Lk)("p",null,"Flashattention是一种高效的注意力机制计算方法，由斯坦福大学研究团队在2022年提出。它通过优化GPU内存访问模式，显著提高了Transformer模型中注意力计算的速度并降低了内存使用。作为大模型训练和推理的关键优化技术，Flashattention已被广泛应用于各种大型语言模型中。",-1)),(0,t.Q3)(" more "),a[3]||(a[3]=(0,t.Fv)('<h2 id="一、flashattention-v1" tabindex="-1"><a class="header-anchor" href="#一、flashattention-v1"><span>一、Flashattention-V1</span></a></h2><h3 id="_1-1-标准注意力机制" tabindex="-1"><a class="header-anchor" href="#_1-1-标准注意力机制"><span>1.1 标准注意力机制</span></a></h3><p>给定输入二维矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">Q, K, V \\in \\mathbb{R}^{N \\times d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span>，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> 是输入序列的长度，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> 是自注意力机制头的长度。Softmax 是按行应用的，注意力输出矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">O \\in \\mathbb{R}^{N \\times d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span> 的计算公式如下：</p>',3)),a[4]||(a[4]=(0,t.Lk)("p",{class:"katex-block"},[(0,t.Lk)("span",{class:"katex-display"},[(0,t.Lk)("span",{class:"katex"},[(0,t.Lk)("span",{class:"katex-mathml"},[(0,t.Lk)("math",{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},[(0,t.Lk)("semantics",null,[(0,t.Lk)("mtable",{rowspacing:"0.25em",columnalign:"right left",columnspacing:"0em"},[(0,t.Lk)("mtr",null,[(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mi",null,"S")])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow",null,[(0,t.Lk)("mrow"),(0,t.Lk)("mo",null,"="),(0,t.Lk)("mi",null,"Q"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"K"),(0,t.Lk)("mi",{mathvariant:"normal"},"T")]),(0,t.Lk)("mo",null,"∈"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",{mathvariant:"double-struck"},"R"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mi",null,"N"),(0,t.Lk)("mo",null,"×"),(0,t.Lk)("mi",null,"N")])]),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mspace",{width:"1em"}),(0,t.Lk)("mi",null,"P"),(0,t.Lk)("mo",null,"="),(0,t.Lk)("mtext",null,"softmax"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"S"),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("mo",null,"∈"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",{mathvariant:"double-struck"},"R"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mi",null,"N"),(0,t.Lk)("mo",null,"×"),(0,t.Lk)("mi",null,"N")])]),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mspace",{width:"1em"}),(0,t.Lk)("mi",null,"O"),(0,t.Lk)("mo",null,"="),(0,t.Lk)("mi",null,"P"),(0,t.Lk)("mi",null,"V"),(0,t.Lk)("mo",null,"∈"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",{mathvariant:"double-struck"},"R"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mi",null,"N"),(0,t.Lk)("mo",null,"×"),(0,t.Lk)("mi",null,"d")])]),(0,t.Lk)("mi",{mathvariant:"normal"},".")])])])])]),(0,t.Lk)("annotation",{encoding:"application/x-tex"},"\\begin{align*} S &= Q K^\\mathrm{T} \\in \\mathbb{R}^{N \\times N}, \\quad P = \\text{softmax}(S) \\in \\mathbb{R}^{N \\times N}, \\quad O = P V \\in \\mathbb{R}^{N \\times d}. \\end{align*} ")])])]),(0,t.Lk)("span",{class:"katex-html","aria-hidden":"true"},[(0,t.Lk)("span",{class:"base"},[(0,t.Lk)("span",{class:"strut",style:{height:"1.5591em","vertical-align":"-0.5296em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mtable"},[(0,t.Lk)("span",{class:"col-align-r"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"1.0296em"}},[(0,t.Lk)("span",{style:{top:"-3.1304em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.05764em"}},"S")])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.5296em"}},[(0,t.Lk)("span")])])])]),(0,t.Lk)("span",{class:"col-align-l"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"1.0296em"}},[(0,t.Lk)("span",{style:{top:"-3.1304em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"}),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"="),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mord mathnormal"},"Q"),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.07153em"}},"K"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.8913em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mathrm mtight"},"T")])])])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"∈"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbb"},"R"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.8913em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.10903em"}},"N"),(0,t.Lk)("span",{class:"mbin mtight"},"×"),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.10903em"}},"N")])])])])])])])]),(0,t.Lk)("span",{class:"mpunct"},","),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"1em"}}),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.13889em"}},"P"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"="),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"softmax")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.05764em"}},"S"),(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"∈"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbb"},"R"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.8913em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.10903em"}},"N"),(0,t.Lk)("span",{class:"mbin mtight"},"×"),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.10903em"}},"N")])])])])])])])]),(0,t.Lk)("span",{class:"mpunct"},","),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"1em"}}),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.02778em"}},"O"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"="),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.13889em"}},"P"),(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.22222em"}},"V"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"∈"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbb"},"R"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.8991em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.10903em"}},"N"),(0,t.Lk)("span",{class:"mbin mtight"},"×"),(0,t.Lk)("span",{class:"mord mathnormal mtight"},"d")])])])])])])])]),(0,t.Lk)("span",{class:"mord"},".")])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.5296em"}},[(0,t.Lk)("span")])])])])])])])])])])],-1)),a[5]||(a[5]=(0,t.Fv)('<p><img src="'+m+'" alt="" loading="lazy"><br> 标准的 Attention 运算大致可以描述为以下三个步骤：</p><ul><li>将 Q,K 矩阵以块的形式从 HBM 中加载到 SRAM 中，计算 S=QK ，将 S 写入到 HBM 中。</li><li>将 S 矩阵从 HBM 中加载到 SRAM 中，计算 P=Softmax(S) ，将 P 写入到 HBM 中。</li><li>将 P,V 矩阵以块的形式从 HBM 中加载到 SRAM 中，计算 O=PV ，将 O 写入到 HBM 中。</li></ul><figure><img src="'+p+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>self-attention 算子涉及到的和 HBM 数据传输过程如上图所示，很明显需要从 HBM 中读取 5 次，写入 HBM 3 次，HBM 访存量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>A</mi><mi>C</mi><mo>=</mo><mn>4</mn><msup><mi>N</mi><mn>2</mn></msup><mo>+</mo><mn>3</mn><mi>N</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">MAC = 4N^2 + 3Nd</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">3</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">d</span></span></span></span>，很明显标准注意力的 HBM 访问代价 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>A</mi><mi>C</mi></mrow><annotation encoding="application/x-tex">MAC</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> 随序列长度增加呈二次方增长。</p><p>而 self-attention 的计算量为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><msup><mi>N</mi><mn>2</mn></msup><mi>d</mi><mo>+</mo><msup><mi>N</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">4N^2d+N^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>，标准注意力算子的操作强度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mfrac><mrow><mn>4</mn><msup><mi>N</mi><mn>2</mn></msup><mi>d</mi><mo>+</mo><msup><mi>N</mi><mn>2</mn></msup></mrow><mrow><mn>4</mn><msup><mi>N</mi><mn>2</mn></msup><mo>+</mo><mn>3</mn><mi>N</mi><mi>d</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">= \\frac{4N^2d+N^2}{4N^2 + 3Nd}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.4213em;vertical-align:-0.4033em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0179em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight">3</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal mtight">d</span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。公式可看出，标准注意力算子是一个很明显的内存受限型算子。<br><img src="'+l+'" alt="" loading="lazy"></p><h3 id="_1-2-fav1整体介绍" tabindex="-1"><a class="header-anchor" href="#_1-2-fav1整体介绍"><span>1.2 FAV1整体介绍</span></a></h3><h4 id="挑战" tabindex="-1"><a class="header-anchor" href="#挑战"><span>挑战</span></a></h4><p>在Flash Attention出来之前，已经有了很多了fusedattention算子，但是仔细看，可以发现这其实不是真正的融合算子，只是把matmul kernel、scale kernel、softmax kernel的接口在一个fusedattention算子里面按照计算顺序调了一下，这种手法最多减少了pytorch、TF等框架对算子的调度开销，其实不能真正解决对HBM或者显存的memory traffic。</p><p><strong>融合MHA的挑战在于两点：</strong></p><p>1.解决softmax，因为softmax是一个row-wise（以行为单位）的操作，必须要遍历softmax一行才能得到结果，由此，后面的matmul不得不等待这个过程，导致并行性降低</p><p>2.在寄存器和shared memory复用数据做计算，而不是去HBM或显存上去读数据来计算，然而寄存器数量和shared memory (也就是图中的SRAM) 大小都有限，在左图的情况下，显然无法将softmax的结果存到这两个存储单元里面供下一个matmul复用，下一个matmul不得不去HBM或显存上读数据</p><figure><img src="'+e+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="整体思想" tabindex="-1"><a class="header-anchor" href="#整体思想"><span>整体思想</span></a></h4><p>FAV1算法整体做到了如下的两部分：</p><ul><li>Tiling（在前向和后向传递中使用）: <ol><li><p>（解决挑战1）Online Softmax 实现在一个 for 循环中计算<br><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">m_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">d_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ，<strong>FlashAttention-v1 基于它的思想更进一步，实现在一个 for 循环中计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">m_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">d_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和注意力输出 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">O_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ，也就是说，在一个 kernel 中实现 attention 的所有操作</strong>。</p></li><li><p>（解决挑战2）再<strong>通过分块 Tiling 技术</strong>，将输入的 Q、K、V 矩阵拆分为多个块，将其从较慢的 HBM 加载到更快的 SRAM 中，从而大大减少了 HBM 访问次数（内存读/写的次数），然后分别计算这些块的注意力输出，最后，将每个块的输出按正确的归一化因子缩放之后相加后可得到精确的注意力输出。</p></li></ol></li><li>重新计算（仅在后向传递中使用）:核心思想为不为反向传递存储S、P矩阵，但是输出softmax的l和m，在反向传播时，重新计算S、P矩阵。</li></ul><h3 id="_1-3-fav1算法流程" tabindex="-1"><a class="header-anchor" href="#_1-3-fav1算法流程"><span>1.3 FAV1算法流程</span></a></h3>',16)),(0,t.Q3)(' ![](Figure/flashattention/FAV1_1.png "FlashAttention Block Diagram") '),(0,t.Q3)(' <p align="center">\n  <img src="Figure/FA1.png" width="500" alt="核心思想"/>\n</p> '),a[6]||(a[6]=(0,t.Fv)('<p>Flashattention总体的算法流程图如下：<br><img src="'+i+'" alt="" loading="lazy"></p><hr><ol><li>设置块的行大小 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>=</mo><mfrac><mi>M</mi><mrow><mn>4</mn><mi>d</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">B_r = \\frac{M}{4d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2173em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>，块的列大小为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>c</mi></msub><mo>=</mo><mi>min</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><mi>M</mi><mrow><mn>4</mn><mi>d</mi></mrow></mfrac><mo separator="true">,</mo><mi>d</mi><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">B_c = \\min\\left(\\frac{M}{4d}, d\\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2223em;vertical-align:-0.35em;"></span><span class="mop">min</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span></span> 。 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>min</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\\min</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6679em;"></span><span class="mop">min</span></span></span></span> 函数的目的是防止块大小 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><msub><mi>B</mi><mi>c</mi></msub><mo>&gt;</mo><mi>M</mi><mi mathvariant="normal">/</mi><mn>4</mn></mrow><annotation encoding="application/x-tex">B_r \\times B_c &gt; M/4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord">/4</span></span></span></span>，这样就无法把 4 个这样的块放到 SRAM 里，后面我们会看到为什么是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>×</mo><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><msub><mi>B</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">4 \\times B_r \\times B_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的块。<br><img src="'+r+'" alt="" loading="lazy"></li></ol><hr><ol start="2"><li>我们把结果矩阵O初始化为零，后面会逐步把中间结果累加进去，所以零是合适的初始值。类似的是l(注意：对于每一行来说，它是一个标量，用于累加指数和，由于输出有N行，所以这里的l是长度为N的向量)。m用于记录每一行当前最大的值，所以也是长度为N，而-inf是求max的合适初始值。<br><img src="'+c+'" alt="" loading="lazy"></li></ol><hr><ol start="3"><li>设置块的行大小<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>=</mo><mfrac><mi>M</mi><mrow><mn>4</mn><mi>d</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">B_r = \\frac{M}{4d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2173em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>，块的列大小为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>c</mi></msub><mo>=</mo><mi>min</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><mi>M</mi><mrow><mn>4</mn><mi>d</mi></mrow></mfrac><mo separator="true">,</mo><mi>d</mi><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">B_c = \\min\\left(\\frac{M}{4d}, d\\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2223em;vertical-align:-0.35em;"></span><span class="mop">min</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span></span>。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>min</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\\min</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6679em;"></span><span class="mop">min</span></span></span></span>函数的目的是防止块大小<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><msub><mi>B</mi><mi>c</mi></msub><mo>&gt;</mo><mi>M</mi><mi mathvariant="normal">/</mi><mn>4</mn></mrow><annotation encoding="application/x-tex">B_r \\times B_c &gt; M/4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord">/4</span></span></span></span>，这样就无法把4个这样的块放到SRAM里，后面我们会看到为什么是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>×</mo><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><msub><mi>B</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">4 \\times B_r \\times B_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>的块。<br><img src="'+h+'" alt="" loading="lazy"></li></ol><hr><ol start="4"><li>根据前面的计算，结果矩阵<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi></mrow><annotation encoding="application/x-tex">O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span></span></span></span>需要切分成<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝐵</mi><mi>𝑟</mi><mo>×</mo><mi>𝑑</mi></mrow><annotation encoding="application/x-tex">𝐵𝑟×𝑑</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span>的块来存放中间结果。长度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span>也要切分成<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝐵</mi><mi>𝑟</mi></mrow><annotation encoding="application/x-tex">𝐵𝑟</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>个元素的块，用于存放这些行当前的指数累加值和当前最大值。<br><img src="'+o+'" alt="" loading="lazy"><br><img src="'+g+'" alt="" loading="lazy"><br><img src="'+k+'" alt="" loading="lazy"></li></ol><hr><p>算法图<br><img src="'+y+'" alt="" loading="lazy"></p><ul><li>这个图展示了第5步开始的两层循环，<strong>逻辑就是外层循环的下标 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> 就是循环 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">K^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span>，而内存循环的下标就是循环 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span></span></span></span></strong>。首先外层循环取出大小为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>×</mo><msub><mi>B</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">d \\times B_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的 $ K_j^T$ 和大小为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>c</mi></msub><mo>×</mo><mi>d</mi></mrow><annotation encoding="application/x-tex">B_c \\times d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> 的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">V_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>，然后内层循环遍历整个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span></span></span></span>，比如当前是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>，也就是大小为 $B_r \\times d $ 的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Q_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。我们就可以计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo>=</mo><mi>s</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><msub><mi>Q</mi><mi>i</mi></msub><msubsup><mi>K</mi><mi>j</mi><mi>T</mi></msubsup><msub><mi>V</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O = softmax(Q_i K_j^T V_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.3948em;"></span><span class="mord mathnormal">so</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。不过要记住，这是部分的计算结果，所以我们要保存（更新）中间统计量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span>，等到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">j+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 的下一次循环时，内层循环还会再次遍历 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span></span></span></span>，那个时候会计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo>=</mo><mi>s</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><msub><mi>Q</mi><mi>i</mi></msub><msubsup><mi>K</mi><mrow><mi>j</mi><mo>+</mo><mn>1</mn></mrow><mi>T</mi></msubsup><msub><mi>V</mi><mrow><mi>j</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O = softmax(Q_i K_{j+1}^T V_{j+1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.3948em;"></span><span class="mord mathnormal">so</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，然后把这次的结果合并到最终的结果里。包括统计量也需要同步更新。</li><li><strong>内循环一次 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Q_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 填满一次 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mtext>、</mtext><mi>l</mi><mtext>、</mtext><mi>m</mi></mrow><annotation encoding="application/x-tex">O、l、m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord cjk_fallback">、</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord cjk_fallback">、</span><span class="mord mathnormal">m</span></span></span></span>，共循环<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">T_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>次</strong></li><li><strong>外循环一次 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>K</mi><mi>j</mi><mi>T</mi></msubsup><mtext>、</mtext><msub><mi>V</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">K_j^T、V_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.3948em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span><span class="mord cjk_fallback">、</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> 更新一次 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mtext>、</mtext><mi>l</mi><mtext>、</mtext><mi>m</mi></mrow><annotation encoding="application/x-tex">O、l、m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord cjk_fallback">、</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord cjk_fallback">、</span><span class="mord mathnormal">m</span></span></span></span>，共循环<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">T_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>次</strong></li><li><strong>整体循环结束<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mtext>、</mtext><mi>l</mi><mtext>、</mtext><mi>m</mi></mrow><annotation encoding="application/x-tex">O、l、m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord cjk_fallback">、</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord cjk_fallback">、</span><span class="mord mathnormal">m</span></span></span></span> 就是最终结果</strong></li></ul><hr><ol start="5"><li>这是外层循环，j表示K和V的下标。<br><img src="'+u+'" alt="" loading="lazy"></li></ol><hr><ol start="6"><li>我们首先把<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">K_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">V_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>从HBM加载到SRAM。根据前面的讨论，这会占据SRAM <strong>约50%</strong> 的存储。(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>c</mi></msub><mo>=</mo><mi>min</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><mi>M</mi><mrow><mn>4</mn><mi>d</mi></mrow></mfrac><mo separator="true">,</mo><mi>d</mi><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">B_c = \\min\\left(\\frac{M}{4d}, d\\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2223em;vertical-align:-0.35em;"></span><span class="mop">min</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span></span>，如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>=</mo><mfrac><mi>M</mi><mrow><mn>4</mn><mi>d</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">B_r = \\frac{M}{4d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2173em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>×</mo><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><mi>d</mi><mo>=</mo><mfrac><mi>M</mi><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">2 \\times B_r \\times d = \\frac{M}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2173em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>，正好占50%的SRAM; 如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>=</mo><mi>d</mi></mrow><annotation encoding="application/x-tex">B_r = d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span>, 则说明<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>&lt;</mo><mfrac><mi>M</mi><mrow><mn>4</mn><mi>d</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">d &lt; \\frac{M}{4d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2173em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>，占SRAM会小于50%)<br><img src="'+d+'" alt="" loading="lazy"></li></ol><hr><ol start="7"><li>内循环，i表示Q的下标。<br><img src="'+L+'" alt="" loading="lazy"></li></ol><hr><ol start="8"><li>把<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>i</mi></msub><mo stretchy="false">(</mo><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q_i(B_r \\times d)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>i</mi></msub><mo stretchy="false">(</mo><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O_i(B_r \\times d)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span>加载进SRAM，同时把<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>l</mi><mi>i</mi></msub><mo stretchy="false">(</mo><msub><mi>B</mi><mi>r</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">l_i(B_r)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>i</mi></msub><mo stretchy="false">(</mo><msub><mi>B</mi><mi>r</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">m_i(B_r)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>也加载进去。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Q_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">O_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>会<strong>占据50%的显存</strong>。而<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>l</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">l_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">m_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>比较小，根据<strong>论文作者的说法</strong>可以放到寄存器里。<br><img src="'+v+'" alt="" loading="lazy"></li></ol><hr><ol start="9"><li>计算分块矩阵<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>i</mi></msub><mo stretchy="false">(</mo><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q_i(B_r \\times d)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">K_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>的转置<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>d</mi><mo>×</mo><msub><mi>B</mi><mi>c</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(d \\times B_c)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>的乘积，得到score <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">(</mo><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><msub><mi>B</mi><mi>c</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">S_{ij}(B_r \\times B_c)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。<br><img src="'+w+'" alt="" loading="lazy"><br> 我们可以看到这里不需要计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>×</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">N \\times N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>的得分S矩阵，也就是不需要“materialized”。而只需要很小的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">S_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>。<br> 我们来看一个简单的示例：这里假设外层循环下标<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">j=3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span>，内层循环下标<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">i=2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mn>25</mn></mrow><annotation encoding="application/x-tex">N=25</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">25</span></span></span></span>，块大小是5（这里假设下标从1开始）。那么计算如下图所示：</li></ol><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>Q</mi><mi>i</mi></msub><mo>⋅</mo><msubsup><mi>K</mi><mi>j</mi><mi>T</mi></msubsup><mo>=</mo><mo stretchy="false">(</mo><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><mi>d</mi><mo stretchy="false">)</mo><mo>⋅</mo><mo stretchy="false">(</mo><mi>d</mi><mo>×</mo><msub><mi>B</mi><mi>c</mi></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><msub><mi>B</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">Q_i \\cdot K_j^T = (B_r \\times d) \\cdot (d \\times B_c) = B_r \\times B_c </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.2744em;vertical-align:-0.3831em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><figure><img src="'+b+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>上图计算的是attention得分是Query为第6-10个token，Key是第11-15个token。</li></ul><hr><ol start="10"><li>计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\\tilde{m}_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.954em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>l</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\\tilde{l}_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2174em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9313em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span><span style="top:-3.6134em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>P</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\\tilde{P}_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2063em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9202em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span><span style="top:-3.6023em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>，使用前面的公式就可以简单的得出。<br><img src="'+x+'" alt="" loading="lazy"></li></ol><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\\tilde{m}_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.954em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>是逐行计算的，找到每一行的最大值。</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>P</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\\tilde{P}_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2063em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9202em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span><span style="top:-3.6023em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>是逐点运算，把<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">S_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>减去第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>行的最大值<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\\tilde{m}_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.954em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>（注意：这个下标<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>表示这是第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span>次计算，其实是一个值而不是向量），然后在计算指数。</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>l</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\\tilde{l}_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2174em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9313em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span><span style="top:-3.6134em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>也是逐行计算，把每一行的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>P</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\\tilde{P}_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2063em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9202em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span><span style="top:-3.6023em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>加起来。</li></ul><hr><ol start="11"><li></li></ol><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">m_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>包含了在当前块（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">j=3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span>）之前所有块的最大值（按行），比如上面的例子，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">m_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>保存了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">j=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">j=2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span>（图中的绿色块）块第6~10行的最大值。而<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\\tilde{m}_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.954em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>是上一步得到的当前块（黄色）的最大值。因此取它们两者的最大值就得到前3个块（绿色加黄色块共15列）的最大值。</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>l</mi><mi>i</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">l_i^{new}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9531em;vertical-align:-0.2587em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4413em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span></span></span></span>的计算也是类似的，只不过求和前需要用当前的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><mo>−</mo><msubsup><mi>m</mi><mi>i</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msubsup></mrow></msup></mrow><annotation encoding="application/x-tex">e^{-m_i^{new}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.88em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.88em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7385em;"><span style="top:-2.214em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>修正，具体可参考<a href="https://summer536.github.io/Notes/zh/posts/softmax.html" target="_blank" rel="noopener noreferrer">Naive -&gt; Safe -&gt; Online Softmax</a>。<br><img src="'+z+'" alt="" loading="lazy"><br><img src="'+f+'" alt="" loading="lazy"></li></ul><hr><ol start="12"><li>这里先介绍一下<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>i</mi><mi>a</mi><mi>g</mi><mo stretchy="false">(</mo><msub><mi>l</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">diag(l_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">ia</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，它是一个对角矩阵，对角线上的元素是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>l</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">l_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。(diag( )将一个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>∗</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">N*1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>的向量变成<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>∗</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">N*N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>的对角矩阵, 如下图左侧矩阵)为什么要搞出这么复杂的东西呢？目的就是把前面我们更新l的公式能写成矩阵乘法的形式，这样才能在GPU上高效计算。<br><img src="'+M+'" alt="" loading="lazy"><br><img src="'+j+'" alt="" loading="lazy"></li></ol><p><img src="'+_+'" alt="" loading="lazy"><br> 第12步公式的<strong>绿色部分是更新当前块（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">j=3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span>）之前的块（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>&lt;</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">j&lt;3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span>）的 softmax 值</strong>。</p><p>我们回忆一下前面的例子：在一开始 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mn>1</mn></msup><mo>=</mo><mo stretchy="false">[</mo><msub><mi>x</mi><mn>1</mn></msub><mo>=</mo><mn>1</mn><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo>=</mo><mn>3</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">x^1 = [x_1 = 1, x_2 = 3]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">3</span><span class="mclose">]</span></span></span></span>，前两个数的 softmax 值是：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>l</mi><mo>=</mo><msup><mi>e</mi><mrow><mn>1</mn><mo>−</mo><mn>3</mn></mrow></msup><mo>+</mo><msup><mi>e</mi><mrow><mn>3</mn><mo>−</mo><mn>3</mn></mrow></msup></mrow><annotation encoding="application/x-tex">l = e^{1-3} + e^{3-3} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mbin mtight">−</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span></span></p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mi>V</mi><mo>=</mo><mo stretchy="false">[</mo><msup><mi>e</mi><mrow><mn>1</mn><mo>−</mo><mn>3</mn></mrow></msup><mo separator="true">,</mo><msup><mi>e</mi><mrow><mn>3</mn><mo>−</mo><mn>3</mn></mrow></msup><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">PV = [e^{1-3}, e^{3-3}] </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mbin mtight">−</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>O</mi><mo>=</mo><mrow><mo fence="true">[</mo><mfrac><msup><mi>e</mi><mrow><mn>1</mn><mo>−</mo><mn>3</mn></mrow></msup><mrow><msup><mi>e</mi><mrow><mn>1</mn><mo>−</mo><mn>3</mn></mrow></msup><mo>+</mo><msup><mi>e</mi><mrow><mn>3</mn><mo>−</mo><mn>3</mn></mrow></msup></mrow></mfrac><mo separator="true">,</mo><mfrac><msup><mi>e</mi><mrow><mn>3</mn><mo>−</mo><mn>3</mn></mrow></msup><mrow><msup><mi>e</mi><mrow><mn>1</mn><mo>−</mo><mn>3</mn></mrow></msup><mo>+</mo><msup><mi>e</mi><mrow><mn>3</mn><mo>−</mo><mn>3</mn></mrow></msup></mrow></mfrac><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">O = \\left[ \\frac{e^{1-3}}{e^{1-3} + e^{3-3}}, \\frac{e^{3-3}}{e^{1-3} + e^{3-3}} \\right] </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4411em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4911em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mbin mtight">−</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4911em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mbin mtight">−</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mbin mtight">−</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p><p>现在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mn>2</mn></msup><mo>=</mo><mo stretchy="false">[</mo><msub><mi>x</mi><mn>3</mn></msub><mo>=</mo><mn>2</mn><mo separator="true">,</mo><msub><mi>x</mi><mn>4</mn></msub><mo>=</mo><mn>4</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">x^2 = [x_3 = 2, x_4 = 4]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mclose">]</span></span></span></span> 加入，使得最大值变成了 4，并且指数的和也增加了。所以第一步的需要重新计算。怎么重新计算呢？因为之前的 PV 没有保存，所以我们可以用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> 乘以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi></mrow><annotation encoding="application/x-tex">O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span></span></span></span> 恢复出 PV。论文中是矩阵的形式，也就是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>i</mi><mi>a</mi><mi>g</mi><mo stretchy="false">(</mo><msub><mi>l</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>×</mo><msub><mi>O</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">diag(l_i) \\times O_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">ia</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。恢复出来的 R 再乘以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><msub><mi>m</mi><mi>i</mi></msub><mo>−</mo><msubsup><mi>m</mi><mi>i</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msubsup></mrow></msup></mrow><annotation encoding="application/x-tex">e^{m_i - m_i^{new}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.88em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.88em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7385em;"><span style="top:-2.214em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 就是修正后的 PV，也就是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></msup><msub><mi>V</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">e^{x_i - max(x)} V_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1741em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>。</p><p>也就是说，对于上面的例子，做这一步之后PV将会计算为:</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mi>V</mi><mo>=</mo><mi>l</mi><mo>×</mo><mi>O</mi><mo>×</mo><msup><mi>e</mi><mrow><msub><mi>m</mi><mi>i</mi></msub><mo>−</mo><msubsup><mi>m</mi><mi>i</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msubsup></mrow></msup><mo>=</mo><mo stretchy="false">[</mo><msup><mi>e</mi><mrow><mn>1</mn><mo>−</mo><mn>3</mn></mrow></msup><mo separator="true">,</mo><msup><mi>e</mi><mrow><mn>3</mn><mo>−</mo><mn>3</mn></mrow></msup><mo stretchy="false">]</mo><mo>×</mo><msup><mi>e</mi><mrow><mn>3</mn><mo>−</mo><mn>4</mn></mrow></msup><mo>=</mo><mo stretchy="false">[</mo><msup><mi>e</mi><mrow><mn>1</mn><mo>−</mo><mn>4</mn></mrow></msup><mo separator="true">,</mo><msup><mi>e</mi><mrow><mn>3</mn><mo>−</mo><mn>4</mn></mrow></msup><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">PV =l\\times O \\times e^{m_i - m_i^{new}} =[e^{1-3}, e^{3-3}] \\times e^{3-4} = [e^{1-4}, e^{3-4}] </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.93em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7385em;"><span style="top:-2.214em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mbin mtight">−</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8641em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mbin mtight">−</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mbin mtight">−</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></p><p>而<strong>公式的黄色部分是当前块（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">j=3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span>），<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>−</mo><msubsup><mi>m</mi><mi>i</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msubsup></mrow></msup></mrow><annotation encoding="application/x-tex">e^{\\tilde{m}_{ij} - m_i^{new}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.88em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.88em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord accent mtight"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-2.7em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mathnormal mtight">m</span></span><span style="top:-3.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord mtight">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7385em;"><span style="top:-2.214em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 是当前块的最大值减去 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>≤</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">j \\leq 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span> 所有块的最大值，这是对当前指数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>P</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\\tilde{P}_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2063em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9202em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span><span style="top:-3.6023em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> 的修正</strong>。代入<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>P</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msup><mi>e</mi><mrow><msub><mi>S</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow></msup></mrow><annotation encoding="application/x-tex">\\tilde{P}_{ij} = e^{S_{ij} - \\tilde{m}_{ij}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2063em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9202em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span><span style="top:-3.6023em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0576em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight"><span class="mord accent mtight"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-2.7em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mathnormal mtight">m</span></span><span style="top:-3.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord mtight">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>（第十步），那么可以发现其实就是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><msub><mi>S</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>−</mo><msubsup><mi>m</mi><mi>i</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msubsup></mrow></msup></mrow><annotation encoding="application/x-tex">e^{S_{ij} - m_i^{new}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.88em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.88em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0576em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7385em;"><span style="top:-2.214em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>。黄色部分乘<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">V_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>则完成了当前块的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>i</mi></msub><mo>=</mo><mi>s</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><msub><mi>Q</mi><mi>i</mi></msub><msubsup><mi>K</mi><mi>j</mi><mi>T</mi></msubsup><msub><mi>V</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O_i = softmax(Q_i K_j^T V_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.3948em;"></span><span class="mord mathnormal">so</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>除最后一步softmax要除以<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span>的所有步骤。</p><p><strong>最后把新的 PV 除以新的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> 存到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi></mrow><annotation encoding="application/x-tex">O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span></span></span></span> 里(完整softmax的最后一步)，只不过这里的除法也是用矩阵乘法来表示，也就是最前面的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>d</mi><mi>i</mi><mi>a</mi><mi>g</mi><mo stretchy="false">(</mo><msubsup><mi>l</mi><mi>i</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msubsup><mo stretchy="false">)</mo><msup><mo stretchy="false">)</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">(diag(l_i^{new}))^{-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0728em;vertical-align:-0.2587em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">ia</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4413em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span>。因为对角矩阵的逆就是它对角线元素的逆，也就是变成了除法。</strong></p><hr><ol start="13"><li>把最新的累计量<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>l</mi><mi>r</mi></msub><mo separator="true">,</mo><msub><mi>m</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">l_r,m_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>写回HBM，注意它们的大小都是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">B_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。<br><img src="'+B+'" alt="" loading="lazy"></li></ol><hr><p>14.-16. 结束循环，返回最终矩阵O。</p><h3 id="_1-4-fav1算法的数学证明" tabindex="-1"><a class="header-anchor" href="#_1-4-fav1算法的数学证明"><span>1.4 FAV1算法的数学证明</span></a></h3><h4 id="_1-4-1-online-softmax" tabindex="-1"><a class="header-anchor" href="#_1-4-1-online-softmax"><span>1.4.1 Online Softmax</span></a></h4><p>这个证明略，详细内容见笔记<a href="https://summer536.github.io/Notes/zh/posts/softmax.html" target="_blank" rel="noopener noreferrer">Naive -&gt; Safe -&gt; Online Softmax</a></p><h4 id="_1-4-2-如何证明最终计算的o是正确的" tabindex="-1"><a class="header-anchor" href="#_1-4-2-如何证明最终计算的o是正确的"><span>1.4.2 如何证明最终计算的O是正确的？</span></a></h4><p>我们用<strong>数学归纳法</strong>来证明算法的正确性，这里我们用外循环下标 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>⩽</mo><mi>j</mi><mo>⩽</mo><msub><mi>T</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">0 \\leqslant j \\leqslant T_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7811em;vertical-align:-0.1367em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel amsrm">⩽</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel amsrm">⩽</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 来进行归纳。</p><p>首先我们记 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>∈</mo><msup><mi>R</mi><mrow><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">K_{:,j} \\in R^{jB_c \\times d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0502em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span> 为 K 的前 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">jB_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 行，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>∈</mo><msup><mi>R</mi><mrow><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">V_{:,j} \\in R^{jB_c \\times d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0502em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span> 为 V 的前 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">jB_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 行。</p><p>令 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>=</mo><mi>Q</mi><msubsup><mi>K</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow><mi>T</mi></msubsup><mo>∈</mo><msup><mi>R</mi><mrow><mi>N</mi><mo>×</mo><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">S_{:,j} = QK^{T}_{:,j} \\in R^{N \\times jB_c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.3948em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0502em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>=</mo><mtext>softmax</mtext><mo stretchy="false">(</mo><msub><mi>S</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo stretchy="false">)</mo><mo>∈</mo><msup><mi>R</mi><mrow><mi>N</mi><mo>×</mo><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">P_{:,j} = \\text{softmax}(S_{:,j}) \\in R^{N \\times jB_c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0502em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>。</p><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">K_{:,j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> 是 K 的前 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">jB_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 行，所以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>K</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow><mi>T</mi></msubsup><mo>∈</mo><msup><mi>R</mi><mrow><mi>d</mi><mo>×</mo><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">K_{:,j}^T \\in R^{d \\times jB_c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.3948em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0502em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 是 K 的前 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">jB_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 列，所以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">S_{:,j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> 是矩阵 Q 乘以 K 的前 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">jB_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 列（行是 N）。而 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{:,j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> 是前 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">jB_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 列的 softmax，这正是我们之前算法外层循环。</p><figure><img src="'+N+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>令 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>m</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><msup><mi>l</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><msup><mi>O</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">m^{(j)}, l^{(j)}, O^{(j)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0824em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span> 是算法在第 j 次外循环结束后 HBM 保存的累积量和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>softmax</mtext><mo stretchy="false">(</mo><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup><mi>V</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\\text{softmax}(QK^TV)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span></span></span></span>（部分正确）的结果。<strong>注意：对于固定的 i，这些量在每次外循环 j 结束后都会被更新到 HBM 中，下一次外循环时又加载回来。</strong> 我们想证明：第 j 次外循环结束后，HBM 中的值为：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>m</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mtext>rowmax</mtext><mo stretchy="false">(</mo><msub><mi>S</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo stretchy="false">)</mo><mo>∈</mo><msup><mi>R</mi><mi>N</mi></msup></mrow><annotation encoding="application/x-tex">m^{(j)} = \\text{rowmax}(S_{:,j}) \\in R^N </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.938em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">rowmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8913em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span></span></span></span></span></p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>l</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mtext>rowsum</mtext><mo stretchy="false">(</mo><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>S</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>−</mo><msup><mi>m</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>∈</mo><msup><mi>R</mi><mi>N</mi></msup></mrow><annotation encoding="application/x-tex">l^{(j)} = \\text{rowsum}(\\exp(S_{:,j} - m^{(j)})) \\in R^N </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.938em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">rowsum</span></span><span class="mopen">(</span><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">))</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8913em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span></span></span></span></span></p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>O</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><msub><mi>P</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub><msub><mi>V</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>∈</mo><msup><mi>R</mi><mrow><mi>N</mi><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">O^{(j)} = P_{:,j}V_{:,j} \\in R^{N \\times d} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.938em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8991em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span></span></p><p>根据算法的初始化（第 1 和 2 行），<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">j=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> 是显然是正确的，因为累积量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> 初始化为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">-\\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mord">∞</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> 初始化为 0，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi></mrow><annotation encoding="application/x-tex">O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span></span></span></span> 也是初始化为 0。</p><hr><p>假设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> 时结论是正确的，那么我们希望证明 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">j+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 是上面三个式子也是正确的。</p><p>首先我们看累积量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span>，它的更新算法是：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><mo stretchy="false">(</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><msup><mi>m</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><mover accent="true"><mi>m</mi><mo>~</mo></mover><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\\tilde{m}^{(j+1)} = \\max(m^{(j)}, \\tilde{m})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">~</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">~</span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>m</mi><mo>~</mo></mover><mo>∈</mo><msup><mi>R</mi><mi>N</mi></msup></mrow><annotation encoding="application/x-tex">\\tilde{m} \\in R^N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.707em;vertical-align:-0.0391em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">~</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span></span></span></span> 是块 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> 的最大值（按行），因此它等于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>S</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi><mo>:</mo><mi>j</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\\max(S_{:,j:j+1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。根据归纳，而 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>m</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>S</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">m^{(j)} = \\max(S_{:,j})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，所以：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>m</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><msup><mi>m</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><mover accent="true"><mi>m</mi><mo>~</mo></mover><mo stretchy="false">)</mo><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>S</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi><mo>:</mo><mi>j</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>S</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>=</mo><mtext>rowmax</mtext><mo stretchy="false">(</mo><msub><mi>S</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">m^{(j+1)} = \\max(m^{(j)}, \\tilde{m}) = \\max(\\max(S_{:,j:j+1}), \\max(S_{:,j})) = \\text{rowmax}(S_{:,j+1}) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.938em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">~</span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mop">max</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">))</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">rowmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><p>这就<strong>证明了对于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">j+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>，第一个等式是成立的</strong>。类似的，我们的更新 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> 的算法是：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>l</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mrow><mo fence="true">(</mo><msup><mi>e</mi><mrow><msup><mi>m</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><msup><mi>m</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup></mrow></msup><msup><mi>l</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><msup><mi>e</mi><mrow><mover accent="true"><mi>m</mi><mo>~</mo></mover><mo>−</mo><msup><mi>m</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup></mrow></msup><mover accent="true"><mi>l</mi><mo>~</mo></mover><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">l^{(j+1)} = \\left(e^{m^{(j)} - m^{(j+1)}} l^{(j)} + e^{\\tilde{m} - m^{(j+1)}} \\tilde{l}\\right) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.938em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0897em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9667em;"><span style="top:-2.9667em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9667em;"><span style="top:-2.9667em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0897em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord accent mtight"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-2.7em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mathnormal mtight">m</span></span><span style="top:-3.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord mtight">~</span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9667em;"><span style="top:-2.9667em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9313em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span><span style="top:-3.6134em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">~</span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span></span></p><p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>l</mi><mo>~</mo></mover><mo>=</mo><mtext>rowsum</mtext><mo stretchy="false">(</mo><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>S</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi><mo>:</mo><mi>j</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><mover accent="true"><mi>m</mi><mo>~</mo></mover><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>∈</mo><msup><mi>R</mi><mi>N</mi></msup></mrow><annotation encoding="application/x-tex">\\tilde{l} = \\text{rowsum}(\\exp(S_{:,j:j+1} - \\tilde{m})) \\in R^N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9313em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9313em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span><span style="top:-3.6134em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">~</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">rowsum</span></span><span class="mopen">(</span><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">~</span></span></span></span></span></span></span><span class="mclose">))</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span></span></span></span>。因此：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>l</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><msup><mi>e</mi><mrow><msup><mi>m</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><msup><mi>m</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup></mrow></msup><msup><mi>l</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><msup><mi>e</mi><mrow><mover accent="true"><mi>m</mi><mo>~</mo></mover><mo>−</mo><msup><mi>m</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup></mrow></msup><mtext>rowsum</mtext><mo stretchy="false">(</mo><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>S</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi><mo>:</mo><mi>j</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><mover accent="true"><mi>m</mi><mo>~</mo></mover><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">l^{(j+1)} = e^{m^{(j)} - m^{(j+1)}} l^{(j)} + e^{\\tilde{m} - m^{(j+1)}} \\text{rowsum}(\\exp(S_{:,j:j+1} - \\tilde{m})) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.938em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.173em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0897em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9667em;"><span style="top:-2.9667em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9667em;"><span style="top:-2.9667em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.3758em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0897em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord accent mtight"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-2.7em;"><span class="pstrut" style="height:2.7em;"></span><span class="mord mathnormal mtight">m</span></span><span style="top:-3.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord mtight">~</span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9667em;"><span style="top:-2.9667em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mord text"><span class="mord">rowsum</span></span><span class="mopen">(</span><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3.35em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">~</span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></span></p><p>而根据归纳：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>l</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mtext>rowsum</mtext><mo stretchy="false">(</mo><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>S</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>−</mo><msup><mi>m</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">l^{(j)} = \\text{rowsum}(\\exp(S_{:,j} - m^{(j)})) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.938em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">rowsum</span></span><span class="mopen">(</span><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></span></p><p>代入上式得到：</p>',72)),a[7]||(a[7]=(0,t.Lk)("p",{class:"katex-block"},[(0,t.Lk)("span",{class:"katex-display"},[(0,t.Lk)("span",{class:"katex"},[(0,t.Lk)("span",{class:"katex-mathml"},[(0,t.Lk)("math",{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},[(0,t.Lk)("semantics",null,[(0,t.Lk)("mtable",{rowspacing:"0.25em",columnalign:"right left",columnspacing:"0em"},[(0,t.Lk)("mtr",null,[(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"l"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow",null,[(0,t.Lk)("mrow"),(0,t.Lk)("mo",null,"="),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"e"),(0,t.Lk)("mrow",null,[(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mtext",null,"rowsum"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"exp"),(0,t.Lk)("mo",null,"⁡"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",null,"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"e"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mover",{accent:"true"},[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mo",null,"~")]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mtext",null,"rowsum"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"exp"),(0,t.Lk)("mo",null,"⁡"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",null,"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,":"),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("mover",{accent:"true"},[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mo",null,"~")]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mtr",null,[(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow")])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow",null,[(0,t.Lk)("mrow"),(0,t.Lk)("mo",null,"="),(0,t.Lk)("mtext",null,"rowsum"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"exp"),(0,t.Lk)("mo",null,"⁡"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",null,"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mtext",null,"rowsum"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"exp"),(0,t.Lk)("mo",null,"⁡"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",null,"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,":"),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mtr",null,[(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow")])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow",null,[(0,t.Lk)("mrow"),(0,t.Lk)("mo",null,"="),(0,t.Lk)("mtext",null,"rowsum"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"exp"),(0,t.Lk)("mo",null,"⁡"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",null,"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])])]),(0,t.Lk)("annotation",{encoding:"application/x-tex"},"\\begin{aligned} l^{(j+1)} &= e^{m^{(j)} - m^{(j+1)}} \\text{rowsum}(\\exp(S_{:,j} - m^{(j)})) + e^{\\tilde{m} - m^{(j+1)}} \\text{rowsum}(\\exp(S_{:,j:j+1} - \\tilde{m})) \\\\ &= \\text{rowsum}(\\exp(S_{:,j} - m^{(j+1)})) + \\text{rowsum}(\\exp(S_{:,j:j+1} - m^{(j+1)})) \\\\ &= \\text{rowsum}(\\exp(S_{:,j+1} - m^{(j+1)})) \\end{aligned} ")])])]),(0,t.Lk)("span",{class:"katex-html","aria-hidden":"true"},[(0,t.Lk)("span",{class:"base"},[(0,t.Lk)("span",{class:"strut",style:{height:"4.9457em","vertical-align":"-2.2229em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mtable"},[(0,t.Lk)("span",{class:"col-align-r"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"2.7229em"}},[(0,t.Lk)("span",{style:{top:"-4.7229em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.0897em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.01968em"}},"l"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])])])]),(0,t.Lk)("span",{style:{top:"-3.1248em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.0897em"}}),(0,t.Lk)("span",{class:"mord"})]),(0,t.Lk)("span",{style:{top:"-1.5269em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.0897em"}}),(0,t.Lk)("span",{class:"mord"})])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"2.2229em"}},[(0,t.Lk)("span")])])])]),(0,t.Lk)("span",{class:"col-align-l"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"2.7229em"}},[(0,t.Lk)("span",{style:{top:"-4.7229em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.0897em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"}),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"="),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"e"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"1.0897em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.9667em"}},[(0,t.Lk)("span",{style:{top:"-2.9667em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5357em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mbin mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.9667em"}},[(0,t.Lk)("span",{style:{top:"-2.9667em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5357em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])])])])])])])])])]),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"rowsum")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mop"},"exp"),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.05764em"}},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.0576em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mbin"},"−"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},"))"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mbin"},"+"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"e"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"1.0897em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord accent mtight"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.6679em"}},[(0,t.Lk)("span",{style:{top:"-2.7em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m")]),(0,t.Lk)("span",{style:{top:"-3.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"accent-body",style:{left:"-0.25em"}},[(0,t.Lk)("span",{class:"mord mtight"},"~")])])])])])]),(0,t.Lk)("span",{class:"mbin mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.9667em"}},[(0,t.Lk)("span",{style:{top:"-2.9667em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5357em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])])])])])])])])])]),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"rowsum")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mop"},"exp"),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.05764em"}},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.0576em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mbin"},"−"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mord accent"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.6679em"}},[(0,t.Lk)("span",{style:{top:"-3em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3em"}}),(0,t.Lk)("span",{class:"mord mathnormal"},"m")]),(0,t.Lk)("span",{style:{top:"-3.35em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3em"}}),(0,t.Lk)("span",{class:"accent-body",style:{left:"-0.25em"}},[(0,t.Lk)("span",{class:"mord"},"~")])])])])])]),(0,t.Lk)("span",{class:"mclose"},"))")])]),(0,t.Lk)("span",{style:{top:"-3.1248em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.0897em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"}),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"="),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"rowsum")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mop"},"exp"),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.05764em"}},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.0576em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mbin"},"−"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},"))"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mbin"},"+"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"rowsum")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mop"},"exp"),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.05764em"}},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.0576em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mbin"},"−"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},"))")])]),(0,t.Lk)("span",{style:{top:"-1.5269em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.0897em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"}),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"="),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"rowsum")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mop"},"exp"),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.05764em"}},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.0576em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mbin"},"−"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},"))")])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"2.2229em"}},[(0,t.Lk)("span")])])])])])])])])])])],-1)),a[8]||(a[8]=(0,t.Fv)('<p>所以<strong>在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">j+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 时第二个式子成立</strong>。</p><p>为了证明第三个式子，我们令 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi><mo>:</mo><mi>j</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">V_{:,j:j+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> 为 V 的第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">jB_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 列到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><msub><mi>B</mi><mi>c</mi></msub><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">(j+1)B_c-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 列。证明过程如下：</p>',2)),a[9]||(a[9]=(0,t.Lk)("p",{class:"katex-block"},[(0,t.Lk)("span",{class:"katex-display"},[(0,t.Lk)("span",{class:"katex"},[(0,t.Lk)("span",{class:"katex-mathml"},[(0,t.Lk)("math",{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},[(0,t.Lk)("semantics",null,[(0,t.Lk)("mtable",{rowspacing:"0.25em",columnalign:"right left",columnspacing:"0em"},[(0,t.Lk)("mtr",null,[(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("msup",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"O"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow",null,[(0,t.Lk)("mrow"),(0,t.Lk)("mo",null,"="),(0,t.Lk)("mtext",null,"diag"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",{mathvariant:"normal"},"ℓ"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("msup",null,[(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,"−"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mtext",null,"diag"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",{mathvariant:"normal"},"ℓ"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"e"),(0,t.Lk)("mrow",null,[(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"O"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"e"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mover",{accent:"true"},[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mo",null,"~")]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mi",null,"exp"),(0,t.Lk)("mo",null,"⁡"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,":"),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("mover",{accent:"true"},[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mo",null,"~")]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"V"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,":"),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mtr",null,[(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow")])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow",null,[(0,t.Lk)("mrow"),(0,t.Lk)("mo",null,"="),(0,t.Lk)("mtext",null,"diag"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",{mathvariant:"normal"},"ℓ"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("msup",null,[(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,"−"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mtext",null,"diag"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",{mathvariant:"normal"},"ℓ"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"e"),(0,t.Lk)("mrow",null,[(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"P"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])]),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"V"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])]),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"e"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mi",null,"exp"),(0,t.Lk)("mo",null,"⁡"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,":"),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"V"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,":"),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mtr",null,[(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow")])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow",null,[(0,t.Lk)("mrow"),(0,t.Lk)("mo",null,"="),(0,t.Lk)("mtext",null,"diag"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",{mathvariant:"normal"},"ℓ"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("msup",null,[(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,"−"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mtext",null,"diag"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",{mathvariant:"normal"},"ℓ"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"e"),(0,t.Lk)("mrow",null,[(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mrow",null,[(0,t.Lk)("mtext",null,"diag"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",{mathvariant:"normal"},"ℓ"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",{stretchy:"false"},")")]),(0,t.Lk)("msup",null,[(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,"−"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mi",null,"exp"),(0,t.Lk)("mo",null,"⁡"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"V"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])]),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"e"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mi",null,"exp"),(0,t.Lk)("mo",null,"⁡"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,":"),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"V"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,":"),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mtr",null,[(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow")])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow",null,[(0,t.Lk)("mrow"),(0,t.Lk)("mo",null,"="),(0,t.Lk)("mtext",null,"diag"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",{mathvariant:"normal"},"ℓ"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("msup",null,[(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,"−"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"e"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mi",null,"exp"),(0,t.Lk)("mo",null,"⁡"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"V"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])]),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"e"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mi",null,"exp"),(0,t.Lk)("mo",null,"⁡"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,":"),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"V"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,":"),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mtr",null,[(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow")])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow",null,[(0,t.Lk)("mrow"),(0,t.Lk)("mo",null,"="),(0,t.Lk)("mtext",null,"diag"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",{mathvariant:"normal"},"ℓ"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("msup",null,[(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,"−"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"exp"),(0,t.Lk)("mo",null,"⁡"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"V"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])]),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mi",null,"exp"),(0,t.Lk)("mo",null,"⁡"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,":"),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"V"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,":"),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mtr",null,[(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow")])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow",null,[(0,t.Lk)("mrow"),(0,t.Lk)("mo",null,"="),(0,t.Lk)("mtext",null,"diag"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",{mathvariant:"normal"},"ℓ"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("msup",null,[(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,"−"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{fence:"true"},"("),(0,t.Lk)("mi",null,"exp"),(0,t.Lk)("mo",null,"⁡"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{fence:"true"},"("),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{fence:"true"},"["),(0,t.Lk)("mtable",{rowspacing:"0.16em",columnalign:"center center",columnspacing:"1em"},[(0,t.Lk)("mtr",null,[(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"false"},[(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])])])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"false"},[(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,":"),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1")])])])])])]),(0,t.Lk)("mo",{fence:"true"},"]")]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",{fence:"true"},")")]),(0,t.Lk)("mo",{fence:"true"},")")]),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{fence:"true"},"["),(0,t.Lk)("mtable",{rowspacing:"0.16em",columnalign:"center",columnspacing:"1em"},[(0,t.Lk)("mtr",null,[(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"false"},[(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"V"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])])])])]),(0,t.Lk)("mtr",null,[(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"false"},[(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"V"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,":"),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1")])])])])])]),(0,t.Lk)("mo",{fence:"true"},"]")])])])])]),(0,t.Lk)("mtr",null,[(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow")])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"true"},[(0,t.Lk)("mrow",null,[(0,t.Lk)("mrow"),(0,t.Lk)("mo",null,"="),(0,t.Lk)("mtext",null,"softmax"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"V"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",null,"+"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("mi",{mathvariant:"normal"},".")])])])])]),(0,t.Lk)("annotation",{encoding:"application/x-tex"},"\\begin{aligned} \\mathbf{O}^{(j+1)} &= \\text{diag}(\\ell^{(j+1)})^{-1} (\\text{diag}(\\ell^{(j)}) e^{m^{(j)} - m^{(j+1)}} \\mathbf{O}^{(j)} + e^{\\tilde{m} - m^{(j+1)}} \\exp(\\mathbf{S}_{:,j:j+1} - \\tilde{m}) \\mathbf{V}_{:,j:j+1}) \\\\ &= \\text{diag}(\\ell^{(j+1)})^{-1} (\\text{diag}(\\ell^{(j)}) e^{m^{(j)} - m^{(j+1)}} \\mathbf{P}_{:,j} \\mathbf{V}_{:,j} + e^{-m^{(j+1)}} \\exp(\\mathbf{S}_{:,j:j+1}) \\mathbf{V}_{:,j:j+1}) \\\\ &= \\text{diag}(\\ell^{(j+1)})^{-1} (\\text{diag}(\\ell^{(j)}) e^{m^{(j)} - m^{(j+1)}} ({\\text{diag}(\\ell^{(j)})})^{-1} \\exp(\\mathbf{S}_{:,j} - m^{(j)}) \\mathbf{V}_{:,j} + e^{-m^{(j+1)}} \\exp(\\mathbf{S}_{:,j:j+1}) \\mathbf{V}_{:,j:j+1}) \\\\ &= \\text{diag}(\\ell^{(j+1)})^{-1} (e^{-m^{(j+1)}} \\exp(\\mathbf{S}_{:,j}) \\mathbf{V}_{:,j} + e^{-m^{(j+1)}} \\exp(\\mathbf{S}_{:,j:j+1}) \\mathbf{V}_{:,j:j+1}) \\\\ &= \\text{diag}(\\ell^{(j+1)})^{-1} (\\exp(\\mathbf{S}_{:,j} - m^{(j+1)}) \\mathbf{V}_{:,j} + \\exp(\\mathbf{S}_{:,j:j+1} - m^{(j+1)}) \\mathbf{V}_{:,j:j+1}) \\\\ &= \\text{diag}(\\ell^{(j+1)})^{-1} \\left( \\exp \\left( \\begin{bmatrix} \\mathbf{S}_{:,j} & \\mathbf{S}_{:,j:j+1} \\end{bmatrix} - m^{(j+1)} \\right) \\right) \\begin{bmatrix} \\mathbf{V}_{:,j} \\\\ \\mathbf{V}_{:,j:j+1} \\end{bmatrix} \\\\ &= \\text{softmax}(\\mathbf{S}_{:,j+1}) \\mathbf{V}_{:,j+1}. \\end{aligned} ")])])]),(0,t.Lk)("span",{class:"katex-html","aria-hidden":"true"},[(0,t.Lk)("span",{class:"base"},[(0,t.Lk)("span",{class:"strut",style:{height:"12.7968em","vertical-align":"-6.1484em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mtable"},[(0,t.Lk)("span",{class:"col-align-r"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"6.6484em"}},[(0,t.Lk)("span",{style:{top:"-9.0087em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.45em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf"},"O"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])])])]),(0,t.Lk)("span",{style:{top:"-7.259em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.45em"}}),(0,t.Lk)("span",{class:"mord"})]),(0,t.Lk)("span",{style:{top:"-5.5093em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.45em"}}),(0,t.Lk)("span",{class:"mord"})]),(0,t.Lk)("span",{style:{top:"-3.7596em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.45em"}}),(0,t.Lk)("span",{class:"mord"})]),(0,t.Lk)("span",{style:{top:"-2.1616em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.45em"}}),(0,t.Lk)("span",{class:"mord"})]),(0,t.Lk)("span",{style:{top:"-0.0516em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.45em"}}),(0,t.Lk)("span",{class:"mord"})]),(0,t.Lk)("span",{style:{top:"2.0384em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.45em"}}),(0,t.Lk)("span",{class:"mord"})])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"6.1484em"}},[(0,t.Lk)("span")])])])]),(0,t.Lk)("span",{class:"col-align-l"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"6.6484em"}},[(0,t.Lk)("span",{style:{top:"-9.0087em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.45em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"}),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"="),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"diag")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},"ℓ"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},[(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.8641em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])])])])])]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"diag")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},"ℓ"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"e"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"1.0897em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.9667em"}},[(0,t.Lk)("span",{style:{top:"-2.9667em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5357em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mbin mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.9667em"}},[(0,t.Lk)("span",{style:{top:"-2.9667em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5357em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])])])])])])])])])]),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf"},"O"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mbin"},"+"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"e"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"1.0897em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord accent mtight"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.6679em"}},[(0,t.Lk)("span",{style:{top:"-2.7em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m")]),(0,t.Lk)("span",{style:{top:"-3.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"accent-body",style:{left:"-0.25em"}},[(0,t.Lk)("span",{class:"mord mtight"},"~")])])])])])]),(0,t.Lk)("span",{class:"mbin mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.9667em"}},[(0,t.Lk)("span",{style:{top:"-2.9667em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5357em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])])])])])])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),(0,t.Lk)("span",{class:"mop"},"exp"),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf"},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mbin"},"−"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mord accent"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.6679em"}},[(0,t.Lk)("span",{style:{top:"-3em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3em"}}),(0,t.Lk)("span",{class:"mord mathnormal"},"m")]),(0,t.Lk)("span",{style:{top:"-3.35em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3em"}}),(0,t.Lk)("span",{class:"accent-body",style:{left:"-0.25em"}},[(0,t.Lk)("span",{class:"mord"},"~")])])])])])]),(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mclose"},")")])]),(0,t.Lk)("span",{style:{top:"-7.259em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.45em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"}),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"="),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"diag")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},"ℓ"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},[(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.8641em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])])])])])]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"diag")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},"ℓ"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"e"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"1.0897em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.9667em"}},[(0,t.Lk)("span",{style:{top:"-2.9667em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5357em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mbin mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.9667em"}},[(0,t.Lk)("span",{style:{top:"-2.9667em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5357em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])])])])])])])])])]),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf"},"P"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mbin"},"+"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"e"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"1.0897em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.9667em"}},[(0,t.Lk)("span",{style:{top:"-2.9667em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5357em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])])])])])])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),(0,t.Lk)("span",{class:"mop"},"exp"),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf"},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mclose"},")")])]),(0,t.Lk)("span",{style:{top:"-5.5093em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.45em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"}),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"="),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"diag")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},"ℓ"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},[(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.8641em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])])])])])]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"diag")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},"ℓ"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"e"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"1.0897em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.9667em"}},[(0,t.Lk)("span",{style:{top:"-2.9667em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5357em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mbin mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.9667em"}},[(0,t.Lk)("span",{style:{top:"-2.9667em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5357em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])])])])])])])])])]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"diag")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},"ℓ"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},")")]),(0,t.Lk)("span",{class:"mclose"},[(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.8641em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),(0,t.Lk)("span",{class:"mop"},"exp"),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf"},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mbin"},"−"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mbin"},"+"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"e"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"1.0897em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.9667em"}},[(0,t.Lk)("span",{style:{top:"-2.9667em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5357em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])])])])])])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),(0,t.Lk)("span",{class:"mop"},"exp"),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf"},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mclose"},")")])]),(0,t.Lk)("span",{style:{top:"-3.7596em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.45em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"}),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"="),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"diag")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},"ℓ"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},[(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.8641em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])])])])])]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"e"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"1.0897em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.9667em"}},[(0,t.Lk)("span",{style:{top:"-2.9667em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5357em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])])])])])])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),(0,t.Lk)("span",{class:"mop"},"exp"),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf"},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mbin"},"+"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"e"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"1.0897em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.9667em"}},[(0,t.Lk)("span",{style:{top:"-2.9667em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5357em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])])])])])])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),(0,t.Lk)("span",{class:"mop"},"exp"),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf"},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mclose"},")")])]),(0,t.Lk)("span",{style:{top:"-2.1616em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.45em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"}),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"="),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"diag")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},"ℓ"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},[(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.8641em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])])])])])]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mop"},"exp"),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf"},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mbin"},"−"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mbin"},"+"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mop"},"exp"),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf"},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mbin"},"−"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mclose"},")")])]),(0,t.Lk)("span",{style:{top:"-0.0516em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.45em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"}),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"="),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"diag")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},"ℓ"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},[(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.8641em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),(0,t.Lk)("span",{class:"minner"},[(0,t.Lk)("span",{class:"mopen delimcenter",style:{top:"0em"}},[(0,t.Lk)("span",{class:"delimsizing size2"},"(")]),(0,t.Lk)("span",{class:"mop"},"exp"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),(0,t.Lk)("span",{class:"minner"},[(0,t.Lk)("span",{class:"mopen delimcenter",style:{top:"0em"}},[(0,t.Lk)("span",{class:"delimsizing size2"},"(")]),(0,t.Lk)("span",{class:"minner"},[(0,t.Lk)("span",{class:"mopen delimcenter",style:{top:"0em"}},[(0,t.Lk)("span",{class:"delimsizing size1"},"[")]),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mtable"},[(0,t.Lk)("span",{class:"col-align-c"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.85em"}},[(0,t.Lk)("span",{style:{top:"-3.01em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf"},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.35em"}},[(0,t.Lk)("span")])])])]),(0,t.Lk)("span",{class:"arraycolsep",style:{width:"0.5em"}}),(0,t.Lk)("span",{class:"arraycolsep",style:{width:"0.5em"}}),(0,t.Lk)("span",{class:"col-align-c"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.85em"}},[(0,t.Lk)("span",{style:{top:"-3.01em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf"},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.35em"}},[(0,t.Lk)("span")])])])])])]),(0,t.Lk)("span",{class:"mclose delimcenter",style:{top:"0em"}},[(0,t.Lk)("span",{class:"delimsizing size1"},"]")])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mbin"},"−"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2222em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose delimcenter",style:{top:"0em"}},[(0,t.Lk)("span",{class:"delimsizing size2"},")")])]),(0,t.Lk)("span",{class:"mclose delimcenter",style:{top:"0em"}},[(0,t.Lk)("span",{class:"delimsizing size2"},")")])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),(0,t.Lk)("span",{class:"minner"},[(0,t.Lk)("span",{class:"mopen delimcenter",style:{top:"0em"}},[(0,t.Lk)("span",{class:"delimsizing size3"},"[")]),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mtable"},[(0,t.Lk)("span",{class:"col-align-c"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"1.45em"}},[(0,t.Lk)("span",{style:{top:"-3.61em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])])])]),(0,t.Lk)("span",{style:{top:"-2.41em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.95em"}},[(0,t.Lk)("span")])])])])])]),(0,t.Lk)("span",{class:"mclose delimcenter",style:{top:"0em"}},[(0,t.Lk)("span",{class:"delimsizing size3"},"]")])])])]),(0,t.Lk)("span",{style:{top:"2.0384em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.45em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"}),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"="),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"softmax")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf"},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf",style:{"margin-right":"0.01597em"}},"V"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.016em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mbin mtight"},"+"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mord"},".")])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"6.1484em"}},[(0,t.Lk)("span")])])])])])])])])])])],-1)),a[10]||(a[10]=(0,t.Lk)("p",null,"下面我们一步一步地来看这个证明过程。",-1)),a[11]||(a[11]=(0,t.Lk)("ol",null,[(0,t.Lk)("li",null,[(0,t.Lk)("p",null,[(0,t.Lk)("strong",null,"第一行"),(0,t.eW)(" 这就是算法的更新公式。在前面的 step 12 详细介绍了。")])]),(0,t.Lk)("li",null,[(0,t.Lk)("p",null,[(0,t.Lk)("strong",null,"第二行"),(0,t.eW)(" 第一个是用归纳假设 "),(0,t.Lk)("span",{class:"katex"},[(0,t.Lk)("span",{class:"katex-mathml"},[(0,t.Lk)("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[(0,t.Lk)("semantics",null,[(0,t.Lk)("mrow",null,[(0,t.Lk)("msup",null,[(0,t.Lk)("mi",{mathvariant:"bold"},"O"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",null,"="),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",null,"P"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])]),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",null,"V"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])])]),(0,t.Lk)("annotation",{encoding:"application/x-tex"},"\\mathbf{O}^{(j)} = P_{:,j} V_{:,j}")])])]),(0,t.Lk)("span",{class:"katex-html","aria-hidden":"true"},[(0,t.Lk)("span",{class:"base"},[(0,t.Lk)("span",{class:"strut",style:{height:"0.888em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathbf"},"O"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.888em"}},[(0,t.Lk)("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"="),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),(0,t.Lk)("span",{class:"base"},[(0,t.Lk)("span",{class:"strut",style:{height:"0.9694em","vertical-align":"-0.2861em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.13889em"}},"P"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.1389em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.22222em"}},"V"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.2222em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])])])])]),(0,t.eW)("，第二个就是指数合并，"),(0,t.Lk)("span",{class:"katex"},[(0,t.Lk)("span",{class:"katex-mathml"},[(0,t.Lk)("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[(0,t.Lk)("semantics",null,[(0,t.Lk)("mrow",null,[(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"e"),(0,t.Lk)("mover",{accent:"true"},[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mo",null,"~")])])]),(0,t.Lk)("annotation",{encoding:"application/x-tex"},"e^{\\tilde{m}}")])])]),(0,t.Lk)("span",{class:"katex-html","aria-hidden":"true"},[(0,t.Lk)("span",{class:"base"},[(0,t.Lk)("span",{class:"strut",style:{height:"0.8305em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"e"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.8305em"}},[(0,t.Lk)("span",{style:{top:"-3.063em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord accent mtight"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.6679em"}},[(0,t.Lk)("span",{style:{top:"-2.7em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m")]),(0,t.Lk)("span",{style:{top:"-3.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"accent-body",style:{left:"-0.25em"}},[(0,t.Lk)("span",{class:"mord mtight"},"~")])])])])])])])])])])])])])])])])]),(0,t.eW)(" 抵消掉。")])]),(0,t.Lk)("li",null,[(0,t.Lk)("p",null,[(0,t.Lk)("strong",null,"第三行"),(0,t.eW)(" 利用前面的定义："),(0,t.Lk)("span",{class:"katex"},[(0,t.Lk)("span",{class:"katex-mathml"},[(0,t.Lk)("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[(0,t.Lk)("semantics",null,[(0,t.Lk)("mrow",null,[(0,t.Lk)("msub",null,[(0,t.Lk)("mi",null,"P"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])]),(0,t.Lk)("mo",null,"="),(0,t.Lk)("mtext",null,"softmax"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msub",null,[(0,t.Lk)("mi",null,"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])]),(0,t.Lk)("mo",{stretchy:"false"},")")]),(0,t.Lk)("annotation",{encoding:"application/x-tex"},"P_{:,j} = \\text{softmax}(S_{:,j})")])])]),(0,t.Lk)("span",{class:"katex-html","aria-hidden":"true"},[(0,t.Lk)("span",{class:"base"},[(0,t.Lk)("span",{class:"strut",style:{height:"0.9694em","vertical-align":"-0.2861em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.13889em"}},"P"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.1389em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"="),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),(0,t.Lk)("span",{class:"base"},[(0,t.Lk)("span",{class:"strut",style:{height:"1.0361em","vertical-align":"-0.2861em"}}),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"softmax")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.05764em"}},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.0576em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mclose"},")")])])]),(0,t.eW)("，也就是说 "),(0,t.Lk)("span",{class:"katex"},[(0,t.Lk)("span",{class:"katex-mathml"},[(0,t.Lk)("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[(0,t.Lk)("semantics",null,[(0,t.Lk)("mrow",null,[(0,t.Lk)("msub",null,[(0,t.Lk)("mi",null,"P"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])])]),(0,t.Lk)("annotation",{encoding:"application/x-tex"},"P_{:,j}")])])]),(0,t.Lk)("span",{class:"katex-html","aria-hidden":"true"},[(0,t.Lk)("span",{class:"base"},[(0,t.Lk)("span",{class:"strut",style:{height:"0.9694em","vertical-align":"-0.2861em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.13889em"}},"P"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.1389em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])])])])]),(0,t.eW)(" 到块 j 时的 "),(0,t.Lk)("span",{class:"katex"},[(0,t.Lk)("span",{class:"katex-mathml"},[(0,t.Lk)("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[(0,t.Lk)("semantics",null,[(0,t.Lk)("mrow",null,[(0,t.Lk)("msub",null,[(0,t.Lk)("mi",null,"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])])]),(0,t.Lk)("annotation",{encoding:"application/x-tex"},"S_{:,j}")])])]),(0,t.Lk)("span",{class:"katex-html","aria-hidden":"true"},[(0,t.Lk)("span",{class:"base"},[(0,t.Lk)("span",{class:"strut",style:{height:"0.9694em","vertical-align":"-0.2861em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.05764em"}},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.0576em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])])])])]),(0,t.eW)(" 的 softmax。根据 softmax 和 l 及 m 的关系，我们有：")]),(0,t.Lk)("p",{class:"katex-block"},[(0,t.Lk)("span",{class:"katex-display"},[(0,t.Lk)("span",{class:"katex"},[(0,t.Lk)("span",{class:"katex-mathml"},[(0,t.Lk)("math",{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},[(0,t.Lk)("semantics",null,[(0,t.Lk)("mrow",null,[(0,t.Lk)("msub",null,[(0,t.Lk)("mi",null,"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])]),(0,t.Lk)("mo",null,"="),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"e"),(0,t.Lk)("mrow",null,[(0,t.Lk)("msub",null,[(0,t.Lk)("mi",null,"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mi",{mathvariant:"normal"},"/"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{fence:"true"},"("),(0,t.Lk)("mtable",{rowspacing:"0.16em",columnalign:"center center center",columnspacing:"1em"},[(0,t.Lk)("mtr",null,[(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"false"},[(0,t.Lk)("msubsup",null,[(0,t.Lk)("mi",null,"l"),(0,t.Lk)("mn",null,"1"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"false"},[(0,t.Lk)("mo",{lspace:"0em",rspace:"0em"},"…")])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"false"},[(0,t.Lk)("mn",null,"0")])])]),(0,t.Lk)("mtr",null,[(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"false"},[(0,t.Lk)("mrow",null,[(0,t.Lk)("mi",{mathvariant:"normal"},"⋮"),(0,t.Lk)("mpadded",{height:"0em",voffset:"0em"},[(0,t.Lk)("mspace",{mathbackground:"black",width:"0em",height:"1.5em"})])])])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"false"},[(0,t.Lk)("mo",{lspace:"0em",rspace:"0em"},"⋱")])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"false"},[(0,t.Lk)("mrow",null,[(0,t.Lk)("mi",{mathvariant:"normal"},"⋮"),(0,t.Lk)("mpadded",{height:"0em",voffset:"0em"},[(0,t.Lk)("mspace",{mathbackground:"black",width:"0em",height:"1.5em"})])])])])]),(0,t.Lk)("mtr",null,[(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"false"},[(0,t.Lk)("mn",null,"0")])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"false"},[(0,t.Lk)("mo",{lspace:"0em",rspace:"0em"},"…")])]),(0,t.Lk)("mtd",null,[(0,t.Lk)("mstyle",{scriptlevel:"0",displaystyle:"false"},[(0,t.Lk)("msubsup",null,[(0,t.Lk)("mi",null,"l"),(0,t.Lk)("mi",null,"N"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])])])]),(0,t.Lk)("mo",{fence:"true"},")")]),(0,t.Lk)("mo",null,"="),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mtext",null,"diag"),(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"l"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",{stretchy:"false"},")")])]),(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("msup",null,[(0,t.Lk)("mo",{stretchy:"false"},")"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,"−"),(0,t.Lk)("mn",null,"1")])]),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"e"),(0,t.Lk)("mrow",null,[(0,t.Lk)("msub",null,[(0,t.Lk)("mi",null,"S"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",null,":"),(0,t.Lk)("mo",{separator:"true"},","),(0,t.Lk)("mi",null,"j")])]),(0,t.Lk)("mo",null,"−"),(0,t.Lk)("msup",null,[(0,t.Lk)("mi",null,"m"),(0,t.Lk)("mrow",null,[(0,t.Lk)("mo",{stretchy:"false"},"("),(0,t.Lk)("mi",null,"j"),(0,t.Lk)("mo",{stretchy:"false"},")")])])])])]),(0,t.Lk)("annotation",{encoding:"application/x-tex"},"S_{:,j} = e^{S_{:,j} - m^{(j)}} / \\begin{pmatrix} l_1^{(j)} & \\dots & 0 \\\\ \\vdots & \\ddots & \\vdots \\\\ 0 & \\dots & l_N^{(j)} \\end{pmatrix} = (\\text{diag}(l^{(j)}))^{-1} e^{S_{:,j} - m^{(j)}} ")])])]),(0,t.Lk)("span",{class:"katex-html","aria-hidden":"true"},[(0,t.Lk)("span",{class:"base"},[(0,t.Lk)("span",{class:"strut",style:{height:"0.9694em","vertical-align":"-0.2861em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.05764em"}},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3117em"}},[(0,t.Lk)("span",{style:{top:"-2.55em","margin-left":"-0.0576em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2861em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"="),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),(0,t.Lk)("span",{class:"base"},[(0,t.Lk)("span",{class:"strut",style:{height:"4.8em","vertical-align":"-2.15em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"e"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"1.0897em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05764em"}},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3281em"}},[(0,t.Lk)("span",{style:{top:"-2.357em","margin-left":"-0.0576em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2819em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mbin mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.9667em"}},[(0,t.Lk)("span",{style:{top:"-2.9667em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5357em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])])])])])])])])])]),(0,t.Lk)("span",{class:"mord"},"/"),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),(0,t.Lk)("span",{class:"minner"},[(0,t.Lk)("span",{class:"mopen"},[(0,t.Lk)("span",{class:"delimsizing mult"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"2.65em"}},[(0,t.Lk)("span",{style:{top:"-4.65em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"6.8em"}}),(0,t.Lk)("span",{style:{width:"0.875em",height:"4.800em"}},[(0,t.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"0.875em",height:"4.800em",viewBox:"0 0 875 4800"},[(0,t.Lk)("path",{d:"M863,9c0,-2,-2,-5,-6,-9c0,0,-17,0,-17,0c-12.7,0,-19.3,0.3,-20,1\nc-5.3,5.3,-10.3,11,-15,17c-242.7,294.7,-395.3,682,-458,1162c-21.3,163.3,-33.3,349,\n-36,557 l0,1284c0.2,6,0,26,0,60c2,159.3,10,310.7,24,454c53.3,528,210,\n949.7,470,1265c4.7,6,9.7,11.7,15,17c0.7,0.7,7,1,19,1c0,0,18,0,18,0c4,-4,6,-7,6,-9\nc0,-2.7,-3.3,-8.7,-10,-18c-135.3,-192.7,-235.5,-414.3,-300.5,-665c-65,-250.7,-102.5,\n-544.7,-112.5,-882c-2,-104,-3,-167,-3,-189\nl0,-1292c0,-162.7,5.7,-314,17,-454c20.7,-272,63.7,-513,129,-723c65.3,\n-210,155.3,-396.3,270,-559c6.7,-9.3,10,-15.3,10,-18z"})])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"2.15em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mtable"},[(0,t.Lk)("span",{class:"col-align-c"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"2.5848em"}},[(0,t.Lk)("span",{style:{top:"-5.2275em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.6875em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.01968em"}},"l"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"1.0448em"}},[(0,t.Lk)("span",{style:{top:"-2.4337em","margin-left":"-0.0197em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},"1")])]),(0,t.Lk)("span",{style:{top:"-3.2198em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2663em"}},[(0,t.Lk)("span")])])])])])])]),(0,t.Lk)("span",{style:{top:"-3.3675em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.6875em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},"⋮"),(0,t.Lk)("span",{class:"mord rule",style:{"border-right-width":"0em","border-top-width":"1.5em",bottom:"0em"}})])])]),(0,t.Lk)("span",{style:{top:"-1.9627em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.6875em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},"0")])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"2.0848em"}},[(0,t.Lk)("span")])])])]),(0,t.Lk)("span",{class:"arraycolsep",style:{width:"0.5em"}}),(0,t.Lk)("span",{class:"arraycolsep",style:{width:"0.5em"}}),(0,t.Lk)("span",{class:"col-align-c"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"2.5848em"}},[(0,t.Lk)("span",{style:{top:"-5.04em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.5em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"minner"},"…")])]),(0,t.Lk)("span",{style:{top:"-3.18em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.5em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"minner"},"⋱")])]),(0,t.Lk)("span",{style:{top:"-1.7752em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.5em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"minner"},"…")])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"2.0848em"}},[(0,t.Lk)("span")])])])]),(0,t.Lk)("span",{class:"arraycolsep",style:{width:"0.5em"}}),(0,t.Lk)("span",{class:"arraycolsep",style:{width:"0.5em"}}),(0,t.Lk)("span",{class:"col-align-c"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"2.5848em"}},[(0,t.Lk)("span",{style:{top:"-5.2275em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.6875em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},"0")])]),(0,t.Lk)("span",{style:{top:"-3.3675em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.6875em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},"⋮"),(0,t.Lk)("span",{class:"mord rule",style:{"border-right-width":"0em","border-top-width":"1.5em",bottom:"0em"}})])])]),(0,t.Lk)("span",{style:{top:"-1.9627em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"3.6875em"}}),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.01968em"}},"l"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"1.0448em"}},[(0,t.Lk)("span",{style:{top:"-2.4065em","margin-left":"-0.0197em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.10903em"}},"N")])]),(0,t.Lk)("span",{style:{top:"-3.2198em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2935em"}},[(0,t.Lk)("span")])])])])])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"2.0848em"}},[(0,t.Lk)("span")])])])])])]),(0,t.Lk)("span",{class:"mclose"},[(0,t.Lk)("span",{class:"delimsizing mult"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"2.65em"}},[(0,t.Lk)("span",{style:{top:"-4.65em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"6.8em"}}),(0,t.Lk)("span",{style:{width:"0.875em",height:"4.800em"}},[(0,t.Lk)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"0.875em",height:"4.800em",viewBox:"0 0 875 4800"},[(0,t.Lk)("path",{d:"M76,0c-16.7,0,-25,3,-25,9c0,2,2,6.3,6,13c21.3,28.7,42.3,60.3,\n63,95c96.7,156.7,172.8,332.5,228.5,527.5c55.7,195,92.8,416.5,111.5,664.5\nc11.3,139.3,17,290.7,17,454c0,28,1.7,43,3.3,45l0,1209\nc-3,4,-3.3,16.7,-3.3,38c0,162,-5.7,313.7,-17,455c-18.7,248,-55.8,469.3,-111.5,664\nc-55.7,194.7,-131.8,370.3,-228.5,527c-20.7,34.7,-41.7,66.3,-63,95c-2,3.3,-4,7,-6,11\nc0,7.3,5.7,11,17,11c0,0,11,0,11,0c9.3,0,14.3,-0.3,15,-1c5.3,-5.3,10.3,-11,15,-17\nc242.7,-294.7,395.3,-681.7,458,-1161c21.3,-164.7,33.3,-350.7,36,-558\nl0,-1344c-2,-159.3,-10,-310.7,-24,-454c-53.3,-528,-210,-949.7,\n-470,-1265c-4.7,-6,-9.7,-11.7,-15,-17c-0.7,-0.7,-6.7,-1,-18,-1z"})])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"2.15em"}},[(0,t.Lk)("span")])])])])])]),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}}),(0,t.Lk)("span",{class:"mrel"},"="),(0,t.Lk)("span",{class:"mspace",style:{"margin-right":"0.2778em"}})]),(0,t.Lk)("span",{class:"base"},[(0,t.Lk)("span",{class:"strut",style:{height:"1.3397em","vertical-align":"-0.25em"}}),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord text"},[(0,t.Lk)("span",{class:"mord"},"diag")]),(0,t.Lk)("span",{class:"mopen"},"("),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal",style:{"margin-right":"0.01968em"}},"l"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.938em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])]),(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"mclose"},[(0,t.Lk)("span",{class:"mclose"},")"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.8641em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},"1")])])])])])])])]),(0,t.Lk)("span",{class:"mord"},[(0,t.Lk)("span",{class:"mord mathnormal"},"e"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"1.0897em"}},[(0,t.Lk)("span",{style:{top:"-3.113em","margin-right":"0.05em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.7em"}}),(0,t.Lk)("span",{class:"sizing reset-size6 size3 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05764em"}},"S"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t vlist-t2"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.3281em"}},[(0,t.Lk)("span",{style:{top:"-2.357em","margin-left":"-0.0576em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mrel mtight"},":"),(0,t.Lk)("span",{class:"mpunct mtight"},","),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j")])])])]),(0,t.Lk)("span",{class:"vlist-s"},"​")]),(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.2819em"}},[(0,t.Lk)("span")])])])])]),(0,t.Lk)("span",{class:"mbin mtight"},"−"),(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mord mathnormal mtight"},"m"),(0,t.Lk)("span",{class:"msupsub"},[(0,t.Lk)("span",{class:"vlist-t"},[(0,t.Lk)("span",{class:"vlist-r"},[(0,t.Lk)("span",{class:"vlist",style:{height:"0.9667em"}},[(0,t.Lk)("span",{style:{top:"-2.9667em","margin-right":"0.0714em"}},[(0,t.Lk)("span",{class:"pstrut",style:{height:"2.5357em"}}),(0,t.Lk)("span",{class:"sizing reset-size3 size1 mtight"},[(0,t.Lk)("span",{class:"mord mtight"},[(0,t.Lk)("span",{class:"mopen mtight"},"("),(0,t.Lk)("span",{class:"mord mathnormal mtight",style:{"margin-right":"0.05724em"}},"j"),(0,t.Lk)("span",{class:"mclose mtight"},")")])])])])])])])])])])])])])])])])])])])])]),(0,t.Lk)("p",null,"代入即可得到第三行。")])],-1)),a[12]||(a[12]=(0,t.Fv)('<ol start="4"><li><p><strong>第四行</strong> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mtext>diag</mtext><mo stretchy="false">(</mo><msup><mi>l</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><msup><mo stretchy="false">)</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">(\\text{diag}(l^{(j)}))^{-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord text"><span class="mord">diag</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>diag</mtext><mo stretchy="false">(</mo><msup><mi>l</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\\text{diag}(l^{(j)})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">diag</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 抵消，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><msup><mi>m</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup></msup></mrow><annotation encoding="application/x-tex">e^{m^{(j)}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0397em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0397em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9667em;"><span style="top:-2.9667em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><mo>−</mo><msup><mi>m</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\\exp(-m^{(j)})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord">−</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 抵消，就得到第四行。</p></li><li><p><strong>第五行</strong> 把 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><mo>−</mo><msup><mi>m</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup></mrow></msup></mrow><annotation encoding="application/x-tex">e^{-m^{(j+1)}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0397em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0397em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9667em;"><span style="top:-2.9667em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 合并到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><mo>…</mo><mtext> </mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\\exp(\\dots)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mclose">)</span></span></span></span> 里面就得到第五行。</p></li><li><p><strong>第六行</strong> 把 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>×</mo><mi>B</mi><mo>+</mo><mi>C</mi><mo>×</mo><mi>D</mi></mrow><annotation encoding="application/x-tex">A \\times B + C \\times D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span> 写成 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>A</mi><mo separator="true">,</mo><mi>C</mi><mo stretchy="false">]</mo><mo>×</mo><mo stretchy="false">[</mo><mi>B</mi><mo separator="true">,</mo><mi>D</mi><msup><mo stretchy="false">]</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">[A, C] \\times [B, D]^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span> 的矩阵乘法（向量内积）。</p></li><li><p><strong>第七行</strong> 就是 softmax 的定义。注意：我们需要把 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msub><mi mathvariant="bold">S</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo separator="true">,</mo><msub><mi mathvariant="bold">S</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi><mo>:</mo><mi>j</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[\\mathbf{S}_{:,j}, \\mathbf{S}_{:,j:j+1}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathbf">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathbf">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span> 合并成 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msub><mi mathvariant="bold">S</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[\\mathbf{S}_{:,j+1}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathbf">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msub><mi mathvariant="bold">V</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo separator="true">,</mo><msub><mi mathvariant="bold">V</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi><mo>:</mo><mi>j</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[\\mathbf{V}_{:,j}, \\mathbf{V}_{:,j:j+1}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.016em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.016em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">:</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span> 合并成 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msub><mi mathvariant="bold">V</mi><mrow><mo>:</mo><mo separator="true">,</mo><mi>j</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[\\mathbf{V}_{:,j+1}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.016em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span>。</p></li></ol><p>所以对于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">j+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>，我们证明的 3 个公式都是成立的，因此用数学归纳法可以证明对于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>0</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>T</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">j = 0, \\dots, T_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 都是成立的。</p><p>当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><msub><mi>T</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">j = T_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 时，根据第七行和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">S</mi></mrow><annotation encoding="application/x-tex">\\mathbf{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6861em;"></span><span class="mord mathbf">S</span></span></span></span> 的定义，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">O</mi><mrow><mo stretchy="false">(</mo><msub><mi>T</mi><mi>c</mi></msub><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mtext>softmax</mtext><mo stretchy="false">(</mo><msub><mi mathvariant="bold">S</mi><mrow><mo>:</mo><mo separator="true">,</mo><msub><mi>T</mi><mi>c</mi></msub></mrow></msub><msub><mi mathvariant="bold">V</mi><mrow><mo>:</mo><mo separator="true">,</mo><msub><mi>T</mi><mi>c</mi></msub></mrow></msub><mo stretchy="false">)</mo><mo>=</mo><mtext>softmax</mtext><mo stretchy="false">(</mo><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup><mo stretchy="false">)</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">\\mathbf{O}^{(T_c)} = \\text{softmax}(\\mathbf{S}_{:,T_c} \\mathbf{V}_{:,T_c}) = \\text{softmax}(QK^T)V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathbf">O</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.016em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">:</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span>。</p><h4 id="_1-4-3-如何证明计算flops为" tabindex="-1"><a class="header-anchor" href="#_1-4-3-如何证明计算flops为"><span>1.4.3 如何证明计算FLOPS为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2d)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span>?</span></a></h4><p>算法最主要的 FLOPs 用于矩阵乘法。在内层循环（算法第 9 行），我们需要计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>i</mi></msub><msubsup><mi>K</mi><mi>j</mi><mi>T</mi></msubsup><mo>∈</mo><msup><mi>R</mi><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><msub><mi>B</mi><mi>c</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">Q_i K_j^T \\in R^{B_r \\times B_c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.3948em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0502em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0502em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>i</mi></msub><mo>∈</mo><msup><mi>R</mi><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">Q_i \\in R^{B_r \\times d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0502em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>K</mi><mi>j</mi><mi>T</mi></msubsup><mo>∈</mo><msup><mi>R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>B</mi><mi>c</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">K_j^T \\in R^{d \\times B_c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.3948em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0502em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>，这需要 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msub><mi>B</mi><mi>r</mi></msub><msub><mi>B</mi><mi>c</mi></msub><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(B_r B_c d)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span> 的 FLOPs。内外循环相乘是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>c</mi></msub><msub><mi>T</mi><mi>r</mi></msub><mo>=</mo><mrow><mo fence="true">⌈</mo><mfrac><mi>N</mi><msub><mi>B</mi><mi>c</mi></msub></mfrac><mo fence="true">⌉</mo></mrow><mrow><mo fence="true">⌈</mo><mfrac><mi>N</mi><msub><mi>B</mi><mi>r</mi></msub></mfrac><mo fence="true">⌉</mo></mrow></mrow><annotation encoding="application/x-tex">T_c T_r = \\left\\lceil \\frac{N}{B_c} \\right\\rceil \\left\\lceil \\frac{N}{B_r} \\right\\rceil</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">⌈</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0502em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">⌉</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">⌈</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0502em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">⌉</span></span></span></span></span></span> 次，因此总的 TLOPs 为：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>O</mi><mrow><mo fence="true">(</mo><mfrac><msup><mi>N</mi><mn>2</mn></msup><mrow><msub><mi>B</mi><mi>c</mi></msub><msub><mi>B</mi><mi>r</mi></msub></mrow></mfrac><msub><mi>B</mi><mi>r</mi></msub><msub><mi>B</mi><mi>c</mi></msub><mi>d</mi><mo fence="true">)</mo></mrow><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O\\left(\\frac{N^2}{B_c B_r} B_r B_c d\\right) = O(N^2 d) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4411em;vertical-align:-0.95em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4911em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">d</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span></span></p><p>关于额外的空间，我们需要O(N)的空间来存储累计量(l,m)。</p><h4 id="_1-4-4-如何证明算法只需要的hbm访问" tabindex="-1"><a class="header-anchor" href="#_1-4-4-如何证明算法只需要的hbm访问"><span>1.4.4 如何证明算法只需要<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Θ</mi><mo stretchy="false">(</mo><msup><mi>𝑁</mi><mn>2</mn></msup><msup><mi>𝑑</mi><mn>2</mn></msup><msup><mi>𝑀</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Θ(𝑁^2 𝑑^2 𝑀^{−1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord">Θ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>的HBM访问？</span></a></h4><p>证明：我们首先分析标准 Attention 实现的 IO 情况。输入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo>∈</mo><msup><mi>R</mi><mrow><mi>N</mi><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">Q, K, V \\in R^{N \\times d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span> 在 HBM 中，最终的输出 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo>∈</mo><msup><mi>R</mi><mrow><mi>N</mi><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">O \\in R^{N \\times d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span> 也要写回到 HBM。</p><p>第一步是计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">QK^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span>，这是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>N</mi><mo>×</mo><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(N \\times d)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span> 矩阵乘以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>×</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">d \\times N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> 矩阵，输入 Q 和 K 需要读入，结果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>∈</mo><msup><mi>R</mi><mrow><mi>N</mi><mo>×</mo><mi>N</mi></mrow></msup></mrow><annotation encoding="application/x-tex">S \\in R^{N \\times N}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span></span></span></span></span></span></span></span> 需要写回 HBM，因此 HBM 访问量是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>d</mi><mo>+</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(Nd + N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。</p><p>第二步是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo>=</mo><mtext>softmax</mtext><mo stretchy="false">(</mo><mi>S</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P = \\text{softmax}(S)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mclose">)</span></span></span></span>，输入和输出都是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>N</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">N^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>，因此访问 HBM 为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。</p><p>最后一般是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo>=</mo><mi>P</mi><mi>V</mi></mrow><annotation encoding="application/x-tex">O = PV</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span>，P 和 V 需要读入 SRAM，结果写回 HBM，所以访问 HBM 为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>d</mi><mo>+</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(Nd + N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。</p><p>综上，<strong>标准 Attention 算法需要 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>d</mi><mo>+</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(Nd + N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 的 HBM 读写量</strong>。</p><hr><p>接下来我们来看 FlashAttention 算法。</p><p>外层循环只遍历一次，因此 K 和 V 只从 HBM 加载到 SRAM 一次，Q 和 O 需要遍历 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">T_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 次，每次都完整的把它们加载一遍。因此 HBM 的访问量是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>d</mi><mo>+</mo><mi>N</mi><mi>d</mi><msub><mi>T</mi><mi>c</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>d</mi><msub><mi>T</mi><mi>c</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(Nd + NdT_c) = O(NdT_c)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。</p><p>下面来看 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">B_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">B_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的约束条件。我们需要大小为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>c</mi></msub><mo>×</mo><mi>d</mi></mrow><annotation encoding="application/x-tex">B_c \\times d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> 块 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mi>j</mi></msub><mo separator="true">,</mo><msub><mi>V</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">K_j, V_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> 能够放到 SRAM 里，因此：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>B</mi><mi>c</mi></msub><mo>×</mo><mi>d</mi><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><mi>M</mi><mo stretchy="false">)</mo><mo>⇔</mo><msub><mi>B</mi><mi>c</mi></msub><mo>=</mo><mi>O</mi><mrow><mo fence="true">(</mo><mfrac><mi>M</mi><mi>d</mi></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">B_c \\times d = O(M) \\Leftrightarrow B_c = O\\left(\\frac{M}{d}\\right) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⇔</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></p><p>类似的，大小为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><mi>d</mi></mrow><annotation encoding="application/x-tex">B_r \\times d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> 的块 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Q_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">O_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 也需要能放进去，因此：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><mi>d</mi><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><mi>M</mi><mo stretchy="false">)</mo><mo>⇔</mo><msub><mi>B</mi><mi>r</mi></msub><mo>=</mo><mi>O</mi><mrow><mo fence="true">(</mo><mfrac><mi>M</mi><mi>d</mi></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">B_r \\times d = O(M) \\Leftrightarrow B_r = O\\left(\\frac{M}{d}\\right) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⇔</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></p><p>最后，我们需要 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>∈</mo><msup><mi>R</mi><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><msub><mi>B</mi><mi>c</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">S_{ij} \\in R^{B_r \\times B_c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0502em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0502em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 也能放进去，因此：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>B</mi><mi>r</mi></msub><msub><mi>B</mi><mi>c</mi></msub><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><mi>M</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">B_r B_c = O(M) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span></span></span></span></span></p><p>因此，我们这样设置：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>B</mi><mi>c</mi></msub><mo>=</mo><mi>O</mi><mrow><mo fence="true">(</mo><mfrac><mi>M</mi><mi>d</mi></mfrac><mo fence="true">)</mo></mrow><mo separator="true">,</mo><mspace width="1em"></mspace><msub><mi>B</mi><mi>r</mi></msub><mo>=</mo><mi>O</mi><mrow><mo fence="true">(</mo><mi>min</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><mi>M</mi><mi>d</mi></mfrac><mo separator="true">,</mo><mfrac><mi>M</mi><msub><mi>B</mi><mi>c</mi></msub></mfrac><mo fence="true">)</mo></mrow><mo fence="true">)</mo></mrow><mo>=</mo><mi>O</mi><mrow><mo fence="true">(</mo><mi>min</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><mfrac><mi>M</mi><mi>d</mi></mfrac><mo separator="true">,</mo><mi>d</mi><mo fence="true">)</mo></mrow><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">B_c = O\\left(\\frac{M}{d}\\right), \\quad B_r = O\\left(\\min\\left(\\frac{M}{d}, \\frac{M}{B_c}\\right)\\right) = O\\left(\\min\\left(\\frac{M}{d}, d\\right)\\right) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mop">min</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mop">min</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">d</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></p><p>因此有：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mi>c</mi></msub><mo>=</mo><mfrac><mi>N</mi><msub><mi>B</mi><mi>c</mi></msub></mfrac><mo>=</mo><mi>O</mi><mrow><mo fence="true">(</mo><mfrac><mrow><mi>N</mi><mi>d</mi></mrow><mi>M</mi></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">T_c = \\frac{N}{B_c} = O\\left(\\frac{Nd}{M}\\right) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1963em;vertical-align:-0.836em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></p><p>所以有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>d</mi><msub><mi>T</mi><mi>c</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><msup><mi>d</mi><mn>2</mn></msup><msup><mi>M</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(NdT_c) = O(N^2d^2M^{-1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">d</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，证毕。</p><h2 id="二、flashattention-v2" tabindex="-1"><a class="header-anchor" href="#二、flashattention-v2"><span>二、Flashattention-V2</span></a></h2><h2 id="三、flashattention-v3" tabindex="-1"><a class="header-anchor" href="#三、flashattention-v3"><span>三、Flashattention-V3</span></a></h2><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><h2 id="待更新" tabindex="-1"><a class="header-anchor" href="#待更新"><span>待更新</span></a></h2><h2 id="参考文献" tabindex="-1"><a class="header-anchor" href="#参考文献"><span>参考文献</span></a></h2><ol><li><a href="https://proceedings.neurips.cc/paper_files/paper/2022/file/67d57c32e20fd0a7a302cb81d36e40d5-Paper-Conference.pdf" target="_blank" rel="noopener noreferrer">Dao, T., et al. (2022). FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness.</a></li><li><a href="https://arxiv.org/pdf/2307.08691" target="_blank" rel="noopener noreferrer">Dao, T., et al. (2023). FlashAttention-2: Faster Attention with Better Parallelism and Work Partitioning. </a></li><li><a href="https://fancyerii.github.io/2023/10/23/flashattention/" target="_blank" rel="noopener noreferrer">Flash Attention V1论文解读-李理</a></li><li><a href="https://www.armcvai.cn/2024-10-02/flashattention1-paper.html" target="_blank" rel="noopener noreferrer">Flash Attention V1论文解读-Zhang</a></li><li><a href="https://www.armcvai.cn/2024-10-05/flashattention2-paper.html" target="_blank" rel="noopener noreferrer">Flash Attention V2论文解读-Zhang</a></li><li><a href="https://www.armcvai.cn/2024-10-06/flashattention3-paper.html" target="_blank" rel="noopener noreferrer">Flash Attention V3论文解读-Zhang</a></li><li><a href="https://www.armcvai.cn/2024-10-07/flashattention1-2-3-summary.html" target="_blank" rel="noopener noreferrer">flashattention1-2-3 系列总结-Zhang</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=Mzg2ODk4MzE2MQ==&amp;mid=2247483875&amp;idx=1&amp;sn=a23ef737b03e5bdec1892a8818de0704&amp;chksm=cea549f5f9d2c0e3832f10031de98dd4a243fd2411ffdacb434cc64a473452a148fc149ded47&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">Flash Attention1-真正意义上的scale dot product attention的算子融合-AI不止算法</a></li><li><a href="https://www.bilibili.com/video/BV1gzBqY4Evw?spm_id_from=333.788.videopod.sections&amp;vd_source=f058beebb64c488b55915da416ee6086" target="_blank" rel="noopener noreferrer">FlashAttentionV1V2算法解释-AI不止算法Bilibili</a></li></ol>',33))])}]]),V=JSON.parse('{"path":"/zh/posts/flashattention.html","title":"Flashattention","lang":"zh-CN","frontmatter":{"title":"Flashattention","date":"2025-05-21T00:00:00.000Z","readingTime":600,"category":["机器学习","深度学习","笔记"],"tag":["注意力机制","GPU优化","大模型","算法优化"],"isOriginal":true,"description":"简介 Flashattention是一种高效的注意力机制计算方法，由斯坦福大学研究团队在2022年提出。它通过优化GPU内存访问模式，显著提高了Transformer模型中注意力计算的速度并降低了内存使用。作为大模型训练和推理的关键优化技术，Flashattention已被广泛应用于各种大型语言模型中。","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Flashattention\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-05-21T00:00:00.000Z\\",\\"dateModified\\":\\"2025-05-21T08:11:14.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"GYQ\\",\\"url\\":\\"https://github.com/Summer536\\"}]}"],["meta",{"property":"og:url","content":"https://your-domain.com/Notes/zh/posts/flashattention.html"}],["meta",{"property":"og:site_name","content":"GYQ的博客"}],["meta",{"property":"og:title","content":"Flashattention"}],["meta",{"property":"og:description","content":"简介 Flashattention是一种高效的注意力机制计算方法，由斯坦福大学研究团队在2022年提出。它通过优化GPU内存访问模式，显著提高了Transformer模型中注意力计算的速度并降低了内存使用。作为大模型训练和推理的关键优化技术，Flashattention已被广泛应用于各种大型语言模型中。"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-05-21T08:11:14.000Z"}],["meta",{"property":"article:tag","content":"算法优化"}],["meta",{"property":"article:tag","content":"大模型"}],["meta",{"property":"article:tag","content":"GPU优化"}],["meta",{"property":"article:tag","content":"注意力机制"}],["meta",{"property":"article:published_time","content":"2025-05-21T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-05-21T08:11:14.000Z"}]]},"git":{"createdTime":1747123438000,"updatedTime":1747815074000,"contributors":[{"name":"yqgao","username":"yqgao","email":"gaoyuqing536@gmail.com","commits":18,"url":"https://github.com/yqgao"}]},"readingTime":{"minutes":16.76,"words":5029},"filePathRelative":"zh/posts/flashattention.md","excerpt":"\\n<h2>简介</h2>\\n<p>Flashattention是一种高效的注意力机制计算方法，由斯坦福大学研究团队在2022年提出。它通过优化GPU内存访问模式，显著提高了Transformer模型中注意力计算的速度并降低了内存使用。作为大模型训练和推理的关键优化技术，Flashattention已被广泛应用于各种大型语言模型中。</p>\\n","autoDesc":true}')}}]);